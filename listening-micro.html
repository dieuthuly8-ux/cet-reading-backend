<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è·¨è¯•å·å¾®ç»ƒä¹  - å››å…­çº§å­¦ä¹ ç«™</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- AIè¯­éŸ³è¯†åˆ« - ä½¿ç”¨ç¡…åŸºæµåŠ¨(SiliconFlow)äº‘ç«¯API (å›½å†…å¯è®¿é—®) -->
  <style>
    /* è‹¹æœé£æ ¼é…è‰² */
    :root {
      --color-bg: #f5f5f7;           /* æµ…ç°èƒŒæ™¯ */
      --color-bg-light: #ffffff;     /* ç™½è‰² */
      --color-primary: #0071e3;       /* è‹¹æœè“ */
      --color-primary-hover: #0077ED; /* è‹¹æœè“æ‚¬åœ */
      --color-secondary: #06c;        /* æ¬¡è¦è“ */
      --color-card: #ffffff;          /* ç™½è‰²å¡ç‰‡ */
      --color-text-dark: #1d1d1f;     /* è‹¹æœé»‘ */
      --color-text-light: #6e6e73;    /* è‹¹æœç° */
    }
    
    body {
      background: var(--color-bg) !important;
    }
    
    .page-content {
      background: var(--color-bg);
    }
    
    .question {
      background: var(--color-card);
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      transition: all 0.3s cubic-bezier(0.28, 0.11, 0.32, 1);
      border: 1px solid rgba(0,0,0,0.08);
    }
    .question:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
      border-color: rgba(0,0,0,0.12);
    }
    .listening-list {
      padding: 20px 0;
    }
    .action-btn, .btn {
      transition: all 0.3s ease;
      border-radius: 980px;
      border: none;
      font-weight: 600;
      letter-spacing: -0.01em;
    }
    .action-btn:hover, .btn:hover {
      transform: scale(1.02);
      box-shadow: none;
    }
    .action-btn:active, .btn:active {
      transform: scale(0.98);
    }
    audio {
      border-radius: 12px;
      background: #f5f5f7;
    }
    audio::-webkit-media-controls-panel {
      background: #ffffff;
      border-radius: 12px;
    }
    select {
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 8px;
      padding: 8px 12px;
      transition: all 0.2s;
      background: #ffffff;
      color: var(--color-text-dark);
    }
    select:focus {
      border-color: var(--color-primary);
      outline: none;
      box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1);
    }
    label {
      color: var(--color-text-dark);
      font-weight: 500;
    }
    .hint {
      color: var(--color-text-dark) !important;
    }
    
    /* åŠ¨ç”»æ•ˆæœ */
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
        max-height: 0;
      }
      to {
        opacity: 1;
        transform: translateY(0);
        max-height: 200px;
      }
    }
    
    @keyframes pulseGlow {
      0%, 100% {
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.5);
      }
      50% {
        box-shadow: 0 6px 24px rgba(102, 126, 234, 0.8), 0 0 20px rgba(102, 126, 234, 0.4);
      }
    }
    
    @keyframes pulseGlowGreen {
      0%, 100% {
        box-shadow: 0 4px 16px rgba(52, 199, 89, 0.5);
      }
      50% {
        box-shadow: 0 6px 24px rgba(52, 199, 89, 0.8), 0 0 20px rgba(52, 199, 89, 0.4);
      }
    }
    
    @keyframes blink {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.3;
        transform: scale(0.8);
      }
    }
  </style>
</head>
<body>
  <!-- é¡µé¢æ»šåŠ¨è¿›åº¦æ¡ -->
  <div class="scroll-progress" id="scroll-progress"></div>
  
  <!-- ç®€æ´å¯¼èˆªæ  -->
  <nav class="apple-nav wehuster-nav">
    <div class="nav-container">
      <a class="nav-logo wehuster-logo" href="index.html">
        <i class="fas fa-graduation-cap"></i>
        <span class="logo-text">å››å…­çº§å­¦ä¹ ç«™</span>
      </a>
      
      <ul class="nav-menu wehuster-menu">
        <li class="nav-item"><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
        <li class="nav-item"><a href="cet4.html" class="nav-link">å››çº§çœŸé¢˜</a></li>
        <li class="nav-item"><a href="cet6.html" class="nav-link">å…­çº§çœŸé¢˜</a></li>
        <li class="nav-item"><a href="translator.html" class="nav-link">é˜…è¯»ç¥å™¨</a></li>
        <li class="nav-item"><a href="listening-micro.html" class="nav-link listening-highlight active">ğŸ§ å¬åŠ›ç»ƒä¹ <span class="listening-hot-badge">HOT</span></a></li>
        <li class="nav-item"><a href="news.html" class="nav-link">èµ„è®¯</a></li>
        <li class="nav-item"><a href="about.html" class="nav-link">About Us</a></li>
      </ul>
      
      <div class="nav-tools">
        <button class="search-btn" id="search-toggle" aria-label="æœç´¢">
          <i class="fas fa-search"></i>
        </button>
        <button class="mobile-toggle" id="mobile-toggle" aria-label="èœå•">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </div>
  </nav>
  
  <div class="page-content">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div style="text-align: center; margin-bottom: 3rem; animation: fadeInDown 0.6s ease-out;">
      <div style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.25rem 2.5rem; border-radius: 24px; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4), 0 2px 8px rgba(0, 0, 0, 0.1); margin-bottom: 1.25rem; position: relative; overflow: hidden; transition: all 0.4s ease;">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%); pointer-events: none;"></div>
        <h1 style="color: white; margin: 0; font-weight: 800; font-size: 2.2rem; letter-spacing: -0.02em; position: relative; z-index: 1; text-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">è·¨è¯•å·å¬åŠ›å¾®ç»ƒä¹ </h1>
      </div>
      <p style="color: #6c757d; font-size: 1.1rem; margin: 0; font-weight: 500; letter-spacing: 0.5px;"><span style="color: #667eea; font-weight: 600;">æ™ºèƒ½æŠ½é¢˜</span> Â· <span style="color: #764ba2; font-weight: 600;">ç²¾å‡†ç»ƒä¹ </span> Â· <span style="color: #667eea; font-weight: 600;">å¿«é€Ÿæå‡</span></p>
    </div>

    <!-- ä½¿ç”¨è¯´æ˜ -->
    <div style="background: linear-gradient(135deg, #fff5f5 0%, #ffe6f0 100%); border-left: 5px solid #f59e0b; border-radius: 16px; padding: 24px 28px; margin-bottom: 2rem; box-shadow: 0 8px 24px rgba(245, 158, 11, 0.15); animation: fadeInUp 0.6s ease-out;">
      <div style="display: flex; align-items: start; gap: 16px;">
        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 6px 20px rgba(245, 158, 11, 0.35);">
          <i class="fas fa-lightbulb" style="color: white; font-size: 1.6rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));"></i>
        </div>
        <div style="flex: 1;">
          <h3 style="margin: 0 0 16px 0; color: #b45309; font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; gap: 8px;">
            <span>ğŸ“– ä½¿ç”¨è¯´æ˜</span>
            <span style="background: #f59e0b; color: white; font-size: 0.75rem; padding: 3px 10px; border-radius: 12px; font-weight: 600;">å¿…è¯»</span>
          </h3>
          
          <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 12px; border: 1px solid rgba(245, 158, 11, 0.2);">
            <h4 style="margin: 0 0 12px 0; color: #92400e; font-size: 1.05rem; font-weight: 700; display: flex; align-items: center; gap: 8px;">
              <span style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85rem; font-weight: 800; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">1</span>
              å¿«é€Ÿå¼€å§‹ - ä¸‰ç§ç»ƒä¹ æ–¹å¼
            </h4>
            <div style="margin-left: 36px; color: #78350f; line-height: 1.8; font-size: 0.95rem;">
              <div style="margin-bottom: 8px;">
                <strong style="color: #92400e;">ğŸ¯ æ–¹å¼ä¸€ï¼šçœŸé¢˜ä¸“é¡¹ç»ƒä¹ ï¼ˆæ¨èï¼‰</strong><br>
                <span style="margin-left: 1.5rem;">è®¿é—® <a href="index.html" style="color: #667eea; font-weight: 600; text-decoration: none;">é¦–é¡µ</a> â†’ é€‰æ‹©ä»»æ„è¯•å· â†’ ç‚¹å‡»"å¬åŠ›æµ‹è¯•" â†’ ç›´æ¥æ’­æ”¾éŸ³é¢‘æˆ–AIç”Ÿæˆé¢˜ç›®</span>
              </div>
              <div style="margin-bottom: 8px;">
                <strong style="color: #92400e;">ğŸ² æ–¹å¼äºŒï¼šéšæœºæŠ½é¢˜ç»ƒä¹ </strong><br>
                <span style="margin-left: 1.5rem;">å…ˆå» <a href="reading-micro.html" style="color: #667eea; font-weight: 600; text-decoration: none;">é˜…è¯»å¾®ç»ƒä¹ </a> å®Œæˆ3-5é“é¢˜ â†’ å»ºç«‹ç”¨æˆ·ç”»åƒ â†’ è¿”å›æœ¬é¡µé¢æ™ºèƒ½æŠ½é¢˜</span>
              </div>
              <div>
                <strong style="color: #92400e;">ğŸ“š æ–¹å¼ä¸‰ï¼šå››å…­çº§çœŸé¢˜åº“</strong><br>
                <span style="margin-left: 1.5rem;">è®¿é—® <a href="cet4.html" style="color: #667eea; font-weight: 600; text-decoration: none;">å››çº§çœŸé¢˜</a> æˆ– <a href="cet6.html" style="color: #667eea; font-weight: 600; text-decoration: none;">å…­çº§çœŸé¢˜</a> â†’ ç­›é€‰"å«å¬åŠ›"è¯•å· â†’ å¼€å§‹ç»ƒä¹ </span>
              </div>
            </div>
          </div>

          <div style="background: white; border-radius: 12px; padding: 20px; border: 1px solid rgba(245, 158, 11, 0.2);">
            <h4 style="margin: 0 0 12px 0; color: #92400e; font-size: 1.05rem; font-weight: 700; display: flex; align-items: center; gap: 8px;">
              <span style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.85rem; font-weight: 800; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">2</span>
              ä¸ºä»€ä¹ˆæ— æ³•ç›´æ¥ç»ƒä¹ ï¼Ÿ
            </h4>
            <div style="margin-left: 36px; color: #78350f; line-height: 1.8; font-size: 0.95rem;">
              <p style="margin: 0;">
                æœ¬é¡µé¢é‡‡ç”¨<strong style="color: #92400e;">æ™ºèƒ½æ¨èç®—æ³•</strong>ï¼Œéœ€è¦åŸºäºæ‚¨çš„<strong style="color: #92400e;">åšé¢˜æ•°æ®å’Œç”¨æˆ·ç”»åƒ</strong>æ¥ç²¾å‡†æ¨èé¢˜ç›®ã€‚
                å¦‚æœæ‚¨æ˜¯<strong style="color: #92400e;">é¦–æ¬¡ä½¿ç”¨</strong>ï¼Œè¯·å…ˆï¼š
              </p>
              <ul style="margin: 8px 0 0; padding-left: 1.5rem;">
                <li>å®Œæˆ <strong>3-5é“é˜…è¯»é¢˜</strong> å»ºç«‹åˆå§‹ç”»åƒï¼Œæˆ–</li>
                <li>ç›´æ¥ä» <strong>é¦–é¡µé€‰æ‹©è¯•å·</strong> è¿›è¡ŒçœŸé¢˜ä¸“é¡¹ç»ƒä¹ </li>
              </ul>
            </div>
          </div>

          <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; padding: 12px 16px; margin-top: 12px; border: 1px solid #fbbf24;">
            <p style="margin: 0; color: #92400e; font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-info-circle" style="color: #f59e0b;"></i>
              <span>ğŸ’¡ å°è´´å£«ï¼šæ¨èä»é¦–é¡µé€‰æ‹©è¯•å·å¼€å§‹ï¼Œæ—¢èƒ½ç»ƒä¹ å¬åŠ›ï¼Œåˆèƒ½ç§¯ç´¯ç”¨æˆ·æ•°æ®ï¼</span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ - å¡ç‰‡å¼å¸ƒå±€ -->
    <div style="background: linear-gradient(to bottom, #ffffff 0%, #f8f9ff 100%); border-radius: 24px; padding: 2.5rem; margin-bottom: 2.5rem; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.15), 0 4px 12px rgba(0, 0, 0, 0.08); border: 1px solid rgba(102, 126, 234, 0.1); position: relative; overflow: hidden; animation: fadeInUp 0.6s ease-out 0.1s both;">
      <div style="position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(102, 126, 234, 0.03) 0%, transparent 70%); pointer-events: none;"></div>
      <div style="position: relative; z-index: 1;">
        
        <!-- è¯•å·é”å®šæç¤ºï¼ˆä»…åœ¨æœ‰examå‚æ•°æ—¶æ˜¾ç¤ºï¼‰ -->
        <div id="exam-filter-notice" style="display: none; background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); border-radius: 16px; padding: 20px 24px; margin-bottom: 24px; box-shadow: 0 4px 16px rgba(6, 182, 212, 0.25); position: relative; overflow: hidden; animation: slideDown 0.5s ease-out;">
          <div style="position: absolute; top: -50px; right: -50px; width: 150px; height: 150px; background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%); border-radius: 50%;"></div>
          <div style="position: relative; z-index: 1; display: flex; align-items: center; gap: 16px;">
            <div style="width: 48px; height: 48px; background: rgba(255,255,255,0.25); backdrop-filter: blur(10px); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <i class="fas fa-lock" style="color: white; font-size: 1.3rem;"></i>
            </div>
            <div style="flex: 1;">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                <h3 style="margin: 0; color: white; font-size: 1.2rem; font-weight: 700;">ğŸ¯ çœŸé¢˜ä¸“é¡¹ç»ƒä¹ </h3>
              </div>
              <p id="exam-filter-text" style="margin: 0; color: rgba(255,255,255,0.95); font-size: 0.95rem; font-weight: 500;"></p>
            </div>
            <button id="clear-exam-filter" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px);" onmouseover="this.style.background='rgba(255,255,255,0.3)';" onmouseout="this.style.background='rgba(255,255,255,0.2)';">
              <i class="fas fa-times" style="margin-right: 4px;"></i>è§£é™¤é”å®š
            </button>
          </div>
        </div>
      
      <!-- å¿«é€Ÿé…ç½®åŒº -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.75rem; margin-bottom: 2.5rem;">
        
        <!-- æŠ½é¢˜æ•°é‡å¡ç‰‡ -->
        <div style="background: white; border-radius: 20px; padding: 1.75rem; border: 2px solid rgba(79, 172, 254, 0.15); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 16px rgba(79, 172, 254, 0.1); position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(79, 172, 254, 0.2)'; this.style.borderColor='rgba(79, 172, 254, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(79, 172, 254, 0.1)'; this.style.borderColor='rgba(79, 172, 254, 0.15)';">
          <div style="position: absolute; top: -10px; right: -10px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(79, 172, 254, 0.08) 0%, transparent 70%); pointer-events: none;"></div>
          <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 1.25rem; position: relative; z-index: 1;">
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(79, 172, 254, 0.35); position: relative;">
              <div style="position: absolute; inset: 0; border-radius: 14px; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%);"></div>
              <i class="fas fa-hashtag" style="color: white; font-size: 1.5rem; position: relative; z-index: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));"></i>
            </div>
            <div>
              <h3 style="margin: 0; font-size: 1.15rem; color: #2d3436; font-weight: 700; letter-spacing: -0.01em;">æŠ½é¢˜æ•°é‡</h3>
              <p style="margin: 0; font-size: 0.9rem; color: #74798d; font-weight: 500;">é€‰æ‹©ç»ƒä¹ é¢˜ç›®æ•°</p>
            </div>
          </div>
          <select id="count-select" style="width: 100%; padding: 14px 18px; font-size: 1.05rem; border: 2px solid #e3e8f0; border-radius: 14px; background: #f8f9ff; color: #2d3436; font-weight: 600; cursor: pointer; transition: all 0.3s ease; position: relative; z-index: 1;" onmouseover="this.style.borderColor='#4facfe'; this.style.background='white';" onmouseout="this.style.borderColor='#e3e8f0'; this.style.background='#f8f9ff';">
            <option value="3">3 é“é¢˜ï¼ˆå¿«é€Ÿç»ƒä¹ ï¼‰</option>
            <option value="5" selected>5 é“é¢˜ï¼ˆæ¨èï¼‰â­</option>
            <option value="8">8 é“é¢˜ï¼ˆæ·±åº¦ç»ƒä¹ ï¼‰</option>
            <option value="10">10 é“é¢˜ï¼ˆå¼ºåŒ–è®­ç»ƒï¼‰</option>
          </select>
        </div>

        <!-- ä¼˜å…ˆæŠ€èƒ½å¡ç‰‡ -->
        <div style="background: white; border-radius: 20px; padding: 1.75rem; border: 2px solid rgba(250, 112, 154, 0.15); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 16px rgba(250, 112, 154, 0.1); position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(250, 112, 154, 0.2)'; this.style.borderColor='rgba(250, 112, 154, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(250, 112, 154, 0.1)'; this.style.borderColor='rgba(250, 112, 154, 0.15)';">
          <div style="position: absolute; top: -10px; right: -10px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(250, 112, 154, 0.08) 0%, transparent 70%); pointer-events: none;"></div>
          <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 1.25rem; position: relative; z-index: 1;">
            <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(250, 112, 154, 0.35); position: relative;">
              <div style="position: absolute; inset: 0; border-radius: 14px; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%);"></div>
              <i class="fas fa-bullseye" style="color: white; font-size: 1.5rem; position: relative; z-index: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));"></i>
            </div>
            <div>
              <h3 style="margin: 0; font-size: 1.15rem; color: #2d3436; font-weight: 700; letter-spacing: -0.01em;">ä¼˜å…ˆæŠ€èƒ½</h3>
              <p style="margin: 0; font-size: 0.9rem; color: #74798d; font-weight: 500;">æ ¹æ®ä½ çš„å¼±é¡¹æ™ºèƒ½æ¨è</p>
            </div>
          </div>
          <select id="skill-select" multiple size="4" style="width: 100%; padding: 10px 14px; font-size: 0.95rem; border: 2px solid #e3e8f0; border-radius: 14px; background: #f8f9ff; color: #2d3436; position: relative; z-index: 1; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#fa709a'; this.style.background='white';" onmouseout="this.style.borderColor='#e3e8f0'; this.style.background='#f8f9ff';"></select>
        </div>

        <!-- é«˜çº§é€‰é¡¹å¡ç‰‡ -->
        <div style="background: white; border-radius: 20px; padding: 1.75rem; border: 2px solid rgba(102, 126, 234, 0.15); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 16px rgba(102, 126, 234, 0.1); position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 32px rgba(102, 126, 234, 0.2)'; this.style.borderColor='rgba(102, 126, 234, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(102, 126, 234, 0.1)'; this.style.borderColor='rgba(102, 126, 234, 0.15)';">
          <div style="position: absolute; top: -10px; right: -10px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(102, 126, 234, 0.08) 0%, transparent 70%); pointer-events: none;"></div>
          <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 1.25rem; position: relative; z-index: 1;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 52px; height: 52px; border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.35); position: relative;">
              <div style="position: absolute; inset: 0; border-radius: 14px; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%);"></div>
              <i class="fas fa-sliders-h" style="color: white; font-size: 1.5rem; position: relative; z-index: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));"></i>
            </div>
            <div>
              <h3 style="margin: 0; font-size: 1.15rem; color: #2d3436; font-weight: 700; letter-spacing: -0.01em;">é«˜çº§é€‰é¡¹</h3>
              <p style="margin: 0; font-size: 0.9rem; color: #74798d; font-weight: 500;">ç²¾ç»†åŒ–æ§åˆ¶</p>
            </div>
          </div>
          <label style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: #f8f9ff; border-radius: 12px; cursor: pointer; border: 2px solid #e3e8f0; transition: all 0.3s ease; position: relative; z-index: 1; margin-bottom: 1rem;" onmouseover="this.style.borderColor='#667eea'; this.style.background='white';" onmouseout="this.style.borderColor='#e3e8f0'; this.style.background='#f8f9ff';">
            <input type="checkbox" id="only-tagged" checked style="width: 22px; height: 22px; cursor: pointer; accent-color: #667eea;" />
            <span style="font-weight: 600; color: #2d3436; font-size: 1.05rem;">ä»…æŠ½å–å¸¦æ ‡ç­¾é¢˜ç›®</span>
          </label>
          <label style="display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: #fff8e1; border-radius: 12px; cursor: pointer; border: 2px solid #ffd54f; transition: all 0.3s ease; position: relative; z-index: 1;" onmouseover="this.style.borderColor='#ffc107'; this.style.background='white';" onmouseout="this.style.borderColor='#ffd54f'; this.style.background='#fff8e1';">
            <input type="checkbox" id="reading-mode" checked style="width: 22px; height: 22px; cursor: pointer; accent-color: #ffc107;" />
            <div style="display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-book-reader" style="color: #f57c00; font-size: 1.2rem;"></i>
              <span style="font-weight: 600; color: #2d3436; font-size: 1.05rem;">å¬åŠ›é˜…è¯»è®­ç»ƒæ¨¡å¼</span>
              <span style="background: linear-gradient(135deg, #ffd54f 0%, #ffb300 100%); color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700;">æ¨è</span>
            </div>
          </label>
          <div id="reading-mode-hint" style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, rgba(255, 193, 7, 0.08) 0%, rgba(255, 152, 0, 0.08) 100%); border-left: 4px solid #ffc107; border-radius: 8px; position: relative; z-index: 1; transition: all 0.3s ease; overflow: hidden; max-height: 200px; opacity: 1;">
            <div style="display: flex; align-items: flex-start; gap: 8px;">
              <i class="fas fa-book-reader" style="color: #f57c00; font-size: 1.1rem; margin-top: 2px;"></i>
              <div>
                <strong style="color: #f57c00; font-size: 1rem; display: block; margin-bottom: 4px;">ğŸ’¡ å¬åŠ›é˜…è¯»è®­ç»ƒæ¨¡å¼ï¼ˆå·²å¯ç”¨ï¼‰</strong>
                <p style="margin: 0; font-size: 0.9rem; color: #666; line-height: 1.6;">
                  è¾¹å¬è¾¹è¯»ï¼ŒåŒæ­¥æ˜¾ç¤ºå¬åŠ›åŸæ–‡ï¼Œå¯éšæ—¶éšè—/æ˜¾ç¤ºï¼Œæé«˜å¬è¯»ç»“åˆèƒ½åŠ›ã€‚æ¯é“é¢˜éƒ½ä¼šæ˜¾ç¤ºå¯¹åº”çš„å¬åŠ›åŸæ–‡å†…å®¹ã€‚
                </p>
              </div>
            </div>
          </div>
          <p style="margin-top: 0.75rem; font-size: 0.9rem; color: #74798d; line-height: 1.6; position: relative; z-index: 1; font-weight: 500;">
            <i class="fas fa-info-circle" style="color: #667eea; margin-right: 4px;"></i> 
            å»ºè®®ä¿æŒå‹¾é€‰"ä»…æŠ½å–å¸¦æ ‡ç­¾é¢˜ç›®"ï¼Œä»¥è·å¾—æ›´ç²¾å‡†çš„ç»ƒä¹ æ•ˆæœ
          </p>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’®åŒº -->
      <div style="display: flex; gap: 1.25rem; justify-content: center; padding-top: 1.5rem; border-top: 2px solid rgba(102, 126, 234, 0.1);">
        <button class="action-btn" id="start-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 700; padding: 1.15rem 3rem; font-size: 1.15rem; border-radius: 14px; box-shadow: 0 6px 24px rgba(102, 126, 234, 0.4), 0 2px 8px rgba(0, 0, 0, 0.1); border: none; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px) scale(1.02)'; this.style.boxShadow='0 12px 32px rgba(102, 126, 234, 0.5), 0 4px 12px rgba(0, 0, 0, 0.15)';" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 6px 24px rgba(102, 126, 234, 0.4), 0 2px 8px rgba(0, 0, 0, 0.1)';">
          <div style="position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 100%); pointer-events: none;"></div>
          <i class="fas fa-bolt" style="margin-right: 6px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));"></i> å¼€å§‹ç”Ÿæˆç»ƒä¹ 
        </button>
        <button class="action-btn" id="reset-btn" style="background: white; color: #667eea; border: 2px solid #667eea; font-weight: 700; padding: 1.15rem 2.5rem; font-size: 1.15rem; border-radius: 14px; cursor: pointer; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);" onmouseover="this.style.background='#667eea'; this.style.color='white'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.3)';" onmouseout="this.style.background='white'; this.style.color='#667eea'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(102, 126, 234, 0.1)';">
          <i class="fas fa-rotate" style="margin-right: 6px;"></i> é‡ç½®é…ç½®
        </button>
      </div>
      </div>
    </div>

    <!-- ä½¿ç”¨è¯´æ˜åŒº -->
    <div style="background: linear-gradient(to bottom, #ffffff 0%, #f8f9ff 100%); border-radius: 20px; padding: 2.5rem; margin-bottom: 2.5rem; box-shadow: 0 6px 24px rgba(102, 126, 234, 0.12), 0 2px 8px rgba(0, 0, 0, 0.06); border: 1px solid rgba(102, 126, 234, 0.08); animation: fadeInUp 0.6s ease-out 0.2s both;">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 1.5rem;">
        <i class="fas fa-lightbulb" style="color: #ffd700; font-size: 1.8rem;"></i>
        <h3 style="margin: 0; font-size: 1.25rem; color: var(--color-text-dark); font-weight: 700;">ä½¿ç”¨è¯´æ˜</h3>
      </div>
      
      <div style="display: grid; gap: 1.25rem;">
        <div style="display: flex; align-items: start; gap: 14px; padding: 1.5rem; background: white; border-radius: 16px; border: 2px solid #e3e8f0; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);" onmouseover="this.style.borderColor='#667eea'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.12)'; this.style.transform='translateX(4px)';" onmouseout="this.style.borderColor='#e3e8f0'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.04)'; this.style.transform='translateX(0)';">
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
            <span style="color: white; font-weight: 800; font-size: 1.1rem;">1</span>
          </div>
          <div>
            <h4 style="margin: 0 0 0.6rem; font-size: 1.05rem; color: #2d3436; font-weight: 700; letter-spacing: -0.01em;">æ™ºèƒ½æŠ½é¢˜</h4>
            <p style="margin: 0; color: #74798d; line-height: 1.7; font-size: 0.95rem; font-weight: 500;">é»˜è®¤ä»ä½ çš„<strong style="color: #667eea;">å¼±é¡¹æŠ€èƒ½</strong>ä¸­æŠ½é¢˜ï¼Œå¸®ä½ é’ˆå¯¹æ€§æå‡</p>
          </div>
        </div>
        
        <div style="display: flex; align-items: start; gap: 14px; padding: 1.5rem; background: white; border-radius: 16px; border: 2px solid #e3e8f0; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);" onmouseover="this.style.borderColor='#fa709a'; this.style.boxShadow='0 6px 16px rgba(250, 112, 154, 0.12)'; this.style.transform='translateX(4px)';" onmouseout="this.style.borderColor='#e3e8f0'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.04)'; this.style.transform='translateX(0)';">
          <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 4px 12px rgba(250, 112, 154, 0.3);">
            <span style="color: white; font-weight: 800; font-size: 1.1rem;">2</span>
          </div>
          <div>
            <h4 style="margin: 0 0 0.6rem; font-size: 1.05rem; color: #2d3436; font-weight: 700; letter-spacing: -0.01em;">æ‰‹åŠ¨é€‰æ‹©æŠ€èƒ½</h4>
            <p style="margin: 0; color: #74798d; line-height: 1.7; font-size: 0.95rem; font-weight: 500;">å¯åœ¨<strong style="color: #fa709a;">ä¼˜å…ˆæŠ€èƒ½</strong>ä¸­å¤šé€‰ï¼Œè‡ªå®šä¹‰ç»ƒä¹ é‡ç‚¹</p>
          </div>
        </div>
        
        <div style="display: flex; align-items: start; gap: 14px; padding: 1.5rem; background: white; border-radius: 16px; border: 2px solid #e3e8f0; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);" onmouseover="this.style.borderColor='#4facfe'; this.style.boxShadow='0 6px 16px rgba(79, 172, 254, 0.12)'; this.style.transform='translateX(4px)';" onmouseout="this.style.borderColor='#e3e8f0'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.04)'; this.style.transform='translateX(0)';">
          <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);">
            <span style="color: white; font-weight: 800; font-size: 1.1rem;">3</span>
          </div>
          <div>
            <h4 style="margin: 0 0 0.6rem; font-size: 1.05rem; color: #2d3436; font-weight: 700; letter-spacing: -0.01em;">æ ‡ç­¾ç­›é€‰</h4>
            <p style="margin: 0; color: #74798d; line-height: 1.7; font-size: 0.95rem; font-weight: 500;">å»ºè®®ä¿æŒ<strong style="color: #4facfe;">ä»…æŠ½å–å¸¦æ ‡ç­¾é¢˜ç›®</strong>ï¼Œç»ƒä¹ æ•ˆæœæ›´ç²¾å‡†</p>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 1.5rem; display: flex; gap: 1rem; align-items: center; justify-content: space-between; padding-top: 1.5rem; border-top: 2px solid #f0f0f0;">
        <span id="preset-badge" class="badge" style="display:none; background: #667eea; color: white; padding: 0.5rem 1rem; border-radius: 8px; font-weight: 600;">âœ“ å·²ä»å‚æ•°åŠ è½½é…ç½®</span>
        <button id="share-btn" class="btn btn-secondary" type="button" style="background: white; color: #667eea; border: 2px solid #667eea; padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
          <i class="fas fa-share-alt"></i> å¤åˆ¶åˆ†äº«é“¾æ¥
        </button>
      </div>
    </div>

    <div id="quiz-wrap" class="listening-result" style="display:none;"></div>
    <div id="result-wrap" class="listening-result" style="display:none;"></div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const quizWrap = $('#quiz-wrap');
    const resWrap = $('#result-wrap');
    // ç®€æ˜“ Toast
    (function ensureToast(){ if (!document.querySelector('.toast-container')){ const c=document.createElement('div'); c.className='toast-container'; document.body.appendChild(c);} })();
    function toast(msg, type='ok'){ const c=document.querySelector('.toast-container'); const t=document.createElement('div'); t.className=`toast ${type}`; t.textContent=msg; c.appendChild(t); setTimeout(()=>{ t.remove(); }, 2200); }

    // è¯»å–ç”»åƒå¹¶å¡«å……æŠ€èƒ½åˆ—è¡¨ï¼ˆæŒ‰é”™è¯¯ç‡é™åºï¼‰
    function loadProfileSkills(){
      let prof={}; try{ prof=JSON.parse(localStorage.getItem('listening:profile')||'{}') }catch(_){ }
      const entries = Object.entries(prof.skill||{}).map(([k,v])=>{
        const tot=(v.right||0)+(v.wrong||0); const err=tot? v.wrong/tot : 0; return {name:k,tot,err}
      }).sort((a,b)=> (b.err-a.err) || (b.tot-a.tot));
      const sel = $('#skill-select'); sel.innerHTML='';
      // é¢„é€‰å–å‰2ä¸ªå¼±é¡¹
      entries.forEach((e,idx)=>{ const o=document.createElement('option'); o.value=e.name; o.textContent=`${e.name}ï¼ˆé”™ç‡${Math.round(e.err*100)}%ï¼‰`; if(idx<2) o.selected=true; sel.appendChild(o); });
      if(entries.length===0){ ['synonym','number','keyword','logic'].forEach((k,i)=>{ const o=document.createElement('option'); o.value=k; o.textContent=k; if(i<2) o.selected=true; sel.appendChild(o); }); }
    }

    async function fetchAllQuestions(){
      const resp = await fetch('./listening.json', { cache:'no-store' });
      if(!resp.ok) throw new Error('listening.json åŠ è½½å¤±è´¥');
      const data = await resp.json();
      const pool=[];
      Object.entries(data).forEach(([examId,payload])=>{
        (payload.sections||[]).forEach(sec=>{
          const secAudio = sec.audio || '';
          const secStart = sec.audioStart;
          const secEnd = sec.audioEnd;
          const secTranscript = sec.transcript || '';
          (sec.questions||[]).forEach(q=>{
            pool.push({ 
              examId, 
              section: sec.name||'', 
              sectionAudio: secAudio,
              sectionStart: secStart,
              sectionEnd: secEnd,
              sectionTranscript: secTranscript,
              q 
            });
          });
        });
      });
      return pool;
    }

    function hasAnyTag(q){
      const t=q?.tags||{}; const a=x=>Array.isArray(x)&&x.length>0;
      return a(t.topic)||a(t.type)||a(t.skill)||a(t.distractor)||!!t.difficulty;
    }
    function pickBySkills(pool, skills, n, onlyTagged, examFilter){
      // å¦‚æœæŒ‡å®šäº†è¯•å·ç­›é€‰ï¼Œç›´æ¥è¿”å›è¯¥è¯•å·çš„æ‰€æœ‰é¢˜ç›®ï¼ˆä¸æ‰“ä¹±ï¼ŒæŒ‰åŸé¡ºåºï¼‰
      if (examFilter) {
        const examQuestions = pool.filter(item => item.examId === examFilter);
        // æŒ‰é¢˜ç›®IDæ’åºï¼Œä¿æŒåŸå§‹é¡ºåº
        examQuestions.sort((a, b) => (a.q?.id || 0) - (b.q?.id || 0));
        return examQuestions;
      }
      
      // å¸¸è§„æŠ½é¢˜é€»è¾‘
      const cand = pool.filter(item=>{
        const ks = Array.isArray(item.q?.tags?.skill) ? item.q.tags.skill : [];
        const skillMatch = skills.length===0 ? true : skills.some(s=>ks.includes(s));
        const tagMatch = onlyTagged ? hasAnyTag(item.q) : true;
        return skillMatch && tagMatch;
      });
      // æ‰“ä¹±
      for(let i=cand.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [cand[i],cand[j]]=[cand[j],cand[i]] }
      return cand.slice(0, n);
    }

    function formatTime(sec){ const m=Math.floor(sec/60); const s=Math.floor(sec%60); return `${m}:${s.toString().padStart(2,'0')}`; }
    
    // AIç”Ÿæˆé¢˜ç›®çš„æ¸²æŸ“å’Œç­”é¢˜åŠŸèƒ½
    function renderAIGeneratedQuiz(questions, examId, examData) {
      quizWrap.innerHTML = '';
      quizWrap.style.display = 'block';
      resWrap.style.display = 'none';
      
      // é¡¶éƒ¨æ¨ªå¹…
      const banner = document.createElement('div');
      banner.style.cssText = `
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 20px 28px;
        margin-bottom: 24px;
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        color: white;
      `;
      banner.innerHTML = `
        <div style="display: flex; align-items: center; gap: 16px;">
          <div style="width: 56px; height: 56px; background: rgba(255,255,255,0.25); border-radius: 14px; display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-robot" style="font-size: 1.5rem;"></i>
          </div>
          <div>
            <h3 style="margin: 0 0 6px 0; font-size: 1.3rem; font-weight: 700;">ğŸ¤– AIæ™ºèƒ½ç”Ÿæˆé¢˜ç›®</h3>
            <p style="margin: 0; font-size: 0.95rem; opacity: 0.95;">
              è¯•å·ï¼š<strong>${examId}</strong> Â· 
              å…± <strong style="color: #fbbf24;">${questions.length}</strong> é“é¢˜ Â· 
              <span style="font-size: 0.85rem;">é¢˜ç›®ç”±AIæ ¹æ®éŸ³é¢‘å†…å®¹è‡ªåŠ¨ç”Ÿæˆ</span>
            </p>
          </div>
        </div>
      `;
      quizWrap.appendChild(banner);
      
      // éŸ³é¢‘æ’­æ”¾å™¨ï¼ˆå¸¦Sectionæ ‡è®°ï¼‰
      if (examData?.sections?.[0]?.audio) {
        const audioCard = document.createElement('div');
        audioCard.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 16px 20px;
          margin-bottom: 20px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        `;
        
        const audioEl = document.createElement('audio');
        audioEl.controls = true;
        audioEl.preload = 'auto';
        // ç§»é™¤crossOriginï¼Œå› ä¸ºjsDelivr CDNå¯èƒ½ä¸æ”¯æŒCORSï¼Œä¼šå¯¼è‡´æ’­æ”¾å¤±è´¥
        // audioEl.crossOrigin = 'anonymous';
        audioEl.style.cssText = 'width: 100%;';
        
        // ç¡®ä¿è·¯å¾„æ˜¯ç»å¯¹è·¯å¾„ï¼ˆä»æ ¹ç›®å½•å¼€å§‹ï¼‰
        let audioSrc = examData.sections[0].audio;
        if (audioSrc && !audioSrc.startsWith('http') && !audioSrc.startsWith('/')) {
          audioSrc = '/' + audioSrc;
        }
        
        // æ·»åŠ é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€
        const statusDiv = document.createElement('div');
        statusDiv.style.cssText = 'margin-top: 8px; font-size: 0.85rem; color: #666;';
        statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½éŸ³é¢‘...';
        
        // åŠ è½½çŠ¶æ€å¤„ç†
        audioEl.addEventListener('loadstart', () => {
          statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½éŸ³é¢‘...';
          console.log('ğŸµ å¼€å§‹åŠ è½½éŸ³é¢‘:', audioSrc);
        });
        
        audioEl.addEventListener('loadedmetadata', () => {
          statusDiv.innerHTML = '<span style="color: #10b981;"><i class="fas fa-check-circle"></i> éŸ³é¢‘åŠ è½½æˆåŠŸ</span>';
          console.log('âœ… éŸ³é¢‘å…ƒæ•°æ®åŠ è½½æˆåŠŸï¼Œæ—¶é•¿:', audioEl.duration, 'ç§’');
          setTimeout(() => statusDiv.innerHTML = '', 2000);
        });
        
        audioEl.addEventListener('canplay', () => {
          statusDiv.innerHTML = '<span style="color: #10b981;"><i class="fas fa-check-circle"></i> éŸ³é¢‘å°±ç»ªï¼Œå¯ä»¥æ’­æ”¾</span>';
          console.log('âœ… éŸ³é¢‘å°±ç»ªï¼Œå¯ä»¥æ’­æ”¾');
          setTimeout(() => statusDiv.innerHTML = '', 2000);
        });
        
        audioEl.addEventListener('canplaythrough', () => {
          console.log('âœ… éŸ³é¢‘å®Œå…¨åŠ è½½ï¼Œå¯ä»¥æµç•…æ’­æ”¾');
        });
        
        // é”™è¯¯å¤„ç† - æ”¯æŒå¤šä¸ªå›é€€æ–¹æ¡ˆ
        audioEl.addEventListener('error', function onError(e) {
          console.error('âŒ éŸ³é¢‘åŠ è½½å¤±è´¥:', audioSrc, e);
          console.error('é”™è¯¯ä»£ç :', audioEl.error ? audioEl.error.code : 'unknown');
          console.error('é”™è¯¯ä¿¡æ¯:', audioEl.error ? audioEl.error.message : 'unknown');
          
          // æ–¹æ¡ˆ1: å°è¯•å›é€€åˆ°set1ï¼ˆå¦‚æœæ˜¯set2æˆ–set3ï¼‰
          const fallbackSrc1 = audioSrc.replace(/-set[23]\.mp3$/, '-set1.mp3');
          if (fallbackSrc1 !== audioSrc) {
            statusDiv.innerHTML = '<span style="color: #fbbf24;"><i class="fas fa-info-circle"></i> åŸéŸ³é¢‘ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨åŒæœŸset1éŸ³é¢‘...</span>';
            console.log('ğŸ”„ å°è¯•å›é€€åˆ°set1:', fallbackSrc1);
            audioEl.removeEventListener('error', onError);
            audioEl.crossOrigin = null; // ç§»é™¤CORSè®¾ç½®
            audioEl.src = fallbackSrc1;
            audioEl.load(); // å¼ºåˆ¶é‡æ–°åŠ è½½
            audioEl.addEventListener('error', function onFallbackError1() {
              // æ–¹æ¡ˆ2: å°è¯•ä½¿ç”¨ raw.githubusercontent.com
              const rawSrc = audioSrc.replace('cdn.jsdelivr.net/gh/', 'raw.githubusercontent.com/').replace('@main/', 'main/');
              statusDiv.innerHTML = '<span style="color: #fbbf24;"><i class="fas fa-sync"></i> å°è¯•å¤‡ç”¨CDN...</span>';
              console.log('ğŸ”„ å°è¯•å¤‡ç”¨CDN:', rawSrc);
              audioEl.removeEventListener('error', onFallbackError1);
              audioEl.src = rawSrc;
              audioEl.load();
              audioEl.addEventListener('error', function onFallbackError2() {
                statusDiv.innerHTML = '<span style="color: #ff6b6b;"><i class="fas fa-exclamation-triangle"></i> éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</span>';
                console.error('âŒ æ‰€æœ‰å›é€€æ–¹æ¡ˆéƒ½å¤±è´¥');
              }, { once: true });
            }, { once: true });
            return;
          }
          
          // æ–¹æ¡ˆ2: å¦‚æœå·²ç»æ˜¯set1ï¼Œå°è¯•ä½¿ç”¨ raw.githubusercontent.com
          const rawSrc = audioSrc.replace('cdn.jsdelivr.net/gh/', 'raw.githubusercontent.com/').replace('@main/', 'main/');
          if (rawSrc !== audioSrc) {
            statusDiv.innerHTML = '<span style="color: #fbbf24;"><i class="fas fa-sync"></i> å°è¯•å¤‡ç”¨CDN...</span>';
            console.log('ğŸ”„ å°è¯•å¤‡ç”¨CDN:', rawSrc);
            audioEl.removeEventListener('error', onError);
            audioEl.crossOrigin = null; // ç§»é™¤CORSè®¾ç½®
            audioEl.src = rawSrc;
            audioEl.load(); // å¼ºåˆ¶é‡æ–°åŠ è½½
            audioEl.addEventListener('error', function onRawError() {
              statusDiv.innerHTML = '<span style="color: #ff6b6b;"><i class="fas fa-exclamation-triangle"></i> éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</span>';
              console.error('âŒ å¤‡ç”¨CDNä¹Ÿå¤±è´¥');
            }, { once: true });
            return;
          }
          
          // æ‰€æœ‰æ–¹æ¡ˆéƒ½å¤±è´¥
          statusDiv.innerHTML = '<span style="color: #ff6b6b;"><i class="fas fa-exclamation-triangle"></i> éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</span>';
          console.error('âŒ æ‰€æœ‰åŠ è½½æ–¹æ¡ˆéƒ½å¤±è´¥');
        }, { once: true });
        
        // å…ˆè®¾ç½®æ ‡é¢˜ï¼Œå†æ·»åŠ éŸ³é¢‘å…ƒç´ ï¼ˆé¿å…innerHTMLæ¸…ç©ºaudioElï¼‰
        const titleDiv = document.createElement('div');
        titleDiv.style.cssText = 'font-weight: 600; margin-bottom: 10px; color: #333;';
        titleDiv.innerHTML = '<i class="fas fa-headphones" style="color: #667eea;"></i> å¬åŠ›éŸ³é¢‘';
        audioCard.appendChild(titleDiv);
        
        // è®¾ç½®éŸ³é¢‘æºå¹¶æ·»åŠ åˆ°DOM
        audioEl.src = audioSrc;
        audioEl.load(); // å¼ºåˆ¶åŠ è½½éŸ³é¢‘
        audioCard.appendChild(audioEl);
        audioCard.appendChild(statusDiv);
        
        // Sectionæ—¶é—´æ ‡è®°åŒºåŸŸ
        const markerArea = document.createElement('div');
        markerArea.style.cssText = `
          margin-top: 12px;
          padding: 10px 0;
          position: relative;
        `;
        
        // è¿›åº¦æ¡èƒŒæ™¯
        const progressBg = document.createElement('div');
        progressBg.style.cssText = `
          height: 8px;
          background: #e5e7eb;
          border-radius: 4px;
          position: relative;
          margin-bottom: 8px;
        `;
        
        // Sectionæ ‡è®°ç‚¹ï¼ˆå››çº§å¬åŠ›æ ‡å‡†æ—¶é—´åˆ†å¸ƒï¼‰
        // Section A: 0:00-5:00, Section B: 5:00-13:00, Section C: 13:00-25:00
        const markers = [
          { time: 0, label: 'A', color: '#10b981', desc: 'Section A æ–°é—»' },
          { time: 0.2, label: 'B', color: '#3b82f6', desc: 'Section B å¯¹è¯' },
          { time: 0.52, label: 'C', color: '#8b5cf6', desc: 'Section C çŸ­æ–‡' }
        ];
        
        markers.forEach(m => {
          const marker = document.createElement('div');
          marker.style.cssText = `
            position: absolute;
            left: ${m.time * 100}%;
            top: -4px;
            width: 16px;
            height: 16px;
            background: ${m.color};
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: white;
            font-weight: bold;
            z-index: 2;
          `;
          marker.textContent = m.label;
          marker.title = m.desc;
          
          // ç‚¹å‡»è·³è½¬åˆ°å¯¹åº”æ—¶é—´
          marker.addEventListener('click', () => {
            if (audioEl.duration) {
              audioEl.currentTime = m.time * audioEl.duration;
              audioEl.play();
            }
          });
          
          progressBg.appendChild(marker);
        });
        
        markerArea.appendChild(progressBg);
        
        // æ ‡è®°è¯´æ˜
        const markerLegend = document.createElement('div');
        markerLegend.style.cssText = `
          display: flex;
          justify-content: space-between;
          font-size: 0.75rem;
          color: #666;
        `;
        markerLegend.innerHTML = `
          <span style="color: #10b981;">â— Section A æ–°é—»</span>
          <span style="color: #3b82f6;">â— Section B å¯¹è¯</span>
          <span style="color: #8b5cf6; font-weight: 600;">â— Section C çŸ­æ–‡ â† ä»è¿™é‡Œå¼€å§‹</span>
        `;
        markerArea.appendChild(markerLegend);
        
        audioCard.appendChild(markerArea);
        quizWrap.appendChild(audioCard);
      }
      
      // é¢˜ç›®åˆ—è¡¨
      const list = document.createElement('div');
      list.style.cssText = 'display: grid; gap: 16px;';
      
      const userAnswers = new Map();
      
      questions.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'ai-question-card';
        card.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 20px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          transition: all 0.3s ease;
        `;
        
        const sectionLabel = q.section === 'A' ? 'Section A - æ–°é—»æŠ¥é“' : 
                            q.section === 'B' ? 'Section B - é•¿å¯¹è¯' : 'Section C - çŸ­æ–‡';
        
        card.innerHTML = `
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
              ç¬¬${q.id || idx+1}é¢˜
            </span>
            <span style="color: #888; font-size: 0.8rem;">${sectionLabel}</span>
          </div>
          <div style="font-size: 1rem; color: #333; margin-bottom: 16px; line-height: 1.6;">
            ${q.stem}
          </div>
          <div class="options-wrap" style="display: grid; gap: 10px;"></div>
          <div class="explain-area" style="margin-top: 16px; padding: 12px 16px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid #667eea; border-radius: 8px;">
            <div style="display: flex; align-items: flex-start; gap: 8px;">
              <i class="fas fa-lightbulb" style="color: #f39c12; font-size: 1.1rem; margin-top: 2px;"></i>
              <div>
                <div style="font-weight: 600; color: #667eea; margin-bottom: 4px; font-size: 0.9rem;">ç­”æ¡ˆè§£æ</div>
                <div style="font-size: 0.9rem; color: #555; line-height: 1.6;">${q.explain || 'æš‚æ— è§£æ'}</div>
              </div>
            </div>
          </div>
          <div class="feedback-area" style="margin-top: 12px; display: none;"></div>
        `;
        
        const optionsWrap = card.querySelector('.options-wrap');
        const options = q.options || [];
        const optionLabels = ['A', 'B', 'C', 'D'];
        
        options.forEach((opt, optIdx) => {
          const optBtn = document.createElement('button');
          optBtn.className = 'option-btn';
          optBtn.dataset.value = optionLabels[optIdx];
          optBtn.style.cssText = `
            width: 100%;
            padding: 12px 16px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            text-align: left;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #333;
          `;
          optBtn.innerHTML = `<strong>${optionLabels[optIdx]}.</strong> ${opt}`;
          
          optBtn.addEventListener('click', () => {
            // æ¸…é™¤åŒé¢˜å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            optionsWrap.querySelectorAll('.option-btn').forEach(btn => {
              btn.style.background = '#f8f9fa';
              btn.style.borderColor = '#e9ecef';
              btn.style.color = '#333';
            });
            // é€‰ä¸­å½“å‰
            optBtn.style.background = '#667eea';
            optBtn.style.borderColor = '#667eea';
            optBtn.style.color = 'white';
            userAnswers.set(idx, optionLabels[optIdx]);
          });
          
          optionsWrap.appendChild(optBtn);
        });
        
        list.appendChild(card);
      });
      
      quizWrap.appendChild(list);
      
      // æäº¤æŒ‰é’®
      const submitArea = document.createElement('div');
      submitArea.style.cssText = `
        margin-top: 24px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 16px;
      `;
      
      const submitBtn = document.createElement('button');
      submitBtn.style.cssText = `
        padding: 14px 48px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        transition: all 0.3s ease;
      `;
      submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> æäº¤ç­”æ¡ˆ';
      
      submitBtn.addEventListener('click', () => {
        // åˆ¤åˆ†
        let correct = 0;
        const cards = list.querySelectorAll('.ai-question-card');
        
        questions.forEach((q, idx) => {
          const card = cards[idx];
          const feedbackArea = card.querySelector('.feedback-area');
          const userAns = userAnswers.get(idx);
          const correctAns = q.answer;
          const isCorrect = userAns === correctAns;
          
          if (isCorrect) correct++;
          
          // æ˜¾ç¤ºåé¦ˆ
          feedbackArea.style.display = 'block';
          feedbackArea.style.padding = '12px';
          feedbackArea.style.borderRadius = '8px';
          feedbackArea.style.background = isCorrect ? '#d4edda' : '#f8d7da';
          feedbackArea.style.color = isCorrect ? '#155724' : '#721c24';
          
          const statusIcon = isCorrect ? 'âœ…' : 'âŒ';
          const userAnsText = userAns || 'æœªä½œç­”';
          
          feedbackArea.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 6px;">
              ${statusIcon} ${isCorrect ? 'å›ç­”æ­£ç¡®' : 'å›ç­”é”™è¯¯'} 
              <span style="margin-left: 10px; font-weight: normal;">
                ä½ çš„ç­”æ¡ˆ: <strong>${userAnsText}</strong> | æ­£ç¡®ç­”æ¡ˆ: <strong style="color: #155724;">${correctAns}</strong>
              </span>
            </div>
            <div style="font-size: 0.9rem; color: #555;">
              <i class="fas fa-lightbulb" style="color: #f39c12;"></i> ${q.explain || 'æš‚æ— è§£æ'}
            </div>
          `;
          
          // é«˜äº®æ­£ç¡®é€‰é¡¹
          const optBtns = card.querySelectorAll('.option-btn');
          optBtns.forEach(btn => {
            btn.disabled = true;
            btn.style.cursor = 'default';
            if (btn.dataset.value === correctAns) {
              btn.style.background = '#28a745';
              btn.style.borderColor = '#28a745';
              btn.style.color = 'white';
            } else if (btn.dataset.value === userAns && !isCorrect) {
              btn.style.background = '#dc3545';
              btn.style.borderColor = '#dc3545';
              btn.style.color = 'white';
            }
          });
        });
        
        // æ˜¾ç¤ºæ€»åˆ†
        const score = Math.round((correct / questions.length) * 100);
        submitBtn.disabled = true;
        submitBtn.innerHTML = `å¾—åˆ†ï¼š${correct}/${questions.length} (${score}åˆ†)`;
        submitBtn.style.background = score >= 60 ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #f59e0b, #d97706)';
        
        // æ»šåŠ¨åˆ°é¡¶éƒ¨
        window.scrollTo({ top: quizWrap.getBoundingClientRect().top + window.scrollY - 20, behavior: 'smooth' });
        
        // æ˜¾ç¤ºæˆç»©æ¨ªå¹…
        const resultBanner = document.createElement('div');
        resultBanner.style.cssText = `
          background: ${score >= 60 ? 'linear-gradient(135deg, #10b981, #059669)' : 'linear-gradient(135deg, #f59e0b, #d97706)'};
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 20px;
          color: white;
          text-align: center;
        `;
        resultBanner.innerHTML = `
          <h2 style="margin: 0 0 8px 0; font-size: 2rem;">${score >= 60 ? 'ğŸ‰' : 'ğŸ’ª'} ${score}åˆ†</h2>
          <p style="margin: 0; opacity: 0.9;">ç­”å¯¹ ${correct} é¢˜ï¼Œå…± ${questions.length} é¢˜</p>
          <p style="margin: 8px 0 0; font-size: 0.9rem;">${score >= 85 ? 'ä¼˜ç§€ï¼ç»§ç»­ä¿æŒï¼' : score >= 60 ? 'åŠæ ¼äº†ï¼Œè¿˜æœ‰æå‡ç©ºé—´ï¼' : 'éœ€è¦å¤šåŠ ç»ƒä¹ å“¦ï¼'}</p>
        `;
        banner.after(resultBanner);
      });
      
      submitArea.appendChild(submitBtn);
      quizWrap.appendChild(submitArea);
      
      // é‡æ–°å¼€å§‹æŒ‰é’®
      const restartBtn = document.createElement('button');
      restartBtn.style.cssText = `
        padding: 12px 28px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-left: auto;
      `;
      restartBtn.innerHTML = '<i class="fas fa-redo"></i> é‡æ–°æµ‹è¯•';
      restartBtn.addEventListener('mouseover', () => {
        restartBtn.style.transform = 'translateY(-2px)';
        restartBtn.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.4)';
      });
      restartBtn.addEventListener('mouseout', () => {
        restartBtn.style.transform = 'translateY(0)';
        restartBtn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
      });
      restartBtn.addEventListener('click', () => {
        renderAIGeneratedQuiz(questions, examId, examData);
      });
      submitArea.appendChild(restartBtn);
    }
    
    function renderQuiz(items, examData){
      quizWrap.innerHTML=''; resWrap.style.display='none';
      quizWrap.style.display='block';
      
      // å¦‚æœæ²¡æœ‰é¢˜ç›®ä½†æŒ‡å®šäº†è¯•å·ï¼Œæ˜¾ç¤ºéŸ³é¢‘ç»ƒä¹ æ¨¡å¼
      if(items.length===0 && window._currentExamFilter && examData){ 
        const audioOnlyBanner = document.createElement('div');
        audioOnlyBanner.style.cssText = `
          background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
          border-radius: 16px;
          padding: 24px 28px;
          margin-bottom: 24px;
          box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
          color: white;
        `;
        audioOnlyBanner.innerHTML = `
          <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 20px;">
            <div style="width: 56px; height: 56px; background: rgba(255,255,255,0.25); border-radius: 14px; display: flex; align-items: center; justify-content: center;">
              <i class="fas fa-headphones" style="font-size: 1.5rem;"></i>
            </div>
            <div>
              <h3 style="margin: 0 0 6px 0; font-size: 1.3rem; font-weight: 700;">ğŸ§ å¬åŠ›éŸ³é¢‘ç»ƒä¹ æ¨¡å¼</h3>
              <p style="margin: 0; font-size: 0.95rem; opacity: 0.95;">
                è¯•å·ï¼š<strong>${window._currentExamFilter}</strong> Â· 
                æ­¤è¯•å·æš‚æ— é¢˜ç›®æ•°æ®ï¼Œä½†æ‚¨å¯ä»¥æ’­æ”¾éŸ³é¢‘è¿›è¡Œå¬åŠ›ç»ƒä¹ 
              </p>
            </div>
          </div>
        `;
        
        // ä¸ºæ¯ä¸ªsectionåˆ›å»ºéŸ³é¢‘æ’­æ”¾å™¨ï¼ˆå¸¦éŸ³é¢‘å¯ç”¨æ€§æ£€æŸ¥ï¼‰
        if(examData.sections && examData.sections.length > 0) {
          // åªæ˜¾ç¤ºç¬¬ä¸€ä¸ªsectionçš„éŸ³é¢‘ï¼ˆé€šå¸¸æ•´å¥—è¯•å·å…±ç”¨ä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶ï¼‰
          const sec = examData.sections[0];
          if(sec.audio) {
            const secCard = document.createElement('div');
            secCard.style.cssText = `
              background: rgba(255,255,255,0.15);
              border-radius: 12px;
              padding: 16px 20px;
              margin-top: 12px;
            `;
            
            // æ£€æŸ¥éŸ³é¢‘æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™å°è¯•å›é€€
            const audioEl = document.createElement('audio');
            audioEl.controls = true;
            audioEl.preload = 'auto';
            // ç§»é™¤crossOriginï¼Œå› ä¸ºjsDelivr CDNå¯èƒ½ä¸æ”¯æŒCORS
            // audioEl.crossOrigin = 'anonymous';
            audioEl.style.cssText = 'width: 100%; border-radius: 8px;';
            
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = 'margin-top: 8px; font-size: 0.85rem;';
            
            // ç¡®ä¿è·¯å¾„æ˜¯ç»å¯¹è·¯å¾„ï¼ˆä»æ ¹ç›®å½•å¼€å§‹ï¼‰
            let audioSrc = sec.audio;
            if (audioSrc && !audioSrc.startsWith('http') && !audioSrc.startsWith('/')) {
              audioSrc = '/' + audioSrc;
            }
            
            // æ·»åŠ åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½éŸ³é¢‘...';
            
            audioEl.addEventListener('loadstart', () => {
              statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½éŸ³é¢‘...';
            });
            
            audioEl.addEventListener('loadedmetadata', () => {
              statusDiv.innerHTML = '<span style="color: #10b981;"><i class="fas fa-check-circle"></i> éŸ³é¢‘åŠ è½½æˆåŠŸ</span>';
              console.log('âœ… éŸ³é¢‘å…ƒæ•°æ®åŠ è½½æˆåŠŸ');
              setTimeout(() => statusDiv.innerHTML = '', 2000);
            });
            
            audioEl.addEventListener('canplay', () => {
              statusDiv.innerHTML = '<span style="color: #10b981;"><i class="fas fa-check-circle"></i> éŸ³é¢‘å°±ç»ªï¼Œå¯ä»¥æ’­æ”¾</span>';
              console.log('âœ… éŸ³é¢‘å°±ç»ªï¼Œå¯ä»¥æ’­æ”¾');
              setTimeout(() => statusDiv.innerHTML = '', 2000);
            });
            
            audioEl.addEventListener('canplaythrough', () => {
              console.log('âœ… éŸ³é¢‘å®Œå…¨åŠ è½½ï¼Œå¯ä»¥æµç•…æ’­æ”¾');
            });
            
            // é”™è¯¯å¤„ç† - æ”¯æŒå¤šä¸ªå›é€€æ–¹æ¡ˆ
            audioEl.addEventListener('error', function onError(e) {
              console.error('éŸ³é¢‘åŠ è½½å¤±è´¥:', audioSrc, e);
              
              // æ–¹æ¡ˆ1: å°è¯•å›é€€åˆ°set1ï¼ˆå¦‚æœæ˜¯set2æˆ–set3ï¼‰
              const fallbackSrc1 = audioSrc.replace(/-set[23]\.mp3$/, '-set1.mp3');
              if (fallbackSrc1 !== audioSrc) {
                statusDiv.innerHTML = '<span style="color: #fbbf24;"><i class="fas fa-info-circle"></i> åŸéŸ³é¢‘ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨åŒæœŸset1éŸ³é¢‘...</span>';
                audioEl.removeEventListener('error', onError);
                audioEl.src = fallbackSrc1;
                audioEl.addEventListener('error', function onFallbackError1() {
                  // æ–¹æ¡ˆ2: å°è¯•ä½¿ç”¨ raw.githubusercontent.com
                  const rawSrc = audioSrc.replace('cdn.jsdelivr.net/gh/', 'raw.githubusercontent.com/').replace('@main/', 'main/');
                  statusDiv.innerHTML = '<span style="color: #fbbf24;"><i class="fas fa-sync"></i> å°è¯•å¤‡ç”¨CDN...</span>';
                  audioEl.removeEventListener('error', onFallbackError1);
                  audioEl.src = rawSrc;
                  audioEl.addEventListener('error', function onFallbackError2() {
                    statusDiv.innerHTML = '<span style="color: #ff6b6b;"><i class="fas fa-exclamation-triangle"></i> éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</span>';
                  }, { once: true });
                }, { once: true });
                return;
              }
              
              // æ–¹æ¡ˆ2: å¦‚æœå·²ç»æ˜¯set1ï¼Œå°è¯•ä½¿ç”¨ raw.githubusercontent.com
              const rawSrc = audioSrc.replace('cdn.jsdelivr.net/gh/', 'raw.githubusercontent.com/').replace('@main/', 'main/');
              if (rawSrc !== audioSrc) {
                statusDiv.innerHTML = '<span style="color: #fbbf24;"><i class="fas fa-sync"></i> å°è¯•å¤‡ç”¨CDN...</span>';
                audioEl.removeEventListener('error', onError);
                audioEl.src = rawSrc;
                audioEl.addEventListener('error', function onRawError() {
                  statusDiv.innerHTML = '<span style="color: #ff6b6b;"><i class="fas fa-exclamation-triangle"></i> éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</span>';
                }, { once: true });
                return;
              }
              
              // æ‰€æœ‰æ–¹æ¡ˆéƒ½å¤±è´¥
              statusDiv.innerHTML = '<span style="color: #ff6b6b;"><i class="fas fa-exclamation-triangle"></i> éŸ³é¢‘åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•</span>';
            }, { once: true });
            
            // å…ˆè®¾ç½®æ ‡é¢˜å’Œæè¿°ï¼Œå†æ·»åŠ éŸ³é¢‘å…ƒç´ ï¼ˆé¿å…innerHTMLæ¸…ç©ºaudioElï¼‰
            const titleDiv2 = document.createElement('div');
            titleDiv2.style.cssText = 'font-weight: 600; margin-bottom: 10px;';
            titleDiv2.innerHTML = '<i class="fas fa-volume-up"></i> å®Œæ•´å¬åŠ›éŸ³é¢‘';
            secCard.appendChild(titleDiv2);
            
            // è®¾ç½®éŸ³é¢‘æºå¹¶æ·»åŠ åˆ°DOM
            audioEl.src = audioSrc;
            secCard.appendChild(audioEl);
            
            // æ·»åŠ æè¿°
            const descP = document.createElement('p');
            descP.style.cssText = 'margin: 8px 0 0; font-size: 0.85rem; opacity: 0.8;';
            descP.textContent = `${sec.description || ''} Â· ${sec.duration || ''}`;
            secCard.appendChild(descP);
            secCard.appendChild(statusDiv);
            audioOnlyBanner.appendChild(secCard);
          }
        }
        
        // AIç”Ÿæˆé¢˜ç›®æŒ‰é’®åŒºåŸŸ
        const aiGenerateArea = document.createElement('div');
        aiGenerateArea.style.cssText = `
          margin-top: 20px;
          padding: 20px;
          background: rgba(255,255,255,0.95);
          border-radius: 12px;
          color: #333;
        `;
        
        const aiGenerateBtn = document.createElement('button');
        aiGenerateBtn.style.cssText = `
          width: 100%;
          padding: 16px 24px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 12px;
          font-size: 1.1rem;
          font-weight: 600;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          transition: all 0.3s ease;
          box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        `;
        aiGenerateBtn.innerHTML = '<i class="fas fa-magic"></i> AIæ™ºèƒ½ç”Ÿæˆé¢˜ç›®';
        
        const aiGenerateStatus = document.createElement('div');
        aiGenerateStatus.style.cssText = `
          margin-top: 12px;
          padding: 12px;
          border-radius: 8px;
          font-size: 0.9rem;
          display: none;
        `;
        
        const aiGenerateDesc = document.createElement('p');
        aiGenerateDesc.style.cssText = `
          margin: 0 0 16px 0;
          font-size: 0.9rem;
          color: #666;
          line-height: 1.6;
        `;
        aiGenerateDesc.innerHTML = `
          <i class="fas fa-bolt" style="color: #f59e0b;"></i> 
          ç‚¹å‡»æŒ‰é’®ï¼ŒAIå°†<strong>æé€Ÿ</strong>ç”Ÿæˆ<strong>5é“å¬åŠ›é¢˜ç›®</strong>ï¼Œçº¦éœ€<strong>15-25ç§’</strong>ã€‚
        `;
        
        aiGenerateArea.appendChild(aiGenerateDesc);
        aiGenerateArea.appendChild(aiGenerateBtn);
        aiGenerateArea.appendChild(aiGenerateStatus);
        audioOnlyBanner.appendChild(aiGenerateArea);
        
        // AIç”Ÿæˆé¢˜ç›®ç‚¹å‡»äº‹ä»¶
        const currentExamId = window._currentExamFilter;
        const currentExamData = examData;
        
        aiGenerateBtn.addEventListener('click', async () => {
          // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„AIç”Ÿæˆé¢˜ç›®
          const cacheKey = `ai-generated-questions-${currentExamId}`;
          const cached = localStorage.getItem(cacheKey);
          if (cached) {
            try {
              const cachedQuestions = JSON.parse(cached);
              if (cachedQuestions && cachedQuestions.length > 0) {
                if (confirm('æ£€æµ‹åˆ°å·²ç”Ÿæˆçš„é¢˜ç›®ç¼“å­˜ï¼Œæ˜¯å¦ç›´æ¥ä½¿ç”¨ï¼Ÿ\nç‚¹å‡»"å–æ¶ˆ"å°†é‡æ–°ç”Ÿæˆã€‚')) {
                  renderAIGeneratedQuiz(cachedQuestions, currentExamId, currentExamData);
                  return;
                }
              }
            } catch(e) {}
          }
          
          aiGenerateBtn.disabled = true;
          aiGenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨è¯†åˆ«éŸ³é¢‘...';
          aiGenerateStatus.style.display = 'block';
          aiGenerateStatus.style.background = '#e8f4fd';
          aiGenerateStatus.style.color = '#0071e3';
          aiGenerateStatus.innerHTML = '<i class="fas fa-headphones"></i> ç¬¬1æ­¥ï¼šè¯†åˆ«éŸ³é¢‘ä¸­...';
          
          // æ·»åŠ è¿›åº¦è®¡æ—¶å™¨
          let seconds = 0;
          const timer = setInterval(() => {
            seconds++;
            aiGenerateStatus.innerHTML = `<i class="fas fa-spinner fa-spin"></i> å¤„ç†ä¸­... ${seconds}ç§’`;
          }, 1000);
          
          try {
            // è·å–éŸ³é¢‘æ–‡ä»¶ï¼ˆæ”¯æŒå›é€€åˆ°set1ï¼‰
            let audioSrc = currentExamData.sections?.[0]?.audio;
            if (!audioSrc) throw new Error('æœªæ‰¾åˆ°éŸ³é¢‘é…ç½®');
            
            // ç¡®ä¿è·¯å¾„æ˜¯ç»å¯¹è·¯å¾„ï¼ˆä»æ ¹ç›®å½•å¼€å§‹ï¼‰
            if (!audioSrc.startsWith('http') && !audioSrc.startsWith('/')) {
              audioSrc = '/' + audioSrc;
            }
            
            // å°è¯•åŠ è½½éŸ³é¢‘ï¼ˆæ”¯æŒå¤šä¸ªå›é€€æ–¹æ¡ˆï¼‰
            let audioResponse = await fetch(audioSrc, { 
              mode: 'cors',
              cache: 'default'
            });
            
            // æ–¹æ¡ˆ1: å¦‚æœéŸ³é¢‘ä¸å­˜åœ¨ï¼Œå°è¯•å›é€€åˆ°set1ï¼ˆåŒä¸€è€ƒè¯•é€šå¸¸å…±ç”¨å¬åŠ›éŸ³é¢‘ï¼‰
            if (!audioResponse.ok) {
              const fallbackSrc1 = audioSrc.replace(/-set[23]\.mp3$/, '-set1.mp3');
              if (fallbackSrc1 !== audioSrc) {
                aiGenerateStatus.innerHTML = '<i class="fas fa-sync"></i> åŸéŸ³é¢‘ä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨åŒæœŸset1éŸ³é¢‘...';
                audioResponse = await fetch(fallbackSrc1, { mode: 'cors', cache: 'default' });
                if (audioResponse.ok) {
                  audioSrc = fallbackSrc1;
                }
              }
            }
            
            // æ–¹æ¡ˆ2: å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ raw.githubusercontent.com
            if (!audioResponse.ok) {
              const rawSrc = audioSrc.replace('cdn.jsdelivr.net/gh/', 'raw.githubusercontent.com/').replace('@main/', 'main/');
              if (rawSrc !== audioSrc) {
                aiGenerateStatus.innerHTML = '<i class="fas fa-sync"></i> å°è¯•å¤‡ç”¨CDN...';
                audioResponse = await fetch(rawSrc, { mode: 'cors', cache: 'default' });
                if (audioResponse.ok) {
                  audioSrc = rawSrc;
                }
              }
            }
            
            if (!audioResponse.ok) {
              throw new Error('éŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
            }
            const audioBlob = await audioResponse.blob();
            
            // è°ƒç”¨SiliconFlow APIè¯†åˆ«éŸ³é¢‘
            const apiKey = 'sk-zxwcsadwzlqigvrgvxphpavfangpazhbxtlvgkwtapolwndm';
            const formData = new FormData();
            formData.append('file', audioBlob, 'audio.mp3');
            formData.append('model', 'FunAudioLLM/SenseVoiceSmall');
            
            aiGenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIè¯†åˆ«ä¸­...';
            
            const transcriptResponse = await fetch('https://api.siliconflow.cn/v1/audio/transcriptions', {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${apiKey}` },
              body: formData
            });
            
            if (!transcriptResponse.ok) throw new Error('éŸ³é¢‘è¯†åˆ«å¤±è´¥');
            const transcriptResult = await transcriptResponse.json();
            const transcript = transcriptResult.text;
            
            if (!transcript || transcript.length < 100) {
              throw new Error('éŸ³é¢‘è¯†åˆ«ç»“æœè¿‡çŸ­ï¼Œè¯·ç¡®ä¿éŸ³é¢‘æ–‡ä»¶æ­£å¸¸');
            }
            
            aiGenerateStatus.innerHTML = '<i class="fas fa-brain"></i> ç¬¬2æ­¥ï¼šæ­£åœ¨å¿«é€Ÿç”Ÿæˆé¢˜ç›®...';
            aiGenerateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç”Ÿæˆé¢˜ç›®ä¸­...';
            
            // æé€Ÿï¼šåªæˆªå–1500å­—ç¬¦
            const truncatedTranscript = transcript.substring(0, 1500);
            
            // æç®€prompt - 5é“é¢˜å¿«é€Ÿç”Ÿæˆ
            const prompt = `æ ¹æ®åŸæ–‡ç”Ÿæˆ5é“è‹±è¯­é€‰æ‹©é¢˜,ç›´æ¥è¾“å‡ºJSON:
{"questions":[{"id":1,"stem":"é—®é¢˜","options":["A","B","C","D"],"answer":"A"}]}
åŸæ–‡:${truncatedTranscript}`;

            const llmResponse = await fetch('https://api.siliconflow.cn/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                model: 'Qwen/Qwen2.5-7B-Instruct',
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.3,
                max_tokens: 1500
              })
            });
            
            if (!llmResponse.ok) throw new Error('é¢˜ç›®ç”Ÿæˆå¤±è´¥');
            const llmResult = await llmResponse.json();
            const content = llmResult.choices?.[0]?.message?.content || '';
            
            // è§£æJSON - å¢å¼ºå®¹é”™
            let questions = [];
            try {
              // å°è¯•å¤šç§æ–¹å¼æå–JSON
              let jsonStr = content;
              
              // ç§»é™¤å¯èƒ½çš„markdownä»£ç å—æ ‡è®°
              jsonStr = jsonStr.replace(/```json\s*/g, '').replace(/```\s*/g, '');
              
              // å°è¯•æå–JSONå¯¹è±¡
              const jsonMatch = jsonStr.match(/\{[\s\S]*"questions"[\s\S]*\}/);
              if (jsonMatch) {
                jsonStr = jsonMatch[0];
              }
              
              // ä¿®å¤å¸¸è§çš„JSONæ ¼å¼é—®é¢˜
              jsonStr = jsonStr.replace(/,\s*}/g, '}').replace(/,\s*]/g, ']');
              
              const parsed = JSON.parse(jsonStr);
              questions = parsed.questions || [];
              
              // éªŒè¯é¢˜ç›®æ ¼å¼
              questions = questions.filter(q => q.stem && q.options && q.answer);
              
            } catch(e) {
              console.error('JSONè§£æå¤±è´¥:', e, '\nåŸå§‹å†…å®¹:', content);
              throw new Error('é¢˜ç›®æ ¼å¼è§£æå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
            
            if (questions.length < 3) {
              throw new Error('ç”Ÿæˆçš„é¢˜ç›®æ•°é‡ä¸è¶³ï¼Œè¯·é‡è¯•');
            }
            
            // ä¿å­˜åˆ°ç¼“å­˜
            localStorage.setItem(cacheKey, JSON.stringify(questions));
            // åŒæ—¶ä¿å­˜åŸæ–‡
            localStorage.setItem(`ai-transcript-shared-${currentExamId}`, transcript);
            
            clearInterval(timer); // æ¸…é™¤è®¡æ—¶å™¨
            aiGenerateStatus.style.background = '#d4edda';
            aiGenerateStatus.style.color = '#155724';
            aiGenerateStatus.innerHTML = `<i class="fas fa-check-circle"></i> æˆåŠŸç”Ÿæˆ ${questions.length} é“é¢˜ç›®ï¼ç”¨æ—¶${seconds}ç§’`;
            
            // æ¸²æŸ“ç”Ÿæˆçš„é¢˜ç›®
            setTimeout(() => {
              renderAIGeneratedQuiz(questions, currentExamId, currentExamData);
            }, 1000);
            
          } catch (err) {
            clearInterval(timer); // æ¸…é™¤è®¡æ—¶å™¨
            console.error('AIç”Ÿæˆå¤±è´¥:', err);
            aiGenerateBtn.disabled = false;
            aiGenerateBtn.innerHTML = '<i class="fas fa-magic"></i> é‡æ–°ç”Ÿæˆ';
            aiGenerateStatus.style.background = '#f8d7da';
            aiGenerateStatus.style.color = '#721c24';
            aiGenerateStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> ç”Ÿæˆå¤±è´¥ï¼š${err.message || 'è¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•'}`;
          }
        });
        
        quizWrap.appendChild(audioOnlyBanner);
        return; 
      }
      
      if(items.length===0){ 
        quizWrap.textContent='æ²¡æœ‰åŒ¹é…åˆ°é¢˜ç›®ï¼Œè¯·è°ƒæ•´æŠ€èƒ½æˆ–å…ˆå¤šåšé¢˜å®Œå–„ç”»åƒã€‚'; 
        return; 
      }
      
      // å¦‚æœæ˜¯å®Œæ•´è¯•å·æµ‹è¯•ï¼Œæ˜¾ç¤ºç‰¹æ®Šæç¤º
      if (window._currentExamFilter && items.length > 0) {
        const examBanner = document.createElement('div');
        examBanner.style.cssText = `
          background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
          border-radius: 16px;
          padding: 20px 28px;
          margin-bottom: 24px;
          box-shadow: 0 4px 16px rgba(6, 182, 212, 0.3);
          color: white;
          animation: fadeInUp 0.5s ease-out;
        `;
        examBanner.innerHTML = `
          <div style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 56px; height: 56px; background: rgba(255,255,255,0.25); backdrop-filter: blur(10px); border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
              <i class="fas fa-clipboard-check" style="font-size: 1.5rem;"></i>
            </div>
            <div style="flex: 1;">
              <h3 style="margin: 0 0 6px 0; font-size: 1.3rem; font-weight: 700;">ğŸ“ å®Œæ•´è¯•å·æµ‹è¯•æ¨¡å¼</h3>
              <p style="margin: 0; font-size: 0.95rem; opacity: 0.95;">
                è¯•å·ï¼š<strong>${window._currentExamFilter}</strong> Â· 
                å…± <strong style="font-size: 1.1rem; color: #fbbf24;">${items.length}</strong> é“é¢˜ Â· 
                å»ºè®®ç”¨æ—¶ <strong>25-30åˆ†é’Ÿ</strong>
              </p>
            </div>
          </div>
        `;
        quizWrap.appendChild(examBanner);
      }
      
      const quizStart = Date.now();
      const list=document.createElement('div'); list.className='listening-list'; list.style.display='grid'; list.style.gap='10px';
      const state = new Map();
      const timeSpent = new Map(); // idx -> ms
      let activeIdx = null; let activeStartTs = null;
      const cards = [];
      items.forEach((it,idx)=>{
        const card=document.createElement('div'); card.className='question';
        
        // é«˜çº§æ¥æºä¿¡æ¯å¡ç‰‡ - è‹¹æœé£æ ¼
        const sourceCard = document.createElement('div');
        sourceCard.style.cssText = `
          background: #f5f5f7;
          padding: 12px 16px;
          border-radius: 12px;
          margin-bottom: 12px;
          color: #1d1d1f;
          box-shadow: none;
          border: 1px solid rgba(0,0,0,0.08);
          position: relative;
          overflow: hidden;
        `;
        
        // è¯•å·ä¿¡æ¯è¡Œ
        const examRow = document.createElement('div');
        examRow.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 6px; position: relative; z-index: 1;';
        
        const examIcon = document.createElement('i');
        examIcon.className = 'fas fa-file-alt';
        examIcon.style.cssText = 'font-size: 1.1rem; opacity: 0.9;';
        
        const examText = document.createElement('span');
        examText.textContent = it.examId;
        examText.style.cssText = 'font-weight: 600; font-size: 0.95rem; letter-spacing: 0.5px;';
        
        examRow.appendChild(examIcon);
        examRow.appendChild(examText);
        
        // Sectionå¾½ç« 
        const sectionRow = document.createElement('div');
        sectionRow.style.cssText = 'display: flex; align-items: center; gap: 8px; position: relative; z-index: 1;';
        
        const sectionBadge = document.createElement('div');
        sectionBadge.style.cssText = `
          background: #ffffff;
          padding: 4px 12px;
          border-radius: 980px;
          font-size: 0.85rem;
          font-weight: 500;
          border: 1px solid rgba(0,0,0,0.1);
          display: inline-flex;
          align-items: center;
          gap: 6px;
          color: #1d1d1f;
        `;
        
        const sectionIcon = document.createElement('i');
        const sectionName = it.section.toLowerCase();
        if (sectionName.includes('conversation')) {
          sectionIcon.className = 'fas fa-comments';
        } else if (sectionName.includes('passage')) {
          sectionIcon.className = 'fas fa-book-open';
        } else if (sectionName.includes('lecture')) {
          sectionIcon.className = 'fas fa-chalkboard-teacher';
        } else {
          sectionIcon.className = 'fas fa-headphones';
        }
        
        const sectionText = document.createElement('span');
        sectionText.textContent = it.section;
        
        sectionBadge.appendChild(sectionIcon);
        sectionBadge.appendChild(sectionText);
        sectionRow.appendChild(sectionBadge);
        
        sourceCard.appendChild(examRow);
        sourceCard.appendChild(sectionRow);
        card.appendChild(sourceCard);
        
        // é¢˜ç›®ç¼–å·å’Œå†…å®¹
        const questionHeader = document.createElement('div');
        questionHeader.style.cssText = 'display: flex; align-items: flex-start; gap: 12px; margin-bottom: 8px;';
        
        const qNumber = document.createElement('div');
        qNumber.style.cssText = `
          background: #0071e3;
          color: white;
          width: 40px;
          height: 40px;
          border-radius: 10px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          font-size: 1.15rem;
          flex-shrink: 0;
          box-shadow: none;
        `;
        qNumber.textContent = idx + 1;
        
        const qText = document.createElement('div');
        qText.style.cssText = 'flex: 1; padding-top: 4px; font-size: 1.05rem; line-height: 1.6;';
        qText.innerHTML = it.q.stem || '';
        
        questionHeader.appendChild(qNumber);
        questionHeader.appendChild(qText);
        card.appendChild(questionHeader);
        // éŸ³é¢‘ï¼šä¼˜å…ˆé¢˜çº§ï¼Œå…¶æ¬¡æ®µçº§
        let audioSrc = it.q?.audio || it.sectionAudio || '';
        // ç¡®ä¿è·¯å¾„æ˜¯ç»å¯¹è·¯å¾„ï¼ˆä»æ ¹ç›®å½•å¼€å§‹ï¼‰
        if (audioSrc && !audioSrc.startsWith('http') && !audioSrc.startsWith('/')) {
          audioSrc = '/' + audioSrc;
        }
        // æ—¶é—´æˆ³ï¼šä¼˜å…ˆä½¿ç”¨é¢˜ç›®çº§åˆ«ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨Sectionçº§åˆ«
        const hasQuestionTimestamp = typeof it.q?.audioStart === 'number' && typeof it.q?.audioEnd === 'number';
        const hasSectionTimestamp = typeof it.sectionStart === 'number' && typeof it.sectionEnd === 'number';
        const hasTimestamp = hasQuestionTimestamp || hasSectionTimestamp;
        const timestampStart = hasQuestionTimestamp ? it.q.audioStart : it.sectionStart;
        const timestampEnd = hasQuestionTimestamp ? it.q.audioEnd : it.sectionEnd;
        let qa=null; let abState=null;
        if (audioSrc) {
          // éŸ³é¢‘å®šä½ä¿¡æ¯ - é†’ç›®å¡ç‰‡
          if (hasTimestamp) {
            const timestampCard = document.createElement('div');
            timestampCard.style.cssText = `
              background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
              padding: 1.25rem 1.5rem;
              border-radius: 14px;
              margin: 1rem 0 1.25rem;
              border: 2px solid rgba(102, 126, 234, 0.3);
              box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
              display: flex;
              align-items: center;
              gap: 1rem;
            `;
            
            const iconBox = document.createElement('div');
            iconBox.style.cssText = `
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              width: 48px;
              height: 48px;
              border-radius: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
              box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            `;
            iconBox.innerHTML = '<i class="fas fa-map-marker-alt" style="font-size: 1.3rem;"></i>';
            
            const textBox = document.createElement('div');
            textBox.style.cssText = 'flex: 1;';
            
            const source = hasQuestionTimestamp ? 'ğŸ“ é¢˜ç›®ç²¾ç¡®å®šä½' : 'ğŸ“ SectionåŒºé—´å®šä½';
            const label = document.createElement('div');
            label.style.cssText = 'font-size: 0.85rem; color: #667eea; font-weight: 700; margin-bottom: 0.5rem; letter-spacing: 0.3px;';
            label.textContent = source;
            
            const timeRow = document.createElement('div');
            timeRow.style.cssText = 'display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;';
            
            const timeLabel = document.createElement('span');
            timeLabel.style.cssText = 'font-size: 0.9rem; color: #666; font-weight: 500;';
            timeLabel.textContent = 'å½•éŸ³ä½ç½®ï¼š';
            
            const time = document.createElement('div');
            time.style.cssText = 'font-size: 1.25rem; color: #1d1d1f; font-weight: 800; font-family: "SF Mono", Monaco, monospace; background: white; padding: 0.4rem 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
            time.innerHTML = `<i class="fas fa-clock" style="color: #667eea; font-size: 1rem; margin-right: 0.5rem;"></i>${formatTime(timestampStart)} - ${formatTime(timestampEnd)}`;
            
            const duration = timestampEnd - timestampStart;
            const durationTag = document.createElement('span');
            durationTag.style.cssText = 'font-size: 0.85rem; color: #667eea; background: white; padding: 0.3rem 0.75rem; border-radius: 6px; font-weight: 600;';
            durationTag.textContent = `æ—¶é•¿ ${Math.floor(duration / 60)}:${String(Math.floor(duration % 60)).padStart(2, '0')}`;
            
            timeRow.appendChild(timeLabel);
            timeRow.appendChild(time);
            timeRow.appendChild(durationTag);
            
            const hint = document.createElement('div');
            hint.style.cssText = 'font-size: 0.8rem; color: #888; margin-top: 0.5rem; font-style: italic;';
            hint.innerHTML = '<i class="fas fa-info-circle" style="color: #667eea;"></i> éŸ³é¢‘å°†è‡ªåŠ¨å®šä½åˆ°æ­¤æ—¶é—´æ®µï¼Œæ–¹ä¾¿ç²¾å‡†ç»ƒä¹ ';
            
            textBox.appendChild(label);
            textBox.appendChild(timeRow);
            textBox.appendChild(hint);
            
            timestampCard.appendChild(iconBox);
            timestampCard.appendChild(textBox);
            card.appendChild(timestampCard);
          }
          // æ§ä»¶å®¹å™¨
          const ctrl=document.createElement('div'); ctrl.style.display='flex'; ctrl.style.gap='8px'; ctrl.style.alignItems='center'; ctrl.style.margin='6px 0 4px';
          // å€é€Ÿ
          const rateSel=document.createElement('select'); ['0.75','1','1.25','1.5'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v+'x'; if(v==='1') o.selected=true; rateSel.appendChild(o); });
          // A-B å¾ªç¯æŒ‰é’®
          const btnA=document.createElement('button'); btnA.className='action-btn'; btnA.type='button'; btnA.textContent='æ ‡è®° A';
          const btnB=document.createElement('button'); btnB.className='action-btn'; btnB.type='button'; btnB.textContent='æ ‡è®° B';
          const btnLoop=document.createElement('button'); btnLoop.className='action-btn'; btnLoop.type='button'; btnLoop.textContent='å¾ªç¯ å…³';
          ctrl.appendChild(rateSel); ctrl.appendChild(btnA); ctrl.appendChild(btnB); ctrl.appendChild(btnLoop);
          card.appendChild(ctrl);
          // æ’­æ”¾å™¨
          qa=document.createElement('audio'); 
          qa.className='listening-mini-audio'; 
          qa.controls=true;
          qa.preload='auto';
          // ç§»é™¤crossOriginï¼Œå› ä¸ºjsDelivr CDNå¯èƒ½ä¸æ”¯æŒCORS
          // qa.crossOrigin='anonymous';
          
          // æ·»åŠ é”™è¯¯å¤„ç†
          qa.addEventListener('error', function onError(e) {
            console.error('âŒ éŸ³é¢‘åŠ è½½å¤±è´¥:', audioSrc, e);
            // å°è¯•å›é€€åˆ°set1ï¼ˆå¦‚æœæ˜¯set2æˆ–set3ï¼‰
            const fallbackSrc = audioSrc.replace(/-set[23]\.mp3$/, '-set1.mp3');
            if (fallbackSrc !== audioSrc) {
              console.log('ğŸ”„ å°è¯•å›é€€åˆ°set1:', fallbackSrc);
              qa.removeEventListener('error', onError);
              qa.crossOrigin = null;
              qa.src = fallbackSrc;
              qa.load();
            } else {
              // å¦‚æœå·²ç»æ˜¯set1ï¼Œå°è¯•ä½¿ç”¨ raw.githubusercontent.com
              const rawSrc = audioSrc.replace('cdn.jsdelivr.net/gh/', 'raw.githubusercontent.com/').replace('@main/', 'main/');
              if (rawSrc !== audioSrc) {
                console.log('ğŸ”„ å°è¯•å¤‡ç”¨CDN:', rawSrc);
                qa.removeEventListener('error', onError);
                qa.crossOrigin = null;
                qa.src = rawSrc;
                qa.load();
              }
            }
          }, { once: true });
          
          // æ·»åŠ åŠ è½½æˆåŠŸç›‘å¬
          qa.addEventListener('canplay', () => {
            console.log('âœ… éŸ³é¢‘å°±ç»ªï¼Œå¯ä»¥æ’­æ”¾');
          });
          
          // è®¾ç½®éŸ³é¢‘æºå¹¶æ·»åŠ åˆ°DOM
          qa.src = audioSrc;
          qa.load(); // å¼ºåˆ¶åŠ è½½éŸ³é¢‘
          card.appendChild(qa);
          
          // Sectionæ—¶é—´æ ‡è®°åŒºåŸŸ
          const sectionMarkerArea = document.createElement('div');
          sectionMarkerArea.style.cssText = `
            margin-top: 8px;
            padding: 8px 0;
          `;
          
          // è¿›åº¦æ¡èƒŒæ™¯
          const sectionProgressBg = document.createElement('div');
          sectionProgressBg.style.cssText = `
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            position: relative;
            margin-bottom: 6px;
          `;
          
          // Sectionæ ‡è®°ç‚¹ï¼ˆå››çº§/å…­çº§å¬åŠ›æ ‡å‡†æ—¶é—´åˆ†å¸ƒï¼‰
          const sectionMarkers = [
            { time: 0, label: 'A', color: '#10b981', desc: 'çŸ­ç¯‡æ–°é—»' },
            { time: 0.2, label: 'B', color: '#3b82f6', desc: 'é•¿å¯¹è¯' },
            { time: 0.52, label: 'C', color: '#8b5cf6', desc: 'å¬åŠ›ç¯‡ç« ' }
          ];
          
          sectionMarkers.forEach(m => {
            const marker = document.createElement('div');
            marker.style.cssText = `
              position: absolute;
              left: ${m.time * 100}%;
              top: -5px;
              width: 14px;
              height: 14px;
              background: ${m.color};
              border-radius: 50%;
              border: 2px solid white;
              box-shadow: 0 1px 3px rgba(0,0,0,0.2);
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 9px;
              color: white;
              font-weight: bold;
              z-index: 2;
            `;
            marker.textContent = m.label;
            marker.title = `ç‚¹å‡»è·³è½¬åˆ°${m.desc}`;
            
            // ç‚¹å‡»è·³è½¬
            marker.addEventListener('click', () => {
              if (qa.duration) {
                qa.currentTime = m.time * qa.duration;
                qa.play();
              }
            });
            
            sectionProgressBg.appendChild(marker);
          });
          
          sectionMarkerArea.appendChild(sectionProgressBg);
          
          // æ ‡è®°è¯´æ˜
          const sectionLegend = document.createElement('div');
          sectionLegend.style.cssText = `
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #666;
          `;
          sectionLegend.innerHTML = `
            <span style="color: #10b981;">â— çŸ­ç¯‡æ–°é—»</span>
            <span style="color: #3b82f6;">â— é•¿å¯¹è¯</span>
            <span style="color: #8b5cf6; font-weight: 600;">â— å¬åŠ›ç¯‡ç«  â†</span>
          `;
          sectionMarkerArea.appendChild(sectionLegend);
          
          card.appendChild(sectionMarkerArea);
          
          // é€»è¾‘
          abState={ a:null, b:null, on:false };
          rateSel.addEventListener('change', ()=>{ try{ qa.playbackRate=parseFloat(rateSel.value)||1; }catch(_){} });
          btnA.addEventListener('click', ()=>{ abState.a = qa.currentTime; if (abState.b!=null && abState.b<abState.a) abState.b=null; btnA.textContent='A= '+abState.a.toFixed(1)+'s'; });
          btnB.addEventListener('click', ()=>{ abState.b = qa.currentTime; if (abState.a!=null && abState.b<abState.a){ const t=abState.a; abState.a=abState.b; abState.b=t; } btnB.textContent='B= '+abState.b.toFixed(1)+'s'; });
          btnLoop.addEventListener('click', ()=>{ abState.on = !abState.on; btnLoop.textContent = 'å¾ªç¯ '+(abState.on?'å¼€':'å…³'); });
          // æ—¶é—´æˆ³ç‰‡æ®µæ’­æ”¾é€»è¾‘
          if (hasTimestamp) {
            const start = timestampStart;
            const end = timestampEnd;
            // ç›‘å¬ loadedmetadata äº‹ä»¶ï¼ŒéŸ³é¢‘å…ƒæ•°æ®åŠ è½½å®Œæˆåè®¾ç½®èµ·å§‹ä½ç½®
            qa.addEventListener('loadedmetadata', ()=>{ try{ qa.currentTime = start; }catch(_){} });
            // ç›‘å¬ play äº‹ä»¶ï¼Œæ¯æ¬¡æ’­æ”¾æ—¶é‡ç½®åˆ°èµ·å§‹ä½ç½®ï¼ˆå¦‚æœåœ¨ç‰‡æ®µå¤–ï¼‰
            qa.addEventListener('play', ()=>{ if (qa.currentTime < start || qa.currentTime > end) { try{ qa.currentTime = start; }catch(_){} } });
            // ç›‘å¬ timeupdate äº‹ä»¶ï¼Œåˆ°è¾¾ç»“æŸæ—¶é—´æ—¶æš‚åœ
            qa.addEventListener('timeupdate', ()=>{
              // A-Bå¾ªç¯ä¼˜å…ˆ
              if (abState.on && abState.a!=null && abState.b!=null) {
                if (qa.currentTime > abState.b) { try{ qa.currentTime = abState.a; }catch(_){} }
                return;
              }
              // ç‰‡æ®µé™åˆ¶
              if (qa.currentTime > end) { qa.pause(); try{ qa.currentTime = start; }catch(_){} }
            });
          } else {
            // æ— æ—¶é—´æˆ³ï¼Œä¿ç•™åŸA-Bå¾ªç¯é€»è¾‘
            qa.addEventListener('timeupdate', ()=>{
              if (!abState.on || abState.a==null || abState.b==null) return;
              if (qa.currentTime > abState.b) { try{ qa.currentTime = abState.a; }catch(_){} }
            });
          }
        }
        
        // å¬åŠ›åŸæ–‡æ˜¾ç¤ºï¼ˆæ‰€æœ‰å«å¬åŠ›çš„è¯•å·éƒ½å¯ç”¨ï¼‰
        if (audioSrc) {
          const transcript = it.q?.transcript || it.sectionTranscript || '';
          const hasTranscript = transcript && transcript.trim();
          // å³ä½¿æ²¡æœ‰åŸæ–‡ä¹Ÿæ˜¾ç¤ºæŒ‰é’®åŒºåŸŸï¼ˆæç¤ºæš‚æ— åŸæ–‡ï¼‰
          {
            const readingMode = $('#reading-mode')?.checked || false;
            const transcriptCard = document.createElement('div');
            transcriptCard.style.cssText = `
              background: linear-gradient(135deg, rgba(255, 193, 7, 0.08) 0%, rgba(255, 152, 0, 0.08) 100%);
              padding: 1.5rem;
              border-radius: 14px;
              margin: 1.25rem 0;
              border: 2px solid rgba(255, 193, 7, 0.3);
              box-shadow: 0 2px 8px rgba(255, 193, 7, 0.15);
            `;
            
            const header = document.createElement('div');
            header.style.cssText = `
              display: flex;
              align-items: center;
              gap: 10px;
              margin-bottom: 1rem;
              padding-bottom: 0.75rem;
              border-bottom: 2px solid rgba(255, 193, 7, 0.2);
            `;
            
            const icon = document.createElement('div');
            icon.style.cssText = `
              background: linear-gradient(135deg, #ffd54f 0%, #ffb300 100%);
              color: white;
              width: 36px;
              height: 36px;
              border-radius: 10px;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
              box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
            `;
            icon.innerHTML = '<i class="fas fa-book-reader" style="font-size: 1.1rem;"></i>';
            
            const title = document.createElement('div');
            title.style.cssText = `
              font-size: 1.05rem;
              color: #f57c00;
              font-weight: 700;
              letter-spacing: -0.01em;
              flex: 1;
            `;
            title.innerHTML = '<i class="fas fa-headphones" style="margin-right: 6px;"></i>å¬åŠ›åŸæ–‡';
            
            // æ·»åŠ éšè—/æ˜¾ç¤ºåˆ‡æ¢æŒ‰é’®
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'transcript-toggle-btn';
            toggleBtn.style.cssText = `
              background: #34C759;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 8px;
              font-size: 0.9rem;
              font-weight: 700;
              font-family: 'SimHei', 'Microsoft YaHei', sans-serif;
              cursor: pointer;
              transition: all 0.3s ease;
              display: flex;
              align-items: center;
              gap: 8px;
              box-shadow: 0 2px 8px rgba(52, 199, 89, 0.3);
              position: relative;
              filter: none;
              backdrop-filter: none;
            `;
            toggleBtn.innerHTML = `
              <i class="fas fa-eye" style="font-size: 1rem;"></i>
              <span style="letter-spacing: 0.5px;">æ˜¾ç¤ºåŸæ–‡</span>
            `;
            
            // é»˜è®¤éšè—åŸæ–‡ï¼ˆå¬åŠ›é˜…è¯»æ¨¡å¼ä¸‹é»˜è®¤æ˜¾ç¤ºï¼‰
            let isVisible = readingMode;
            
            header.appendChild(icon);
            header.appendChild(title);
            header.appendChild(toggleBtn);
            
            const textContent = document.createElement('div');
            textContent.style.cssText = `
              color: #2d3436;
              line-height: 1.9;
              font-size: 1rem;
              background: white;
              padding: 1.25rem;
              border-radius: 10px;
              box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
              white-space: pre-wrap;
              font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
              transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
              overflow: hidden;
              max-height: ${isVisible ? '5000px' : '0'};
              opacity: ${isVisible ? '1' : '0'};
            `;
            if (hasTranscript) {
              textContent.textContent = transcript;
            } else {
              // AIè¯­éŸ³è¯†åˆ«ç•Œé¢
              const aiContainer = document.createElement('div');
              aiContainer.style.cssText = 'text-align: center; padding: 1.5rem 1rem;';
              
              const aiIcon = document.createElement('div');
              aiIcon.innerHTML = '<i class="fas fa-robot" style="font-size: 2.5rem; color: #667eea; margin-bottom: 1rem;"></i>';
              
              const aiTitle = document.createElement('div');
              aiTitle.style.cssText = 'font-weight: 600; color: #666; margin-bottom: 0.75rem;';
              aiTitle.textContent = 'åŸæ–‡æš‚æœªå½•å…¥';
              
              const aiDesc = document.createElement('div');
              aiDesc.style.cssText = 'font-size: 0.85rem; color: #888; margin-bottom: 1rem;';
              aiDesc.textContent = 'æ‚¨å¯ä»¥ä½¿ç”¨AIè‡ªåŠ¨è¯†åˆ«å¬åŠ›åŸæ–‡';
              
              const aiBtn = document.createElement('button');
              aiBtn.type = 'button';
              aiBtn.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 10px;
                font-size: 0.95rem;
                font-weight: 700;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                transition: all 0.3s ease;
              `;
              aiBtn.innerHTML = '<i class="fas fa-magic"></i> AIè¯†åˆ«åŸæ–‡';
              
              // AIè¯†åˆ«çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ
              const aiStatus = document.createElement('div');
              aiStatus.style.cssText = 'margin-top: 1rem; display: none;';
              
              // AIè¯†åˆ«ç»“æœæ˜¾ç¤ºåŒºåŸŸ
              const aiResult = document.createElement('div');
              aiResult.style.cssText = `
                margin-top: 1rem;
                padding: 1rem;
                background: #f8f9fa;
                border-radius: 8px;
                text-align: left;
                white-space: pre-wrap;
                line-height: 1.8;
                font-size: 0.95rem;
                color: #333;
                display: none;
                max-height: 400px;
                overflow-y: auto;
              `;
              
              // AIè¯†åˆ«æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨ç¡…åŸºæµåŠ¨(SiliconFlow) APIï¼ˆå·²å†…ç½®å¯†é’¥ï¼Œç”¨æˆ·æ— éœ€æ³¨å†Œï¼‰
              aiBtn.addEventListener('click', async () => {
                if (!audioSrc) {
                  alert('æœªæ‰¾åˆ°éŸ³é¢‘æ–‡ä»¶');
                  return;
                }
                
                // å†…ç½®APIå¯†é’¥ï¼Œç”¨æˆ·æ— éœ€æ³¨å†Œ
                const apiKey = 'sk-zxwcsadwzlqigvrgvxphpavfangpazhbxtlvgkwtapolwndm';
                
                aiBtn.disabled = true;
                aiBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨ä¸Šä¼ éŸ³é¢‘...';
                aiStatus.style.display = 'block';
                aiStatus.innerHTML = `
                  <div style="color: #667eea; font-size: 0.85rem;">
                    <i class="fas fa-cloud-upload-alt"></i> æ­£åœ¨ä¸Šä¼ éŸ³é¢‘åˆ°äº‘ç«¯è¿›è¡Œè¯†åˆ«...
                  </div>
                `;
                
                try {
                  // è·å–éŸ³é¢‘æ–‡ä»¶
                  const audioResponse = await fetch(audioSrc);
                  if (!audioResponse.ok) throw new Error('éŸ³é¢‘æ–‡ä»¶åŠ è½½å¤±è´¥');
                  const audioBlob = await audioResponse.blob();
                  
                  // å‡†å¤‡FormData
                  const formData = new FormData();
                  formData.append('file', audioBlob, 'audio.mp3');
                  formData.append('model', 'FunAudioLLM/SenseVoiceSmall');
                  
                  aiBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AIè¯†åˆ«ä¸­...';
                  aiStatus.innerHTML = `
                    <div style="color: #667eea; font-size: 0.85rem;">
                      <i class="fas fa-robot"></i> ç¡…åŸºæµåŠ¨äº‘ç«¯æ­£åœ¨è¯†åˆ«ï¼Œè¯·ç¨å€™...
                    </div>
                  `;
                  
                  // è°ƒç”¨ç¡…åŸºæµåŠ¨ API
                  const response = await fetch('https://api.siliconflow.cn/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${apiKey}`
                    },
                    body: formData
                  });
                  
                  if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    if (response.status === 401) {
                      throw new Error('APIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
                    }
                    throw new Error(errData.error?.message || `è¯†åˆ«æœåŠ¡æš‚æ—¶ç¹å¿™ï¼Œè¯·ç¨åé‡è¯•`);
                  }
                  
                  const result = await response.json();
                  
                  // æ™ºèƒ½æ ¼å¼åŒ–è¯†åˆ«ç»“æœ
                  function formatTranscript(text) {
                    if (!text) return '';
                    let formatted = text;
                    
                    // 1. åœ¨ä¸»è¦ç« èŠ‚æ ‡è®°å‰æ·»åŠ æ¢è¡Œ
                    formatted = formatted.replace(/(Section [A-C])/gi, '\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nã€$1ã€‘\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
                    formatted = formatted.replace(/(Part\s*\d)/gi, '\n\nâ”â”â” $1 â”â”â”\n');
                    
                    // 2. å¯¹è¯/æ®µè½æ ‡è®°
                    formatted = formatted.replace(/(Conversation\s*\d+)/gi, '\n\nğŸ“ ã€$1ã€‘\n');
                    formatted = formatted.replace(/(Passage\s*\d+)/gi, '\n\nğŸ“ ã€$1ã€‘\n');
                    formatted = formatted.replace(/(News Report\s*\d+)/gi, '\n\nğŸ“° ã€$1ã€‘\n');
                    formatted = formatted.replace(/(Lecture\s*\d+)/gi, '\n\nğŸ“ ã€$1ã€‘\n');
                    
                    // 3. é—®é¢˜æ ‡è®°
                    formatted = formatted.replace(/Question\s*(\d+)/gi, '\n\nâ“ Question $1: ');
                    formatted = formatted.replace(/Questions?\s*(\d+)\s*(to|and|through|-)\s*(\d+)/gi, '\n\nâ“ Questions $1-$3: ');
                    
                    // 4. åœ¨Directionså‰æ·»åŠ æ¢è¡Œ
                    formatted = formatted.replace(/(Directions)/gi, '\n\nğŸ“‹ $1');
                    
                    // 5. è¯´è¯è€…æ ‡è®°ï¼ˆå¸¸è§æ¨¡å¼ï¼‰
                    formatted = formatted.replace(/\b(M:|W:|Man:|Woman:|Speaker\s*\d*:)/gi, '\n$1 ');
                    formatted = formatted.replace(/\b(A:|B:|Host:|Guest:|Interviewer:|Interviewee:)/gi, '\n$1 ');
                    
                    // 6. åœ¨é•¿å¥åæ·»åŠ é€‚å½“æ¢è¡Œï¼ˆå¥å·+å¤§å†™å­—æ¯å¼€å¤´ï¼‰
                    formatted = formatted.replace(/\.(\s*)([A-Z])/g, '.\n$2');
                    
                    // 7. é—®å·å’Œæ„Ÿå¹å·åæ¢è¡Œ
                    formatted = formatted.replace(/\?(\s*)([A-Z])/g, '?\n$2');
                    formatted = formatted.replace(/!(\s*)([A-Z])/g, '!\n$2');
                    
                    // 8. æ¸…ç†å¤šä½™ç©ºè¡Œ
                    formatted = formatted.replace(/\n{3,}/g, '\n\n');
                    formatted = formatted.trim();
                    
                    return formatted;
                  }
                  
                  const formattedText = formatTranscript(result.text);
                  
                  // æ˜¾ç¤ºè¯†åˆ«ç»“æœï¼ˆä½¿ç”¨HTMLä¿ç•™æ ¼å¼ï¼‰
                  aiResult.style.display = 'block';
                  aiResult.innerHTML = formattedText
                    .replace(/\n/g, '<br>')
                    .replace(/ã€(.+?)ã€‘/g, '<strong style="color: #667eea;">ã€$1ã€‘</strong>')
                    .replace(/â“/g, '<span style="color: #f39c12;">â“</span>')
                    .replace(/ğŸ“/g, '<span style="color: #3498db;">ğŸ“</span>')
                    .replace(/ğŸ“°/g, '<span style="color: #e74c3c;">ğŸ“°</span>')
                    .replace(/ğŸ“/g, '<span style="color: #9b59b6;">ğŸ“</span>')
                    .replace(/ğŸ“‹/g, '<span style="color: #1abc9c;">ğŸ“‹</span>')
                    .replace(/â”/g, '<span style="color: #ddd;">â”</span>');
                  
                  if (!formattedText) {
                    aiResult.textContent = 'è¯†åˆ«ç»“æœä¸ºç©º';
                  }
                  
                  // éšè—å¤šä½™çš„UIå…ƒç´ ï¼Œåªä¿ç•™åŸæ–‡
                  aiIcon.style.display = 'none';
                  aiTitle.style.display = 'none';
                  aiDesc.style.display = 'none';
                  aiBtn.style.display = 'none';
                  aiStatus.style.display = 'none';
                  
                  // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä¿å­˜åˆ°å…±äº«ä½ç½®ï¼Œè®©æ‰€æœ‰é¢˜ç›®éƒ½èƒ½è®¿é—®ï¼‰
                  try {
                    // ä¿å­˜å®Œæ•´åŸæ–‡åˆ°å…±äº«ä½ç½®ï¼ˆæŒ‰è¯•å·IDï¼‰
                    const sharedKey = `ai-transcript-shared-${it.examId}`;
                    localStorage.setItem(sharedKey, formattedText);
                    
                    // åŒæ—¶ä¿å­˜åˆ°å½“å‰é¢˜ç›®
                    const cacheKey = `ai-transcript-${it.examId}-${idx}`;
                    localStorage.setItem(cacheKey, formattedText);
                    
                    // å¹¿æ’­äº‹ä»¶ï¼Œé€šçŸ¥æ‰€æœ‰é¢˜ç›®æ›´æ–°åŸæ–‡æ˜¾ç¤º
                    window.dispatchEvent(new CustomEvent('transcriptUpdated', {
                      detail: { examId: it.examId, text: formattedText }
                    }));
                  } catch(_) {}
                  
                } catch (err) {
                  console.error('AIè¯†åˆ«å¤±è´¥:', err);
                  aiBtn.disabled = false;
                  aiBtn.innerHTML = '<i class="fas fa-magic"></i> é‡æ–°è¯†åˆ«';
                  aiStatus.innerHTML = `
                    <div style="color: #dc3545; font-size: 0.85rem;">
                      <i class="fas fa-exclamation-circle"></i> è¯†åˆ«å¤±è´¥ï¼š${err.message || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•'}
                    </div>
                  `;
                }
              });
              
              // æ‚¬åœæ•ˆæœ
              aiBtn.addEventListener('mouseenter', () => {
                if (!aiBtn.disabled) {
                  aiBtn.style.transform = 'translateY(-2px)';
                  aiBtn.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.5)';
                }
              });
              aiBtn.addEventListener('mouseleave', () => {
                aiBtn.style.transform = 'translateY(0)';
                aiBtn.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.4)';
              });
              
              // æ ¼å¼åŒ–å¹¶æ˜¾ç¤ºåŸæ–‡çš„å‡½æ•°ï¼ˆåŒæ—¶éšè—å¤šä½™UIï¼‰
              function displayFormattedText(text, hideUI = true) {
                aiResult.style.display = 'block';
                aiResult.innerHTML = text
                  .replace(/\n/g, '<br>')
                  .replace(/ã€(.+?)ã€‘/g, '<strong style="color: #667eea;">ã€$1ã€‘</strong>')
                  .replace(/â“/g, '<span style="color: #f39c12;">â“</span>')
                  .replace(/ğŸ“/g, '<span style="color: #3498db;">ğŸ“</span>')
                  .replace(/ğŸ“°/g, '<span style="color: #e74c3c;">ğŸ“°</span>')
                  .replace(/ğŸ“/g, '<span style="color: #9b59b6;">ğŸ“</span>')
                  .replace(/ğŸ“‹/g, '<span style="color: #1abc9c;">ğŸ“‹</span>')
                  .replace(/â”/g, '<span style="color: #ddd;">â”</span>');
                
                // éšè—å¤šä½™çš„UIå…ƒç´ ï¼Œåªä¿ç•™åŸæ–‡
                if (hideUI) {
                  aiIcon.style.display = 'none';
                  aiTitle.style.display = 'none';
                  aiDesc.style.display = 'none';
                  aiBtn.style.display = 'none';
                  aiStatus.style.display = 'none';
                }
              }
              
              // æ£€æŸ¥æ˜¯å¦æœ‰ç¼“å­˜çš„è¯†åˆ«ç»“æœï¼ˆä¼˜å…ˆè¯»å–å…±äº«åŸæ–‡ï¼‰
              try {
                const sharedKey = `ai-transcript-shared-${it.examId}`;
                const cacheKey = `ai-transcript-${it.examId}-${idx}`;
                const sharedCached = localStorage.getItem(sharedKey);
                const cached = localStorage.getItem(cacheKey);
                
                if (sharedCached) {
                  displayFormattedText(sharedCached);
                } else if (cached) {
                  displayFormattedText(cached);
                }
              } catch(_) {}
              
              // ç›‘å¬åŸæ–‡æ›´æ–°äº‹ä»¶ï¼ˆå½“å…¶ä»–é¢˜ç›®è¯†åˆ«å®Œæˆæ—¶è‡ªåŠ¨æ›´æ–°ï¼‰
              window.addEventListener('transcriptUpdated', (e) => {
                if (e.detail && e.detail.examId === it.examId && e.detail.text) {
                  displayFormattedText(e.detail.text, true); // éšè—UI
                }
              });
              
              aiContainer.appendChild(aiIcon);
              aiContainer.appendChild(aiTitle);
              aiContainer.appendChild(aiDesc);
              aiContainer.appendChild(aiBtn);
              aiContainer.appendChild(aiStatus);
              aiContainer.appendChild(aiResult);
              textContent.appendChild(aiContainer);
            }
            
            const hint = document.createElement('div');
            hint.style.cssText = `
              margin-top: ${isVisible ? '1rem' : '0'};
              padding: 0.75rem 1rem;
              background: rgba(255, 193, 7, 0.1);
              border-radius: 8px;
              font-size: 0.85rem;
              color: #f57c00;
              font-weight: 600;
              display: flex;
              align-items: center;
              gap: 8px;
              transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
              overflow: hidden;
              max-height: ${isVisible ? '200px' : '0'};
              opacity: ${isVisible ? '1' : '0'};
            `;
            if (hasTranscript) {
              hint.innerHTML = '<i class="fas fa-lightbulb"></i>æç¤ºï¼šè¾¹å¬éŸ³é¢‘è¾¹é˜…è¯»æ–‡æœ¬ï¼Œå¯ä»¥æé«˜å¬è¯»ç»“åˆèƒ½åŠ›ï¼Œæ›´å¥½åœ°ç†è§£å¬åŠ›å†…å®¹';
            } else {
              hint.innerHTML = '<i class="fas fa-bolt"></i>æç¤ºï¼šç‚¹å‡»æŒ‰é’®å³å¯AIè¯†åˆ«å¬åŠ›åŸæ–‡ï¼ˆå…è´¹ä½¿ç”¨ï¼Œæ— éœ€æ³¨å†Œï¼‰';
            }
            
            // æ ¹æ®readingModeè®¾ç½®åˆå§‹æŒ‰é’®çŠ¶æ€
            if (isVisible) {
              toggleBtn.style.background = '#667eea';
              toggleBtn.innerHTML = `
                <i class="fas fa-eye-slash" style="font-size: 1rem;"></i>
                <span style="letter-spacing: 0.5px;">éšè—åŸæ–‡</span>
              `;
              toggleBtn.style.boxShadow = '0 2px 8px rgba(102, 126, 234, 0.3)';
            }
            
            transcriptCard.appendChild(header);
            transcriptCard.appendChild(textContent);
            transcriptCard.appendChild(hint);
            
            // æ·»åŠ åˆ‡æ¢æŒ‰é’®äº‹ä»¶
            toggleBtn.addEventListener('click', () => {
              isVisible = !isVisible;
              if (isVisible) {
                // æ˜¾ç¤º
                textContent.style.maxHeight = '5000px';
                textContent.style.opacity = '1';
                textContent.style.marginBottom = '0';
                hint.style.maxHeight = '200px';
                hint.style.opacity = '1';
                hint.style.marginTop = '1rem';
                toggleBtn.innerHTML = `
                  <i class="fas fa-eye-slash" style="font-size: 1rem;"></i>
                  <span style="letter-spacing: 0.5px;">éšè—åŸæ–‡</span>
                `;
                toggleBtn.style.background = '#667eea';
              } else {
                // éšè—
                textContent.style.maxHeight = '0';
                textContent.style.opacity = '0';
                textContent.style.marginBottom = '0';
                hint.style.maxHeight = '0';
                hint.style.opacity = '0';
                hint.style.marginTop = '0';
                toggleBtn.innerHTML = `
                  <i class="fas fa-eye" style="font-size: 1rem;"></i>
                  <span style="letter-spacing: 0.5px;">æ˜¾ç¤ºåŸæ–‡</span>
                `;
                toggleBtn.style.background = '#34C759';
              }
            });
            
            // æ·»åŠ æ‚¬åœæ•ˆæœ
            toggleBtn.addEventListener('mouseenter', () => {
              toggleBtn.style.transform = 'translateY(-2px)';
              if (isVisible) {
                toggleBtn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
                toggleBtn.style.background = '#5568d3';
              } else {
                toggleBtn.style.boxShadow = '0 4px 12px rgba(52, 199, 89, 0.4)';
                toggleBtn.style.background = '#2eb350';
              }
            });
            
            toggleBtn.addEventListener('mouseleave', () => {
              toggleBtn.style.transform = 'translateY(0)';
              if (isVisible) {
                toggleBtn.style.boxShadow = '0 2px 8px rgba(102, 126, 234, 0.3)';
                toggleBtn.style.background = '#667eea';
              } else {
                toggleBtn.style.boxShadow = '0 2px 8px rgba(52, 199, 89, 0.3)';
                toggleBtn.style.background = '#34C759';
              }
            });
            
            card.appendChild(transcriptCard);
          }
        }
        
        const opts=document.createElement('div'); opts.className='options'; const letters=['A','B','C','D'];
        (it.q.options||[]).forEach((txt,i)=>{
          const lab=document.createElement('label'); lab.className='option'; lab.style.display='block';
          const input=document.createElement('input'); input.type='radio'; input.name=`mq_${idx}`; input.value=letters[i]; input.style.marginRight='8px';
          input.addEventListener('change',()=>{ state.set(idx, input.value); setActive(idx); });
          lab.appendChild(input); const span=document.createElement('span'); span.textContent=`${letters[i]}) ${txt}`; lab.appendChild(span);
          opts.appendChild(lab);
        });
        card.appendChild(opts);
        card.addEventListener('click', ()=> setActive(idx));
        list.appendChild(card);
        cards.push(card);
      });
      quizWrap.appendChild(list);

      const submit=document.createElement('button'); submit.className='action-btn download-btn'; submit.type='button'; submit.style.marginTop='8px'; submit.innerHTML='<i class="fas fa-check"></i> æäº¤å¹¶åˆ¤åˆ†';
      submit.addEventListener('click',()=>{
        stopTiming();
        score(items, state, timeSpent);
      });
      quizWrap.appendChild(submit);

      function setActive(idx){
        const now = Date.now();
        if (activeIdx===null) {
          activeIdx = idx; activeStartTs = now; return;
        }
        if (activeIdx !== idx) {
          const prev = timeSpent.get(activeIdx)||0;
          timeSpent.set(activeIdx, prev + (now - (activeStartTs||quizStart)));
          activeIdx = idx; activeStartTs = now;
        }
      }
      function stopTiming(){
        const now = Date.now();
        if (activeIdx!==null) {
          const prev = timeSpent.get(activeIdx)||0;
          timeSpent.set(activeIdx, prev + (now - (activeStartTs||quizStart)));
        }
      }
    }

    function score(items, state, timeSpent){
      let correct=0; const detail=[];
      items.forEach((it,idx)=>{
        const user = (state.get(idx)||'-').toUpperCase();
        const ok = user === String(it.q.answer||'').toUpperCase();
        if(ok) correct++;
        const t = Math.max(0, (timeSpent?.get(idx)||0));
        detail.push({ idx, examId: it.examId, user, answer: it.q.answer||'', ok, stem: it.q.stem||'', q: it.q, timeMs: t });
      });
      resWrap.innerHTML=''; resWrap.style.display='block';
      const h=document.createElement('h3'); h.textContent=`å¾—åˆ†ï¼š${correct} / ${items.length}`; resWrap.appendChild(h);
      const ul=document.createElement('ul'); ul.style.margin='0 0 0 1.2rem';
      detail.forEach(d=>{ const li=document.createElement('li'); li.textContent = `${d.ok?'âœ…':'âŒ'} ${d.examId} ï½œ ${d.stem} ï½œ ç”¨æ—¶ ${(d.timeMs/1000).toFixed(1)}s`; ul.appendChild(li); });
      resWrap.appendChild(ul);
      // å†™å…¥å†å²å¹¶æ›´æ–°ç”»åƒ
      try { saveHistoryMicro(correct, items.length); } catch(_){}
      try { updateProfileMicro(detail); } catch(_){}
      try { showTimeEfficiencyAdvice(detail); } catch(_){}
      try { showVisualAnalysis(detail, correct, items.length); } catch(_){}
    }

    function saveHistoryMicro(correct, total){
      const key='listening:history';
      let arr=[]; try{ arr=JSON.parse(localStorage.getItem(key)||'[]')}catch(_){ }
      const rec={ id:'micro', title:'è·¨è¯•å·å¾®ç»ƒä¹ ', correct, total, ts: Date.now() };
      arr.unshift(rec);
      try{ localStorage.setItem(key, JSON.stringify(arr.slice(0,20))) }catch(_){ }
    }

    function updateProfileMicro(detail){
      const key='listening:profile';
      let prof={}; try{ prof=JSON.parse(localStorage.getItem(key)||'{}') }catch(_){ }
      prof.skill=prof.skill||{}; prof.topic=prof.topic||{}; prof.error=prof.error||{}; prof.time=prof.time||{}; // time per skill
      detail.forEach(d=>{
        const tags=d.q?.tags||{};
        const skills=Array.isArray(tags.skill)? tags.skill:[];
        const topics=Array.isArray(tags.topic)? tags.topic:[];
        const distract=Array.isArray(tags.distractor)? tags.distractor:[];
        skills.forEach(s=>{ const cur=prof.skill[s]||{right:0,wrong:0}; cur[d.ok?'right':'wrong']++; prof.skill[s]=cur; const tm=prof.time[s]||{ms:0,count:0}; tm.ms += (d.timeMs||0); tm.count += 1; prof.time[s]=tm; });
        topics.forEach(t=>{ const cur=prof.topic[t]||{right:0,wrong:0}; cur[d.ok?'right':'wrong']++; prof.topic[t]=cur; });
        if(!d.ok) distract.forEach(x=>{ prof.error[x]=(prof.error[x]||0)+1; });
      });
      try{ localStorage.setItem(key, JSON.stringify(prof)) }catch(_){ }
    }

    function showTimeEfficiencyAdvice(detail){
      // è®¡ç®—æ¯æŠ€èƒ½å¹³å‡ç”¨æ—¶ä¸æ­£ç¡®ç‡
      const agg = new Map(); // skill -> { ms, n, right }
      detail.forEach(d=>{
        const skills = Array.isArray(d.q?.tags?.skill)? d.q.tags.skill:[];
        skills.forEach(s=>{
          const o = agg.get(s)||{ ms:0, n:0, right:0 };
          o.ms += (d.timeMs||0); o.n += 1; if (d.ok) o.right += 1;
          agg.set(s,o);
        });
      });
      if (agg.size===0) return;
      const rows = Array.from(agg.entries()).map(([k,v])=>({ skill:k, avg:v.ms/Math.max(1,v.n), acc: v.right/Math.max(1,v.n), n:v.n }));
      rows.sort((a,b)=> (b.avg - a.avg) || (a.acc - b.acc));
      const box=document.createElement('div'); box.className='listening-result'; box.style.marginTop='8px';
      const h=document.createElement('h4'); h.style.margin='0 0 6px 0'; h.textContent='æ—¶é—´æ•ˆç‡å»ºè®®'; box.appendChild(h);
      const ul=document.createElement('ul'); ul.style.margin='0 0 0 1.2rem';
      rows.slice(0,3).forEach(r=>{
        const li=document.createElement('li');
        const sec=(r.avg/1000).toFixed(1);
        const acc=Math.round(r.acc*100);
        li.textContent = `${r.skill} ï½œ å¹³å‡ç”¨æ—¶ ${sec}s/é¢˜ ï½œ æ­£ç¡®ç‡ ${acc}% ï½œ å»ºè®®ï¼š` + adviceForSkill(r.skill);
        ul.appendChild(li);
      });
      box.appendChild(ul);
      resWrap.appendChild(box);
    }

    function adviceForSkill(skill){
      switch (skill){
        case 'synonym': return 'é‡ç‚¹ç»ƒåŒä¹‰æ›¿æ¢è¯†åˆ«ï¼šç§¯ç´¯å¸¸è§æ›¿æ¢å¯¹ï¼Œé‡åˆ°é™Œç”Ÿè¡¨è¾¾å…ˆæ‰¾å…³é”®è¯ã€‚';
        case 'number': return 'æ•°å­—/æ—¶é—´ä¼˜å…ˆå®šä½ï¼šå…ˆæ‰«é¢˜å¹²æŠ“æ•°å­—å•ä½ä¸åŒºé—´ï¼Œå¬åˆ°è½¬æŠ˜è¯ç«‹å³å¤æ ¸ã€‚';
        case 'logic': return 'å¼ºåŒ–é€»è¾‘ä¿¡å·è¯ï¼šbut/however/therefore é™„è¿‘å¸¸æ˜¯ç­”æ¡ˆä¸åè½¬ç‚¹ã€‚';
        case 'keyword': return 'å…ˆå…³é”®è¯å†ç»†èŠ‚ï¼šé¢„è¯»é¢˜å¹²å‹¾å…³é”®è¯ï¼Œå¬æ—¶å¿«é€Ÿå®šä½å¯¹åº”å¥æ®µã€‚';
        default: return 'é’ˆå¯¹æœ¬æŠ€èƒ½åš 3-5 é¢˜å¾®ç»ƒä¹ ï¼Œè§‚å¯Ÿç”¨æ—¶æ˜¯å¦ä¸‹é™ã€‚';
      }
    }

    function showVisualAnalysis(detail, correct, total){
      const box = document.createElement('div');
      box.className = 'visual-analysis-container';
      box.style.cssText = 'margin-top: 24px; background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);';
      
      const title = document.createElement('h3');
      title.textContent = 'ğŸ“Š é”™é¢˜å¯è§†åŒ–åˆ†æ';
      title.style.cssText = 'margin: 0 0 20px 0; font-size: 1.4rem; color: #1d1d1f; font-weight: 700;';
      box.appendChild(title);
      
      // 1. æ­£ç¡®ç‡ç¯å½¢å›¾
      const accuracySection = createAccuracyChart(correct, total);
      box.appendChild(accuracySection);
      
      // 2. æ¯é“é¢˜ç”¨æ—¶æŸ±çŠ¶å›¾
      const timeSection = createTimeChart(detail);
      box.appendChild(timeSection);
      
      // 3. æŠ€èƒ½ç‚¹åˆ†æ
      const skillSection = createSkillAnalysis(detail);
      box.appendChild(skillSection);
      
      // 4. é”™é¢˜è¯¦ç»†åˆ†æ
      const errorSection = createErrorAnalysis(detail);
      box.appendChild(errorSection);
      
      resWrap.appendChild(box);
    }

    function createAccuracyChart(correct, total){
      const section = document.createElement('div');
      section.style.cssText = 'margin-bottom: 32px;';
      
      const h = document.createElement('h4');
      h.textContent = 'æ­£ç¡®ç‡ç»Ÿè®¡';
      h.style.cssText = 'margin: 0 0 16px 0; font-size: 1.1rem; color: #1d1d1f; font-weight: 600;';
      section.appendChild(h);
      
      const chartContainer = document.createElement('div');
      chartContainer.style.cssText = 'display: flex; align-items: center; gap: 32px;';
      
      // ç¯å½¢å›¾
      const percentage = Math.round((correct / total) * 100);
      const wrong = total - correct;
      
      const pieChart = document.createElement('div');
      pieChart.style.cssText = 'position: relative; width: 160px; height: 160px;';
      
      const svg = `
        <svg viewBox="0 0 36 36" style="transform: rotate(-90deg);">
          <circle cx="18" cy="18" r="15.91549430918954" fill="transparent" stroke="#f0f0f0" stroke-width="3"/>
          <circle cx="18" cy="18" r="15.91549430918954" fill="transparent" 
                  stroke="${percentage >= 60 ? '#34C759' : percentage >= 40 ? '#FF9500' : '#FF3B30'}" 
                  stroke-width="3" 
                  stroke-dasharray="${percentage} ${100-percentage}"
                  stroke-linecap="round"/>
        </svg>
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
          <div style="font-size: 2rem; font-weight: 700; color: #1d1d1f;">${percentage}%</div>
          <div style="font-size: 0.85rem; color: #6e6e73; margin-top: 4px;">æ­£ç¡®ç‡</div>
        </div>
      `;
      pieChart.innerHTML = svg;
      chartContainer.appendChild(pieChart);
      
      // ç»Ÿè®¡ä¿¡æ¯
      const stats = document.createElement('div');
      stats.style.cssText = 'flex: 1;';
      stats.innerHTML = `
        <div style="margin-bottom: 12px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
            <span style="width: 12px; height: 12px; background: #34C759; border-radius: 2px;"></span>
            <span style="color: #1d1d1f; font-weight: 600;">ç­”å¯¹ï¼š${correct} é¢˜</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="width: 12px; height: 12px; background: #FF3B30; border-radius: 2px;"></span>
            <span style="color: #1d1d1f; font-weight: 600;">ç­”é”™ï¼š${wrong} é¢˜</span>
          </div>
        </div>
        <div style="padding: 12px; background: #f5f5f7; border-radius: 8px; margin-top: 16px;">
          <div style="font-size: 0.9rem; color: #6e6e73;">
            ${percentage >= 80 ? 'ğŸ‰ å¤ªæ£’äº†ï¼ç»§ç»­ä¿æŒï¼' : 
              percentage >= 60 ? 'ğŸ‘ ä¸é”™çš„è¡¨ç°ï¼Œç»§ç»­åŠ æ²¹ï¼' : 
              percentage >= 40 ? 'ğŸ’ª è¿˜æœ‰è¿›æ­¥ç©ºé—´ï¼ŒåŠ æ²¹ï¼' : 
              'ğŸ“š å¤šåŠ ç»ƒä¹ ï¼Œä½ ä¼šæ›´å¥½çš„ï¼'}
          </div>
        </div>
      `;
      chartContainer.appendChild(stats);
      
      section.appendChild(chartContainer);
      return section;
    }

    function createTimeChart(detail){
      const section = document.createElement('div');
      section.style.cssText = 'margin-bottom: 32px;';
      
      const h = document.createElement('h4');
      h.textContent = 'ç­”é¢˜ç”¨æ—¶åˆ†æ';
      h.style.cssText = 'margin: 0 0 16px 0; font-size: 1.1rem; color: #1d1d1f; font-weight: 600;';
      section.appendChild(h);
      
      const maxTime = Math.max(...detail.map(d => d.timeMs));
      const avgTime = detail.reduce((sum, d) => sum + d.timeMs, 0) / detail.length;
      
      const chartContainer = document.createElement('div');
      chartContainer.style.cssText = 'background: #f5f5f7; border-radius: 12px; padding: 16px;';
      
      detail.forEach((d, i) => {
        const bar = document.createElement('div');
        bar.style.cssText = 'margin-bottom: 12px;';
        
        const timeSeconds = (d.timeMs / 1000).toFixed(1);
        const widthPercent = (d.timeMs / maxTime) * 100;
        const color = d.ok ? '#34C759' : '#FF3B30';
        
        bar.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <span style="font-size: 0.85rem; color: #6e6e73; width: 30px;">Q${i+1}</span>
            <span style="font-size: 0.85rem; color: #1d1d1f; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              ${d.stem.substring(0, 30)}...
            </span>
            <span style="font-size: 0.85rem; color: #1d1d1f; font-weight: 600;">${timeSeconds}s</span>
          </div>
          <div style="background: #e5e5e7; height: 8px; border-radius: 4px; overflow: hidden;">
            <div style="background: ${color}; height: 100%; width: ${widthPercent}%; border-radius: 4px; transition: width 0.5s ease;"></div>
          </div>
        `;
        chartContainer.appendChild(bar);
      });
      
      const summary = document.createElement('div');
      summary.style.cssText = 'margin-top: 16px; padding: 12px; background: white; border-radius: 8px; font-size: 0.9rem; color: #6e6e73;';
      summary.innerHTML = `å¹³å‡ç”¨æ—¶ï¼š<strong style="color: #1d1d1f;">${(avgTime/1000).toFixed(1)}s/é¢˜</strong>`;
      chartContainer.appendChild(summary);
      
      section.appendChild(chartContainer);
      return section;
    }

    function createSkillAnalysis(detail){
      const section = document.createElement('div');
      section.style.cssText = 'margin-bottom: 32px;';
      
      const h = document.createElement('h4');
      h.textContent = 'æŠ€èƒ½ç‚¹åˆ†æ';
      h.style.cssText = 'margin: 0 0 16px 0; font-size: 1.1rem; color: #1d1d1f; font-weight: 600;';
      section.appendChild(h);
      
      // ç»Ÿè®¡å„æŠ€èƒ½ç‚¹
      const skillStats = new Map();
      detail.forEach(d => {
        const skills = Array.isArray(d.q?.tags?.skill) ? d.q.tags.skill : [];
        skills.forEach(skill => {
          if (!skillStats.has(skill)) {
            skillStats.set(skill, { correct: 0, total: 0 });
          }
          const stat = skillStats.get(skill);
          stat.total++;
          if (d.ok) stat.correct++;
        });
      });
      
      if (skillStats.size === 0) {
        section.innerHTML += '<p style="color: #6e6e73; font-size: 0.9rem;">æš‚æ— æŠ€èƒ½ç‚¹æ•°æ®</p>';
        return section;
      }
      
      const chartContainer = document.createElement('div');
      chartContainer.style.cssText = 'background: #f5f5f7; border-radius: 12px; padding: 16px;';
      
      const skillNames = {
        'synonym': 'åŒä¹‰æ›¿æ¢',
        'number': 'æ•°å­—ä¿¡æ¯',
        'logic': 'é€»è¾‘æ¨ç†',
        'keyword': 'å…³é”®è¯å®šä½',
        'detail': 'ç»†èŠ‚ç†è§£',
        'advanced conversation': 'å¤æ‚å¯¹è¯'
      };
      
      Array.from(skillStats.entries()).forEach(([skill, stat]) => {
        const accuracy = Math.round((stat.correct / stat.total) * 100);
        const displayName = skillNames[skill] || skill;
        
        const item = document.createElement('div');
        item.style.cssText = 'margin-bottom: 16px;';
        
        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
            <span style="font-size: 0.95rem; color: #1d1d1f; font-weight: 600;">${displayName}</span>
            <span style="font-size: 0.9rem; color: ${accuracy >= 60 ? '#34C759' : accuracy >= 40 ? '#FF9500' : '#FF3B30'}; font-weight: 600;">
              ${stat.correct}/${stat.total} (${accuracy}%)
            </span>
          </div>
          <div style="background: #e5e5e7; height: 8px; border-radius: 4px; overflow: hidden;">
            <div style="background: ${accuracy >= 60 ? '#34C759' : accuracy >= 40 ? '#FF9500' : '#FF3B30'}; 
                        height: 100%; width: ${accuracy}%; border-radius: 4px; transition: width 0.5s ease;"></div>
          </div>
        `;
        chartContainer.appendChild(item);
      });
      
      section.appendChild(chartContainer);
      return section;
    }

    function createErrorAnalysis(detail){
      const section = document.createElement('div');
      section.style.cssText = 'margin-bottom: 0;';
      
      const h = document.createElement('h4');
      h.textContent = 'é”™é¢˜è¯¦ç»†åˆ†æ';
      h.style.cssText = 'margin: 0 0 16px 0; font-size: 1.1rem; color: #1d1d1f; font-weight: 600;';
      section.appendChild(h);
      
      const errors = detail.filter(d => !d.ok);
      
      if (errors.length === 0) {
        const msg = document.createElement('div');
        msg.style.cssText = 'padding: 24px; background: linear-gradient(135deg, #34C759 0%, #30D158 100%); border-radius: 12px; text-align: center; color: white;';
        msg.innerHTML = `
          <div style="font-size: 2.5rem; margin-bottom: 8px;">ğŸ‰</div>
          <div style="font-size: 1.2rem; font-weight: 600; margin-bottom: 4px;">å…¨éƒ¨æ­£ç¡®ï¼</div>
          <div style="font-size: 0.9rem; opacity: 0.9;">å¤ªæ£’äº†ï¼Œç»§ç»­ä¿æŒï¼</div>
        `;
        section.appendChild(msg);
        return section;
      }
      
      const errorContainer = document.createElement('div');
      errorContainer.style.cssText = 'display: flex; flex-direction: column; gap: 12px;';
      
      errors.forEach((e, i) => {
        const errorCard = document.createElement('div');
        errorCard.style.cssText = 'background: #fff5f5; border-left: 4px solid #FF3B30; padding: 16px; border-radius: 8px;';
        
        const skills = Array.isArray(e.q?.tags?.skill) ? e.q.tags.skill : [];
        const skillNames = {
          'synonym': 'åŒä¹‰æ›¿æ¢',
          'number': 'æ•°å­—ä¿¡æ¯',
          'logic': 'é€»è¾‘æ¨ç†',
          'keyword': 'å…³é”®è¯å®šä½',
          'detail': 'ç»†èŠ‚ç†è§£',
          'advanced conversation': 'å¤æ‚å¯¹è¯'
        };
        const skillTags = skills.map(s => skillNames[s] || s).join(', ');
        
        errorCard.innerHTML = `
          <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 8px;">
            <div style="flex: 1;">
              <span style="color: #FF3B30; font-weight: 700; font-size: 0.85rem;">é”™é¢˜ ${i+1}</span>
              <span style="color: #6e6e73; font-size: 0.85rem; margin-left: 8px;">${e.examId}</span>
            </div>
            <div style="font-size: 0.85rem; color: #6e6e73;">ç”¨æ—¶ ${(e.timeMs/1000).toFixed(1)}s</div>
          </div>
          <div style="color: #1d1d1f; font-size: 0.95rem; margin-bottom: 8px; line-height: 1.5;">
            ${e.stem}
          </div>
          <div style="display: flex; gap: 12px; font-size: 0.9rem; margin-bottom: 8px;">
            <div><span style="color: #6e6e73;">ä½ çš„ç­”æ¡ˆï¼š</span><strong style="color: #FF3B30;">${e.user || '-'}</strong></div>
            <div><span style="color: #6e6e73;">æ­£ç¡®ç­”æ¡ˆï¼š</span><strong style="color: #34C759;">${e.answer}</strong></div>
          </div>
          ${skillTags ? `<div style="font-size: 0.85rem; color: #6e6e73;">
            <span>è€ƒæŸ¥æŠ€èƒ½ï¼š</span><strong style="color: #0071e3;">${skillTags}</strong>
          </div>` : ''}
        `;
        errorContainer.appendChild(errorCard);
      });
      
      section.appendChild(errorContainer);
      return section;
    }

    $('#start-btn').addEventListener('click', async()=>{
      try{
        // è·å–åŸå§‹listening.jsonæ•°æ®
        const resp = await fetch('./listening.json', { cache:'no-store' });
        const allData = await resp.json();
        
        const pool = [];
        Object.entries(allData).forEach(([examId,payload])=>{
          (payload.sections||[]).forEach(sec=>{
            const secAudio = sec.audio || '';
            const secStart = sec.audioStart;
            const secEnd = sec.audioEnd;
            const secTranscript = sec.transcript || '';
            (sec.questions||[]).forEach(q=>{
              pool.push({ 
                examId, 
                section: sec.name||'', 
                sectionAudio: secAudio,
                sectionStart: secStart,
                sectionEnd: secEnd,
                sectionTranscript: secTranscript,
                q 
              });
            });
          });
        });
        
        const sel = Array.from($('#skill-select').selectedOptions).map(o=>o.value);
        const n = parseInt($('#count-select').value,10) || 5;
        const examFilter = window._currentExamFilter || null;
        const items = pickBySkills(pool, sel, n, $('#only-tagged')?.checked ?? true, examFilter);
        
        // è·å–å½“å‰è¯•å·çš„å®Œæ•´æ•°æ®ï¼ˆç”¨äºéŸ³é¢‘æ’­æ”¾æ¨¡å¼ï¼‰
        const examData = examFilter ? allData[examFilter] : null;
        
        // æ˜¾ç¤ºé¢˜ç›®æ•°é‡æç¤º
        if (examFilter && items.length > 0) {
          toast(`å·²åŠ è½½è¯•å· ${examFilter} çš„å…¨éƒ¨ ${items.length} é“å¬åŠ›é¢˜`, 'ok');
        } else if (examFilter && items.length === 0 && examData) {
          toast(`è¯•å· ${examFilter} æš‚æ— é¢˜ç›®ï¼Œå·²è¿›å…¥éŸ³é¢‘ç»ƒä¹ æ¨¡å¼`, 'info');
        }
        
        renderQuiz(items, examData);
        window.scrollTo({top: (quizWrap.getBoundingClientRect().top + window.scrollY - 20), behavior:'smooth'});
      }catch(e){ console.error(e); quizWrap.style.display='block'; quizWrap.textContent='åŠ è½½é¢˜åº“å¤±è´¥'; }
    });

    $('#reset-btn').addEventListener('click', ()=>{ quizWrap.style.display='none'; resWrap.style.display='none'; quizWrap.innerHTML=''; resWrap.innerHTML=''; });

    // è§£é™¤è¯•å·é”å®š
    const clearFilterBtn = $('#clear-exam-filter');
    if (clearFilterBtn) {
      clearFilterBtn.addEventListener('click', ()=>{
        window._currentExamFilter = null;
        const notice = $('#exam-filter-notice');
        if (notice) notice.style.display = 'none';
        const badge = $('#preset-badge');
        if (badge) badge.style.display = 'none';
        
        // æ¢å¤æŠ€èƒ½é€‰æ‹©å’Œé¢˜ç›®æ•°é‡å¡ç‰‡
        const skillCard = $('#skill-select')?.closest('div[style*="background: white"]');
        const countCard = $('#count-select')?.closest('div[style*="background: white"]');
        if (skillCard) {
          skillCard.style.opacity = '1';
          skillCard.style.pointerEvents = 'auto';
          skillCard.style.filter = 'none';
          // ç§»é™¤é”å®šæç¤º
          const hint = skillCard.querySelector('div[style*="å®Œæ•´è¯•å·æ¨¡å¼"]');
          if (hint) hint.remove();
        }
        if (countCard) {
          countCard.style.opacity = '1';
          countCard.style.pointerEvents = 'auto';
          countCard.style.filter = 'none';
          // ç§»é™¤é”å®šæç¤º
          const hint = countCard.querySelector('div[style*="æµ‹è¯•å…¨éƒ¨é¢˜ç›®"]');
          if (hint) hint.remove();
        }
        
        // ç§»é™¤URLä¸­çš„examå‚æ•°
        const sp = new URLSearchParams(location.search);
        sp.delete('exam');
        const newUrl = sp.toString() ? `${location.pathname}?${sp.toString()}` : location.pathname;
        history.replaceState(null, '', newUrl);
        toast('å·²è§£é™¤è¯•å·é”å®šï¼Œç°åœ¨å¯ä»¥æŠ½å–æ‰€æœ‰è¯•å·çš„é¢˜ç›®', 'ok');
      });
    }

    // ç›‘å¬å¬åŠ›é˜…è¯»è®­ç»ƒæ¨¡å¼å¤é€‰æ¡†å˜åŒ–ï¼ŒåŠ¨æ€æ˜¾ç¤º/éšè—æç¤º
    const readingModeCheckbox = $('#reading-mode');
    const readingModeHint = $('#reading-mode-hint');
    if (readingModeCheckbox && readingModeHint) {
      readingModeCheckbox.addEventListener('change', () => {
        if (readingModeCheckbox.checked) {
          readingModeHint.style.display = 'block';
          readingModeHint.style.opacity = '1';
          readingModeHint.style.maxHeight = '200px';
        } else {
          readingModeHint.style.opacity = '0';
          readingModeHint.style.maxHeight = '0';
          setTimeout(() => {
            if (!readingModeCheckbox.checked) {
              readingModeHint.style.display = 'none';
            }
          }, 300);
        }
      });
    }

    loadProfileSkills();
    // åº”ç”¨ URL é¢„è®¾å‚æ•°ï¼šskills, count, onlyTagged, exam
    (function applyUrlPresets(){
      try{
        const sp = new URLSearchParams(location.search);
        const skillsParam = sp.get('skills');
        const countParam = sp.get('count');
        const onlyTaggedParam = sp.get('onlyTagged');
        const autoParam = sp.get('auto');
        const examParam = sp.get('exam');
        // ä¿å­˜examå‚æ•°åˆ°å…¨å±€å˜é‡å¹¶æ˜¾ç¤ºæç¤ºå¡ç‰‡
        if (examParam) {
          window._currentExamFilter = examParam;
          // æ˜¾ç¤ºè¯•å·é”å®šæç¤º
          const notice = $('#exam-filter-notice');
          const noticeText = $('#exam-filter-text');
          if (notice && noticeText) {
            notice.style.display = 'block';
            noticeText.textContent = `å½“å‰å·²é”å®šåˆ°è¯•å·ï¼š${examParam}ï¼Œå°†ç›´æ¥æµ‹è¯•è¯¥è¯•å·çš„å…¨éƒ¨å¬åŠ›é¢˜ç›®`;
          }
          // å®Œæ•´è¯•å·æ¨¡å¼ä¸‹ï¼Œéšè—æŠ€èƒ½é€‰æ‹©å’Œé¢˜ç›®æ•°é‡é€‰æ‹©ï¼ˆå› ä¸ºä¼šæµ‹è¯•å…¨éƒ¨é¢˜ç›®ï¼‰
          const skillCard = $('#skill-select')?.closest('div[style*="background: white"]');
          const countCard = $('#count-select')?.closest('div[style*="background: white"]');
          if (skillCard) {
            skillCard.style.opacity = '0.5';
            skillCard.style.pointerEvents = 'none';
            skillCard.style.filter = 'grayscale(0.5)';
            const disableHint = document.createElement('div');
            disableHint.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(6, 182, 212, 0.95); color: white; padding: 12px 20px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.2);';
            disableHint.innerHTML = '<i class="fas fa-lock" style="margin-right: 6px;"></i>å®Œæ•´è¯•å·æ¨¡å¼';
            skillCard.style.position = 'relative';
            skillCard.appendChild(disableHint);
          }
          if (countCard) {
            countCard.style.opacity = '0.5';
            countCard.style.pointerEvents = 'none';
            countCard.style.filter = 'grayscale(0.5)';
            const disableHint = document.createElement('div');
            disableHint.style.cssText = 'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(6, 182, 212, 0.95); color: white; padding: 12px 20px; border-radius: 12px; font-weight: 600; font-size: 0.9rem; z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.2);';
            disableHint.innerHTML = '<i class="fas fa-lock" style="margin-right: 6px;"></i>æµ‹è¯•å…¨éƒ¨é¢˜ç›®';
            countCard.style.position = 'relative';
            countCard.appendChild(disableHint);
          }
        }
        // é¢„è®¾å¾½ç« 
        const hasPresetForBadge = (skillsParam && skillsParam.length>0) || (countParam!=null) || (onlyTaggedParam!=null) || (examParam!=null);
        if (hasPresetForBadge) { 
          const b=$('#preset-badge'); 
          if (b) {
            b.style.display='inline-block'; 
            if (examParam) {
              b.innerHTML = `âœ“ å·²é”å®šè¯•å·ï¼š<strong>${examParam}</strong>`;
              b.style.background = 'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)';
            }
          }
        }
        // åº”ç”¨ count
        if (countParam) {
          const v = String(countParam);
          const sel = $('#count-select');
          if (sel) { const opt = Array.from(sel.options).find(o=>o.value===v); if (opt) sel.value=v; }
        }
        // åº”ç”¨ onlyTagged
        if (onlyTaggedParam!==null) {
          const val = String(onlyTaggedParam).toLowerCase();
          const on = (val==='1'||val==='true'||val==='yes');
          if ($('#only-tagged')) $('#only-tagged').checked = on;
        }
        // åº”ç”¨ skillsï¼ˆéœ€åœ¨é€‰é¡¹åŠ è½½å®Œæˆåï¼‰
        if (skillsParam) {
          const list = skillsParam.split(',').map(s=>s.trim()).filter(Boolean);
          const sel = $('#skill-select');
          if (sel) {
            // è‹¥ option ä¸å­˜åœ¨åˆ™åˆ›å»ºåé€‰ä¸­
            const existing = new Set(Array.from(sel.options).map(o=>o.value));
            list.forEach(k=>{
              if (!existing.has(k)) { const o=document.createElement('option'); o.value=k; o.textContent=k; sel.appendChild(o); }
            });
            Array.from(sel.options).forEach(o=>{ o.selected = list.includes(o.value); });
          }
        }
        // è‡ªåŠ¨å¼€å§‹ï¼šæœ‰ä»»æ„é¢„è®¾æˆ– auto å‚æ•°
        const hasPreset = (skillsParam && skillsParam.length>0) || (countParam!=null) || (onlyTaggedParam!=null) || (examParam!=null);
        const shouldAuto = hasPreset || (autoParam && ['1','true','yes'].includes(String(autoParam).toLowerCase()));
        if (shouldAuto) {
          setTimeout(()=>{ try{ $('#start-btn')?.click(); }catch(_){ } }, 60);
        }
      }catch(_){ }
    })();

    // ç”Ÿæˆå½“å‰å‚æ•°é“¾æ¥
    function currentShareUrl(){
      const selSkills = Array.from($('#skill-select').selectedOptions).map(o=>o.value).join(',');
      const count = $('#count-select')?.value || '';
      const onlyTagged = ($('#only-tagged')?.checked ? 'true':'false');
      const sp = new URLSearchParams();
      if (selSkills) sp.set('skills', selSkills);
      if (count) sp.set('count', count);
      sp.set('onlyTagged', onlyTagged);
      sp.set('auto','1');
      return `${location.origin}${location.pathname}?${sp.toString()}`;
    }
    function pushUrlFromControls(){ try{ history.replaceState(null,'', currentShareUrl()); }catch(_){ } }
    $('#share-btn').addEventListener('click', ()=>{
      const url = currentShareUrl();
      navigator.clipboard?.writeText(url).then(()=> toast('å·²å¤åˆ¶åˆ†äº«é“¾æ¥', 'ok')).catch(()=>{ try{ prompt('å¤åˆ¶æ­¤é“¾æ¥', url); }catch(_){ } });
    });
    // æ§ä»¶å˜åŒ–å³æ›´æ–° URL
    ['change','input'].forEach(ev=>{
      $('#count-select')?.addEventListener(ev, pushUrlFromControls);
      $('#only-tagged')?.addEventListener(ev, pushUrlFromControls);
      $('#skill-select')?.addEventListener(ev, pushUrlFromControls);
    });
  </script>
  
  <!-- ç®€æ´é¡µè„š -->
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-section">
        <h4>å››å…­çº§å­¦ä¹ ç«™</h4>
        <p>å…è´¹å¼€æ”¾çš„å››å…­çº§çœŸé¢˜å¬åŠ›èµ„æºå…±äº«ç«™</p>
      </div>
      <div class="footer-section footer-section-links">
        <h4>å¿«é€Ÿé“¾æ¥</h4>
        <ul class="footer-links">
          <li><a href="index.html">é¦–é¡µ</a></li>
          <li><a href="cet4.html">å››çº§çœŸé¢˜</a></li>
          <li><a href="cet6.html">å…­çº§çœŸé¢˜</a></li>
          <li><a href="translator.html">é˜…è¯»ç¥å™¨</a></li>
          <li><a href="listening-micro.html">å¬åŠ›å¾®ç»ƒä¹ </a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>å…³äº</h4>
        <ul class="footer-links">
          <li><a href="news.html">è€ƒè¯•èµ„è®¯</a></li>
          <li><a href="#">å…³äºæœ¬ç«™</a></li>
          <li><a href="#">è”ç³»æˆ‘ä»¬</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; 2025 All Rights Reserved</p>
      <p style="margin-top: 0.5rem;">æœ¬ç«™ä»…ç”¨äºå­¦ä¹ äº¤æµï¼ŒçœŸé¢˜ç‰ˆæƒå½’åŸç‰ˆæƒæ‰€æœ‰è€…æ‰€æœ‰ã€‚</p>
    </div>
  </footer>
</body>
</html>
