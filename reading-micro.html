<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¬åŠ›å¾®ç»ƒä¹  - å››å…­çº§å­¦ä¹ ç«™</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* è‹¹æœé£æ ¼é…è‰² */
    :root {
      --color-bg: #f5f5f7;
      --color-bg-light: #ffffff;
      --color-primary: #0071e3;
      --color-primary-hover: #0077ED;
      --color-secondary: #06c;
      --color-card: #ffffff;
      --color-text-dark: #1d1d1f;
      --color-text-light: #6e6e73;
    }
    
    body {
      background: var(--color-bg) !important;
    }
    
    .page-content {
      background: var(--color-bg);
    }
    
    .question-card {
      background: var(--color-card);
      border-radius: 18px;
      padding: 28px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      transition: all 0.3s cubic-bezier(0.28, 0.11, 0.32, 1);
      border: 1px solid rgba(0,0,0,0.08);
    }
    
    .question-card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
      border-color: rgba(0,0,0,0.12);
    }
    
    .option {
      background: #f5f5f7;
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 14px 18px;
      margin: 8px 0;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.95rem;
    }
    
    .option:hover {
      background: #e8e8ed;
      border-color: var(--color-primary);
    }
    
    .option.selected {
      background: #d1e7ff;
      border-color: var(--color-primary);
      font-weight: 600;
    }
    
    .option.correct {
      background: #d4edda;
      border-color: #28a745;
      color: #155724;
    }
    
    .option.wrong {
      background: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
    }
    
    .btn {
      transition: all 0.3s ease;
      border-radius: 980px;
      border: none;
      font-weight: 600;
      letter-spacing: -0.01em;
      padding: 14px 32px;
      font-size: 1rem;
      cursor: pointer;
    }
    
    .btn:hover {
      transform: scale(1.02);
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <!-- é¡µé¢æ»šåŠ¨è¿›åº¦æ¡ -->
  <div class="scroll-progress" id="scroll-progress"></div>
  
  <!-- ç®€æ´å¯¼èˆªæ  -->
  <nav class="apple-nav wehuster-nav">
    <div class="nav-container">
      <a class="nav-logo wehuster-logo" href="index.html">
        <i class="fas fa-graduation-cap"></i>
        <span class="logo-text">å››å…­çº§å­¦ä¹ ç«™</span>
      </a>
      
      <ul class="nav-menu wehuster-menu">
        <li class="nav-item"><a href="index.html" class="nav-link">é¦–é¡µ</a></li>
        <li class="nav-item"><a href="cet4.html" class="nav-link">å››çº§çœŸé¢˜</a></li>
        <li class="nav-item"><a href="cet6.html" class="nav-link">å…­çº§çœŸé¢˜</a></li>
        <li class="nav-item"><a href="translator.html" class="nav-link">é˜…è¯»ç¥å™¨</a></li>
        <li class="nav-item"><a href="listening-micro.html" class="nav-link listening-highlight" style="background: white; color: #667eea !important; border-radius: 10px; padding: 10px 20px; font-weight: 700; box-shadow: 0 4px 12px rgba(255, 255, 255, 0.4); border: 2px solid rgba(255, 255, 255, 0.8); position: relative; transition: all 0.3s ease; animation: pulse 2s ease-in-out infinite;" onmouseover="this.style.transform='translateY(-2px) scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(255, 255, 255, 0.6)';" onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(255, 255, 255, 0.4)';"><span style="font-size: 1.1em;">ğŸ§</span> å¬åŠ›ç»ƒä¹  <span style="font-size: 0.7em; background: linear-gradient(135deg, #ff6b6b, #feca57); color: white; padding: 2px 6px; border-radius: 10px; margin-left: 4px; font-weight: 800;">HOT</span></a></li>
        <style>
          @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 12px rgba(255, 255, 255, 0.4); }
            50% { box-shadow: 0 4px 16px rgba(255, 255, 255, 0.7); }
          }
        </style>
        <li class="nav-item"><a href="reading-micro.html" class="nav-link active">å¬åŠ›å¾®ç»ƒä¹ </a></li>
        <li class="nav-item"><a href="news.html" class="nav-link">èµ„è®¯</a></li>
        <li class="nav-item"><a href="about.html" class="nav-link">About Us</a></li>
      </ul>
      
      <div class="nav-tools">
        <button class="search-btn" id="search-toggle" aria-label="æœç´¢">
          <i class="fas fa-search"></i>
        </button>
        <button class="mobile-toggle" id="mobile-toggle" aria-label="èœå•">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </div>
  </nav>
  
  <div class="page-content">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div style="text-align: center; margin-bottom: 3rem; animation: fadeInDown 0.6s ease-out;">
      <div style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.25rem 2.5rem; border-radius: 24px; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4), 0 2px 8px rgba(0, 0, 0, 0.1); margin-bottom: 1.25rem; position: relative; overflow: hidden; transition: all 0.4s ease;">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%); pointer-events: none;"></div>
        <h1 style="color: white; margin: 0; font-weight: 800; font-size: 2.2rem; letter-spacing: -0.02em; position: relative; z-index: 1; text-shadow: 0 2px 8px rgba(0,0,0,0.15); text-align: center;">ğŸ§ å¬åŠ›å¾®ç»ƒä¹ </h1>
      </div>
      <p style="color: #6c757d; font-size: 1.1rem; margin: 0; font-weight: 500; letter-spacing: 0.5px;"><span style="color: #667eea; font-weight: 600;">çœŸé¢˜éŸ³é¢‘</span> Â· <span style="color: #764ba2; font-weight: 600;">æ™ºèƒ½ç»ƒä¹ </span> Â· <span style="color: #667eea; font-weight: 600;">é”™é¢˜åˆ†æ</span></p>
    </div>

    <!-- ä½¿ç”¨è¯´æ˜ -->
    <div style="background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%); border-left: 5px solid #0ea5e9; border-radius: 16px; padding: 24px 28px; margin-bottom: 2rem; box-shadow: 0 8px 24px rgba(14, 165, 233, 0.15); animation: fadeInUp 0.6s ease-out;">
      <div style="display: flex; align-items: start; gap: 16px;">
        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 6px 20px rgba(14, 165, 233, 0.35);">
          <i class="fas fa-info-circle" style="color: white; font-size: 1.6rem; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));"></i>
        </div>
        <div style="flex: 1;">
          <h3 style="margin: 0 0 12px 0; color: #075985; font-size: 1.25rem; font-weight: 700;">ğŸ’¡ åŠŸèƒ½è¯´æ˜</h3>
          <p style="margin: 0; color: #0c4a6e; line-height: 1.8; font-size: 0.95rem;">
            <strong>å¬åŠ›å¾®ç»ƒä¹ </strong>æä¾›çœŸé¢˜éŸ³é¢‘å’Œé¢˜ç›®ï¼Œæ”¯æŒ<strong>ABå¾ªç¯</strong>ã€<strong>å€é€Ÿæ’­æ”¾</strong>åŠŸèƒ½ã€‚
            å®Œæˆç»ƒä¹ åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨<strong>ç»Ÿè®¡é”™é¢˜</strong>ï¼Œå¹¶å°†æ•°æ®åŒæ­¥åˆ°<a href="listening-micro.html" style="color: #0ea5e9; font-weight: 600; text-decoration: none;">å¬åŠ›æµ‹è¯•</a>æ¿å—ï¼<br>
            <strong style="color: #0369a1;">âš ï¸ æ³¨æ„ï¼š</strong>å››çº§å’Œå…­çº§é¢˜å‹ä¸åŒï¼Œ<strong>å››çº§</strong>æœ‰æ–°é—»æŠ¥é“ï¼Œ<strong>å…­çº§</strong>æœ‰è®²åº§ã€‚éƒ¨åˆ†è¯•å·é¢˜ç›®æ•°æ®å¯èƒ½ä¸å®Œæ•´ã€‚
          </p>
        </div>
      </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div style="background: linear-gradient(to bottom, #ffffff 0%, #f8f9ff 100%); border-radius: 24px; padding: 2.5rem; margin-bottom: 2.5rem; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.15), 0 4px 12px rgba(0, 0, 0, 0.08); border: 1px solid rgba(102, 126, 234, 0.1); animation: fadeInUp 0.6s ease-out 0.1s both;">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
        <!-- é¢˜ç›®æ•°é‡ -->
        <div style="background: white; border-radius: 20px; padding: 1.5rem; border: 2px solid rgba(79, 172, 254, 0.15); box-shadow: 0 4px 16px rgba(79, 172, 254, 0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 1rem;">
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(79, 172, 254, 0.35);">
              <i class="fas fa-hashtag" style="color: white; font-size: 1.3rem;"></i>
            </div>
            <div>
              <h3 style="margin: 0; font-size: 1.05rem; color: #2d3436; font-weight: 700;">é¢˜ç›®æ•°é‡</h3>
              <p style="margin: 0; font-size: 0.85rem; color: #74798d;">é€‰æ‹©å¬åŠ›é¢˜æ•°</p>
            </div>
          </div>
          <select id="count-select" style="width: 100%; padding: 12px 16px; font-size: 1rem; border: 2px solid #e3e8f0; border-radius: 12px; background: #f8f9ff; color: #2d3436; font-weight: 700; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#4facfe'; this.style.background='white';" onmouseout="this.style.borderColor='#e3e8f0'; this.style.background='#f8f9ff';">
            <option value="5" style="font-weight: 700; color: #2d3436;">5 é“ï¼ˆå¿«é€Ÿç»ƒä¹ ï¼‰</option>
            <option value="10" style="font-weight: 700; color: #2d3436;">10 é“ï¼ˆæ¨èï¼‰</option>
            <option value="15" style="font-weight: 700; color: #2d3436;">15 é“ï¼ˆæ·±åº¦è®­ç»ƒï¼‰</option>
            <option value="20" style="font-weight: 700; color: #2d3436;">20 é“ï¼ˆå®Œæ•´æµ‹è¯•ï¼‰</option>
          </select>
        </div>

        <!-- é¢˜å‹é€‰æ‹© -->
        <div style="background: white; border-radius: 20px; padding: 1.5rem; border: 2px solid rgba(255, 159, 67, 0.15); box-shadow: 0 4px 16px rgba(255, 159, 67, 0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 1rem;">
            <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(250, 112, 154, 0.35);">
              <i class="fas fa-layer-group" style="color: white; font-size: 1.3rem;"></i>
            </div>
            <div>
              <h3 style="margin: 0; font-size: 1.05rem; color: #2d3436; font-weight: 700;">å¬åŠ›ç±»å‹</h3>
              <p style="margin: 0; font-size: 0.85rem; color: #74798d;">é€‰æ‹©éƒ¨åˆ†</p>
            </div>
          </div>
          <select id="type-select" style="width: 100%; padding: 12px 16px; font-size: 1rem; border: 2px solid #e3e8f0; border-radius: 12px; background: #f8f9ff; color: #2d3436; font-weight: 700; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#fa709a'; this.style.background='white';" onmouseout="this.style.borderColor='#e3e8f0'; this.style.background='#f8f9ff';">
            <option value="all" style="font-weight: 700; color: #2d3436;">å…¨éƒ¨</option>
            <option value="Long Conversations" style="font-weight: 700; color: #2d3436;">é•¿å¯¹è¯</option>
            <option value="Passages" style="font-weight: 700; color: #2d3436;">çŸ­æ–‡</option>
            <option value="Lectures" style="font-weight: 700; color: #2d3436;">è®²åº§ï¼ˆå…­çº§ï¼‰</option>
            <option value="News Reports" style="font-weight: 700; color: #2d3436;">æ–°é—»æŠ¥é“ï¼ˆå››çº§ï¼‰</option>
          </select>
        </div>

        <!-- éš¾åº¦é€‰æ‹© -->
        <div style="background: white; border-radius: 20px; padding: 1.5rem; border: 2px solid rgba(52, 199, 89, 0.15); box-shadow: 0 4px 16px rgba(52, 199, 89, 0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 1rem;">
            <div style="background: linear-gradient(135deg, #34c759 0%, #30d158 100%); width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 20px rgba(52, 199, 89, 0.35);">
              <i class="fas fa-signal" style="color: white; font-size: 1.3rem;"></i>
            </div>
            <div>
              <h3 style="margin: 0; font-size: 1.05rem; color: #2d3436; font-weight: 700;">è€ƒè¯•ç±»å‹</h3>
              <p style="margin: 0; font-size: 0.85rem; color: #74798d;">å››çº§/å…­çº§</p>
            </div>
          </div>
          <select id="level-select" style="width: 100%; padding: 12px 16px; font-size: 1rem; border: 2px solid #e3e8f0; border-radius: 12px; background: #f8f9ff; color: #2d3436; font-weight: 700; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.borderColor='#34c759'; this.style.background='white';" onmouseout="this.style.borderColor='#e3e8f0'; this.style.background='#f8f9ff';">
            <option value="all" style="font-weight: 700; color: #2d3436;">ä¸é™</option>
            <option value="CET6" selected style="font-weight: 700; color: #2d3436;">å…­çº§ï¼ˆæ¨èï¼‰</option>
            <option value="CET4" style="font-weight: 700; color: #2d3436;">å››çº§ï¼ˆæ•°æ®å°‘ï¼‰</option>
          </select>
        </div>
      </div>

      <!-- å¼€å§‹æŒ‰é’® -->
      <div style="text-align: center;">
        <button id="start-btn" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4); font-size: 1.1rem; padding: 16px 48px;">
          <i class="fas fa-play-circle"></i> å¼€å§‹ç»ƒä¹ 
        </button>
      </div>
    </div>

    <!-- é¢˜ç›®åŒºåŸŸ -->
    <div id="questions-area" style="display: none;"></div>

    <!-- ç»“æœåŒºåŸŸ -->
    <div id="result-area" style="display: none;"></div>
  </div>

  <script>
    // æ»šåŠ¨è¿›åº¦æ¡
    window.addEventListener('scroll', () => {
      const scrolled = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
      document.getElementById('scroll-progress').style.width = scrolled + '%';
    });

    // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
    document.getElementById('mobile-toggle')?.addEventListener('click', function() {
      document.querySelector('.nav-menu').classList.toggle('active');
      this.classList.toggle('active');
    });

    // é¢˜åº“æ•°æ®
    let allQuestions = [];
    let currentQuestions = [];
    let userAnswers = [];
    let currentAudio = null;

    // åŠ è½½å¬åŠ›é¢˜ç›®æ•°æ®
    async function loadQuestions() {
      try {
        console.log('ğŸ”„ å¼€å§‹åŠ è½½ listening.json...');
        const resp = await fetch('./listening.json');
        
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        }
        
        const listeningData = await resp.json();
        console.log(`âœ… JSON åŠ è½½æˆåŠŸï¼Œè¯•å·æ•°é‡: ${Object.keys(listeningData).length}`);
        
        // æå–æ‰€æœ‰å¬åŠ›é¢˜ç›®
        allQuestions = [];
        let examCount = 0;
        let sectionCount = 0;
        
        Object.entries(listeningData).forEach(([examId, exam]) => {
          examCount++;
          if (exam.sections) {
            exam.sections.forEach(section => {
              sectionCount++;
              // åªå¤„ç†æœ‰é¢˜ç›®çš„section
              if (section.questions && section.questions.length > 0) {
                section.questions.forEach(q => {
                  allQuestions.push({
                    ...q,
                    examId,
                    sectionName: section.name || '',
                    audio: section.audio || '',
                    audioStart: section.audioStart || 0,
                    audioEnd: section.audioEnd || 0
                  });
                });
              }
            });
          }
        });
        
        console.log(`âœ… æ•°æ®åŠ è½½å®Œæˆ:`);
        console.log(`   - è¯•å·æ•°: ${examCount}`);
        console.log(`   - ç« èŠ‚æ•°: ${sectionCount}`);
        console.log(`   - é¢˜ç›®æ•°: ${allQuestions.length}`);
        
        if (allQuestions.length > 0) {
          console.log(`   - ç¤ºä¾‹é¢˜ç›®:`, {
            examId: allQuestions[0].examId,
            sectionName: allQuestions[0].sectionName,
            stem: allQuestions[0].stem?.substring(0, 50) + '...'
          });
        }
      } catch (err) {
        console.error('âŒ åŠ è½½é¢˜ç›®å¤±è´¥:', err);
        alert(`é¢˜ç›®åŠ è½½å¤±è´¥: ${err.message}\nè¯·æ£€æŸ¥ listening.json æ–‡ä»¶æ˜¯å¦å­˜åœ¨`);
      }
    }

    // ç­›é€‰é¢˜ç›®
    function filterQuestions(count, type, level) {
      console.log(`ç­›é€‰æ¡ä»¶: æ•°é‡=${count}, ç±»å‹=${type}, çº§åˆ«=${level}`);
      console.log(`é¢˜åº“æ€»æ•°: ${allQuestions.length}`);
      
      let filtered = [...allQuestions];
      
      // æŒ‰å¬åŠ›ç±»å‹ç­›é€‰
      if (type !== 'all') {
        filtered = filtered.filter(q => {
          const match = q.sectionName?.includes(type);
          if (!match && filtered.length < 5) {
            console.log(`ç±»å‹ä¸åŒ¹é…: "${q.sectionName}" ä¸åŒ…å« "${type}"`);
          }
          return match;
        });
        console.log(`ç±»å‹ç­›é€‰å: ${filtered.length} é“é¢˜`);
      }
      
      // æŒ‰è€ƒè¯•ç±»å‹ç­›é€‰ï¼ˆå››çº§/å…­çº§ï¼‰
      if (level !== 'all') {
        filtered = filtered.filter(q => {
          const match = q.examId?.toUpperCase().includes(level);
          if (!match && filtered.length < 5) {
            console.log(`çº§åˆ«ä¸åŒ¹é…: "${q.examId}" ä¸åŒ…å« "${level}"`);
          }
          return match;
        });
        console.log(`çº§åˆ«ç­›é€‰å: ${filtered.length} é“é¢˜`);
      }
      
      // éšæœºæŠ½å–
      const shuffled = filtered.sort(() => 0.5 - Math.random());
      const result = shuffled.slice(0, parseInt(count));
      console.log(`æœ€ç»ˆæŠ½å–: ${result.length} é“é¢˜`);
      return result;
    }

    // æ¸²æŸ“é¢˜ç›®
    function renderQuestions(questions) {
      const area = document.getElementById('questions-area');
      area.style.display = 'block';
      area.innerHTML = '';
      
      // è·å–å”¯ä¸€çš„éŸ³é¢‘æ–‡ä»¶å’Œä¸åŒçš„sectionä¿¡æ¯
      const audioUrl = questions[0]?.audio;
      
      // æ”¶é›†æ‰€æœ‰ä¸åŒçš„sectionä¿¡æ¯ï¼ˆå»é‡ï¼‰
      const sectionsMap = new Map();
      questions.forEach(q => {
        const key = `${q.sectionName}-${q.audioStart}`;
        if (!sectionsMap.has(key)) {
          sectionsMap.set(key, {
            name: q.sectionName,
            start: q.audioStart,
            end: q.audioEnd,
            firstQuestionIndex: questions.indexOf(q)
          });
        }
      });
      const sections = Array.from(sectionsMap.values()).sort((a, b) => a.start - b.start);
      
      // éŸ³é¢‘æ’­æ”¾å™¨
      if (audioUrl) {
        const audioPlayer = document.createElement('div');
        audioPlayer.style.cssText = `
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 16px;
          padding: 24px;
          margin-bottom: 24px;
          color: white;
          box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        `;
        // è®¡ç®—éŸ³é¢‘æ€»æ—¶é•¿ï¼ˆä»æœ€åä¸€ä¸ªsectionçš„ç»“æŸæ—¶é—´ï¼‰
        const totalDuration = sections.length > 0 ? Math.max(...sections.map(s => s.end)) : 0;
        
        audioPlayer.innerHTML = `
          <h3 style="margin: 0 0 16px 0; font-size: 1.3rem; font-weight: 700;">ğŸ§ å¬åŠ›éŸ³é¢‘</h3>
          <audio id="listening-audio" controls style="width: 100%; border-radius: 12px; margin-bottom: 0;" preload="auto">
            <source src="${audioUrl}" type="audio/mpeg">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
          </audio>
          
          <!-- è¿›åº¦æ¡æ—¶é—´è½´æ ‡è®° -->
          <div id="timeline-markers" style="position: relative; width: 100%; height: 40px; margin: 8px 0 12px 0;">
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px;"></div>
            ${sections.map((section, idx) => {
              const colors = ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ec4899'];
              const color = colors[idx % colors.length];
              const percentage = totalDuration > 0 ? (section.start / totalDuration) * 100 : 0;
              
              const sectionIcon = section.name.includes('Long Conversations') ? 'ğŸ’¬' : 
                                 section.name.includes('Passages') ? 'ğŸ“–' : 
                                 section.name.includes('Lectures') ? 'ğŸ“' : 
                                 section.name.includes('News Reports') ? 'ğŸ“°' : 'ğŸ§';
              
              const sectionLabel = section.name.includes('Long Conversations') ? 'é•¿å¯¹è¯' : 
                                  section.name.includes('Passages') ? 'çŸ­æ–‡' : 
                                  section.name.includes('Lectures') ? 'è®²åº§' : 
                                  section.name.includes('News Reports') ? 'æ–°é—»' : section.name;
              
              return `
                <div 
                  class="timeline-marker" 
                  style="
                    position: absolute;
                    left: ${percentage}%;
                    top: -2px;
                    transform: translateX(-50%);
                    cursor: pointer;
                  "
                  onclick="jumpToSegment(${section.start}, ${section.firstQuestionIndex})"
                  onmouseover="this.querySelector('.marker-label').style.display='block';"
                  onmouseout="this.querySelector('.marker-label').style.display='none';"
                >
                  <div style="
                    width: 8px;
                    height: 8px;
                    background: ${color};
                    border: 2px solid white;
                    border-radius: 50%;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    transition: all 0.2s;
                  "></div>
                  <div class="marker-label" style="
                    display: none;
                    position: absolute;
                    top: 18px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: rgba(0,0,0,0.85);
                    color: white;
                    padding: 6px 12px;
                    border-radius: 8px;
                    font-size: 0.8rem;
                    font-weight: 600;
                    white-space: nowrap;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
                    z-index: 10;
                  ">
                    ${sectionIcon} ${sectionLabel}
                  </div>
                  <div style="
                    position: absolute;
                    left: 50%;
                    top: 12px;
                    transform: translateX(-50%);
                    color: ${color};
                    font-size: 0.75rem;
                    font-weight: 700;
                    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
                    white-space: nowrap;
                  ">${sectionIcon}</div>
                </div>
              `;
            }).join('')}
          </div>
          
          <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px;">
            <button onclick="setPlaybackRate(0.75)" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.3);">0.75x</button>
            <button onclick="setPlaybackRate(1)" class="btn" style="background: rgba(255,255,255,0.3); color: white; padding: 8px 16px; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.4);">1.0x</button>
            <button onclick="setPlaybackRate(1.25)" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.3);">1.25x</button>
            <button onclick="setPlaybackRate(1.5)" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.3);">1.5x</button>
            <button onclick="toggleLoop()" id="loop-btn" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 8px 16px; font-size: 0.9rem; border: 1px solid rgba(255,255,255,0.3);">ğŸ” ABå¾ªç¯</button>
          </div>
        `;
        area.appendChild(audioPlayer);
        
        currentAudio = document.getElementById('listening-audio');
        
        // æ·»åŠ å¿«é€Ÿè·³è½¬åŠŸèƒ½åŒºï¼ˆå‚è€ƒBç«™è®¾è®¡ï¼‰
        if (sections.length >= 1) {
          const segmentBar = document.createElement('div');
          segmentBar.style.cssText = `
            background: rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 20px 24px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
          `;
          
          let segmentHTML = `
            <div style="
              display: flex;
              align-items: center;
              gap: 8px;
              margin-bottom: 14px;
            ">
              <div style="
                width: 4px;
                height: 20px;
                background: linear-gradient(180deg, #ff6b9d 0%, #ffa06b 100%);
                border-radius: 2px;
              "></div>
              <span style="
                font-size: 1rem;
                font-weight: 700;
                color: white;
                letter-spacing: 0.5px;
              ">å¿«é€Ÿè·³è½¬</span>
            </div>
          `;
          
          segmentHTML += '<div style="display: flex; gap: 12px; flex-wrap: wrap;">';
          
          sections.forEach((section, idx) => {
            const sectionIcon = section.name.includes('Long Conversations') ? 'ğŸ’¬' : 
                               section.name.includes('Passages') ? 'ğŸ“–' : 
                               section.name.includes('Lectures') ? 'ğŸ“' : 
                               section.name.includes('News Reports') ? 'ğŸ“°' : 'ğŸ§';
            
            const sectionLabel = section.name.includes('Long Conversations') ? 'é•¿å¯¹è¯' : 
                                section.name.includes('Passages') ? 'çŸ­æ–‡' : 
                                section.name.includes('Lectures') ? 'è®²åº§' : 
                                section.name.includes('News Reports') ? 'æ–°é—»' : section.name;
            
            segmentHTML += `
              <button 
                class="segment-btn-large" 
                data-time="${section.start}" 
                data-question-idx="${section.firstQuestionIndex}"
                style="
                  background: rgba(255,255,255,0.25);
                  color: white;
                  border: none;
                  border-radius: 24px;
                  padding: 10px 20px;
                  font-size: 0.95rem;
                  font-weight: 700;
                  cursor: pointer;
                  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                  display: inline-flex;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                  letter-spacing: 0.3px;
                "
                onmouseover="
                  this.style.background='rgba(255,255,255,0.45)';
                  this.style.transform='translateY(-3px) scale(1.05)';
                  this.style.boxShadow='0 6px 20px rgba(0,0,0,0.25)';
                "
                onmouseout="
                  this.style.background='rgba(255,255,255,0.25)';
                  this.style.transform='translateY(0) scale(1)';
                  this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)';
                "
                onclick="jumpToSegment(${section.start}, ${section.firstQuestionIndex})"
              >
                <span style="font-size: 1.1rem;">${sectionIcon}</span>
                <span>${sectionLabel}</span>
              </button>
            `;
          });
          
          segmentHTML += '</div>';
          segmentBar.innerHTML = segmentHTML;
          audioPlayer.appendChild(segmentBar);
        }
      }
      
      // é¡¶éƒ¨ä¿¡æ¯
      const banner = document.createElement('div');
      banner.style.cssText = `
        background: white;
        border-radius: 16px;
        padding: 20px 24px;
        margin-bottom: 24px;
        border: 2px solid #667eea;
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.15);
      `;
      banner.innerHTML = `
        <h3 style="margin: 0 0 8px 0; font-size: 1.3rem; font-weight: 700; color: #667eea;">ğŸ“ å¼€å§‹ç­”é¢˜</h3>
        <p style="margin: 0; color: #6c757d;">å…± ${questions.length} é“é¢˜ Â· è¯·å…ˆå¬éŸ³é¢‘å†ç­”é¢˜ Â· å®Œæˆåè‡ªåŠ¨æäº¤</p>
      `;
      area.appendChild(banner);

      // æ¸²æŸ“æ¯é“é¢˜
      questions.forEach((q, idx) => {
        const card = document.createElement('div');
        card.className = 'question-card';
        card.dataset.qid = idx;
        
        let html = `
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
              ${idx + 1}
            </div>
            <div style="flex: 1;">
              <div style="font-size: 0.85rem; color: #6c757d;">
                ${q.sectionName || 'å¬åŠ›ç†è§£'} ${q.scenario ? 'Â· ' + q.scenario : ''}
              </div>
            </div>
          </div>
        `;
        
        // é¢˜ç›®
        html += `<div style="font-size: 1.05rem; font-weight: 600; color: #1d1d1f; margin-bottom: 16px; line-height: 1.6;">${q.stem || 'é¢˜ç›®'}</div>`;
        
        // é€‰é¡¹
        if (q.options) {
          q.options.forEach((opt, oidx) => {
            const optLabel = String.fromCharCode(65 + oidx);
            html += `
              <div class="option" data-value="${optLabel}" onclick="selectOption(${idx}, '${optLabel}', this)">
                <strong>${optLabel}.</strong> ${opt}
              </div>
            `;
          });
        }
        
        card.innerHTML = html;
        area.appendChild(card);
      });

      // æäº¤æŒ‰é’®
      const submitArea = document.createElement('div');
      submitArea.style.cssText = `
        margin-top: 32px;
        padding: 24px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        text-align: center;
      `;
      submitArea.innerHTML = `
        <button id="submit-btn" class="btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4); font-size: 1.1rem; padding: 16px 48px;">
          <i class="fas fa-check-circle"></i> æäº¤ç­”æ¡ˆ
        </button>
      `;
      area.appendChild(submitArea);

      document.getElementById('submit-btn').addEventListener('click', submitAnswers);
    }

    // é€‰æ‹©é€‰é¡¹
    function selectOption(qid, value, elem) {
      // å–æ¶ˆåŒé¢˜å…¶ä»–é€‰é¡¹
      const card = elem.closest('.question-card');
      card.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
      
      // é€‰ä¸­å½“å‰é€‰é¡¹
      elem.classList.add('selected');
      userAnswers[qid] = value;
    }

    // æäº¤ç­”æ¡ˆ
    function submitAnswers() {
      if (userAnswers.filter(a => a).length < currentQuestions.length) {
        if (!confirm('è¿˜æœ‰é¢˜ç›®æœªä½œç­”ï¼Œç¡®å®šæäº¤å—ï¼Ÿ')) return;
      }

      let correct = 0;
      currentQuestions.forEach((q, idx) => {
        const card = document.querySelector(`[data-qid="${idx}"]`);
        const userAns = userAnswers[idx];
        const correctAns = q.answer;
        
        if (userAns === correctAns) correct++;
        
        // æ ‡è®°æ­£ç¡®/é”™è¯¯
        card.querySelectorAll('.option').forEach(opt => {
          opt.style.pointerEvents = 'none';
          if (opt.dataset.value === correctAns) {
            opt.classList.add('correct');
          } else if (opt.dataset.value === userAns && userAns !== correctAns) {
            opt.classList.add('wrong');
          }
        });
      });

      // ä¿å­˜ç­”é¢˜è®°å½•ï¼ˆå»ºç«‹ç”¨æˆ·ç”»åƒï¼‰
      saveAnswerHistory(currentQuestions, userAnswers);

      // æ˜¾ç¤ºç»“æœ
      showResult(correct, currentQuestions.length);
    }

    // ä¿å­˜ç­”é¢˜è®°å½•ï¼ˆåŒæ­¥åˆ°å¬åŠ›æµ‹è¯•æ¿å—ï¼‰
    function saveAnswerHistory(questions, answers) {
      try {
        // ä¿å­˜å¬åŠ›ç»ƒä¹ å†å²
        let history = JSON.parse(localStorage.getItem('listening-practice-history') || '[]');
        
        // ç»Ÿè®¡é”™é¢˜
        const wrongQuestions = questions.filter((q, idx) => answers[idx] !== q.answer);
        
        const record = {
          timestamp: Date.now(),
          totalQuestions: questions.length,
          correctCount: questions.filter((q, idx) => answers[idx] === q.answer).length,
          wrongCount: wrongQuestions.length,
          questions: questions.map((q, idx) => ({
            examId: q.examId,
            questionId: q.id,
            sectionName: q.sectionName,
            stem: q.stem,
            userAnswer: answers[idx],
            correctAnswer: q.answer,
            correct: answers[idx] === q.answer,
            options: q.options,
            explain: q.explain
          })),
          wrongQuestions: wrongQuestions.map((q, idx) => ({
            examId: q.examId,
            questionId: q.id,
            sectionName: q.sectionName,
            stem: q.stem,
            userAnswer: answers[questions.indexOf(q)],
            correctAnswer: q.answer,
            options: q.options,
            explain: q.explain
          }))
        };
        
        history.push(record);
        
        // åªä¿ç•™æœ€è¿‘30æ¬¡è®°å½•
        if (history.length > 30) history = history.slice(-30);
        
        localStorage.setItem('listening-practice-history', JSON.stringify(history));
        
        // åŒæ­¥é”™é¢˜åˆ°å¬åŠ›æµ‹è¯•æ¿å—
        if (wrongQuestions.length > 0) {
          let listeningWrongQuestions = JSON.parse(localStorage.getItem('listening-wrong-questions') || '[]');
          wrongQuestions.forEach(q => {
            const idx = questions.indexOf(q);
            listeningWrongQuestions.push({
              timestamp: Date.now(),
              examId: q.examId,
              questionId: q.id,
              sectionName: q.sectionName,
              stem: q.stem,
              userAnswer: answers[idx],
              correctAnswer: q.answer,
              options: q.options,
              explain: q.explain,
              source: 'listening-practice'
            });
          });
          
          // åªä¿ç•™æœ€è¿‘100ä¸ªé”™é¢˜
          if (listeningWrongQuestions.length > 100) {
            listeningWrongQuestions = listeningWrongQuestions.slice(-100);
          }
          
          localStorage.setItem('listening-wrong-questions', JSON.stringify(listeningWrongQuestions));
          console.log(`âœ… å·²å°† ${wrongQuestions.length} ä¸ªé”™é¢˜åŒæ­¥åˆ°å¬åŠ›æµ‹è¯•æ¿å—`);
        }
        
        console.log('âœ… å¬åŠ›ç»ƒä¹ è®°å½•å·²ä¿å­˜');
      } catch (err) {
        console.error('âŒ ä¿å­˜è®°å½•å¤±è´¥:', err);
      }
    }

    // æ˜¾ç¤ºç»“æœ
    function showResult(correct, total) {
      const score = Math.round((correct / total) * 100);
      const wrongCount = total - correct;
      
      const resultArea = document.getElementById('result-area');
      resultArea.style.display = 'block';
      resultArea.innerHTML = `
        <div style="background: ${score >= 60 ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'}; border-radius: 16px; padding: 32px; margin: 24px 0; color: white; text-align: center; box-shadow: 0 8px 24px ${score >= 60 ? 'rgba(16, 185, 129, 0.4)' : 'rgba(245, 158, 11, 0.4)'};">
          <div style="font-size: 4rem; margin-bottom: 16px;">${score >= 60 ? 'ğŸ‰' : 'ğŸ’ª'}</div>
          <h2 style="margin: 0 0 12px 0; font-size: 2.5rem; font-weight: 800;">${score}åˆ†</h2>
          <p style="margin: 0; font-size: 1.2rem; opacity: 0.95;">ç­”å¯¹ ${correct} é¢˜ï¼Œé”™è¯¯ ${wrongCount} é¢˜ï¼Œå…± ${total} é¢˜</p>
          <p style="margin: 12px 0 0; font-size: 1rem;">${score >= 85 ? 'ä¼˜ç§€ï¼ç»§ç»­ä¿æŒï¼' : score >= 60 ? 'åŠæ ¼äº†ï¼Œè¿˜æœ‰æå‡ç©ºé—´ï¼' : 'éœ€è¦å¤šåŠ ç»ƒä¹ å“¦ï¼'}</p>
        </div>

        <div style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
          <h3 style="margin: 0 0 12px 0; color: #667eea; font-size: 1.2rem; font-weight: 700;">ğŸ“Š æ•°æ®åŒæ­¥</h3>
          <div style="background: #f0f9ff; border-left: 4px solid #0ea5e9; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
            <p style="margin: 0; color: #0c4a6e; line-height: 1.8;">
              âœ… ç­”é¢˜è®°å½•å·²ä¿å­˜<br>
              ${wrongCount > 0 ? `âŒ ${wrongCount} ä¸ªé”™é¢˜å·²åŒæ­¥åˆ°<a href="listening-micro.html" style="color: #0ea5e9; font-weight: 600; text-decoration: none;">å¬åŠ›æµ‹è¯•</a>æ¿å—` : 'âœ¨ å…¨éƒ¨ç­”å¯¹ï¼Œæ²¡æœ‰é”™é¢˜ï¼'}
            </p>
          </div>
        </div>

        <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); text-align: center;">
          <button class="btn" onclick="location.reload()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); margin-right: 12px;">
            <i class="fas fa-redo"></i> å†æ¥ä¸€ç»„
          </button>
          <button class="btn" onclick="location.href='listening-micro.html'" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);">
            <i class="fas fa-headphones"></i> æŸ¥çœ‹é”™é¢˜é›†
          </button>
        </div>
      `;

      // æ»šåŠ¨åˆ°ç»“æœ
      resultArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // å¼€å§‹ç»ƒä¹ 
    document.getElementById('start-btn').addEventListener('click', async () => {
      if (allQuestions.length === 0) {
        await loadQuestions();
      }

      const count = document.getElementById('count-select').value;
      const type = document.getElementById('type-select').value;
      const level = document.getElementById('level-select').value;

      console.log('=== å¼€å§‹ç­›é€‰é¢˜ç›® ===');
      console.log(`é¢˜åº“çŠ¶æ€: ${allQuestions.length} é“é¢˜å·²åŠ è½½`);
      
      if (allQuestions.length === 0) {
        alert('é¢˜ç›®æ•°æ®å°šæœªåŠ è½½å®Œæˆï¼Œè¯·ç¨åå†è¯•ï¼');
        return;
      }
      
      currentQuestions = filterQuestions(count, type, level);
      userAnswers = new Array(currentQuestions.length).fill(null);

      if (currentQuestions.length === 0) {
        alert(`æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„é¢˜ç›®ï¼\n\nå½“å‰ç­›é€‰æ¡ä»¶ï¼š\n- é¢˜ç›®æ•°é‡: ${count}\n- å¬åŠ›ç±»å‹: ${type}\n- è€ƒè¯•ç±»å‹: ${level}\n\nè¯·è°ƒæ•´ç­›é€‰æ¡ä»¶åé‡è¯•`);
        return;
      }
      
      console.log(`æˆåŠŸç­›é€‰ ${currentQuestions.length} é“é¢˜`);

      renderQuestions(currentQuestions);
      
      // æ»šåŠ¨åˆ°é¢˜ç›®åŒºåŸŸ
      document.getElementById('questions-area').scrollIntoView({ behavior: 'smooth' });
    });

    // éŸ³é¢‘æ§åˆ¶å‡½æ•°
    let loopEnabled = false;
    let loopStart = 0;
    let loopEnd = 0;

    function setPlaybackRate(rate) {
      if (currentAudio) {
        currentAudio.playbackRate = rate;
        console.log(`âœ… æ’­æ”¾é€Ÿåº¦å·²è®¾ç½®ä¸º ${rate}x`);
      }
    }

    function toggleLoop() {
      if (!currentAudio) return;
      
      loopEnabled = !loopEnabled;
      const btn = document.getElementById('loop-btn');
      
      if (loopEnabled) {
        loopStart = currentAudio.currentTime;
        loopEnd = currentAudio.currentTime + 10; // é»˜è®¤å¾ªç¯10ç§’
        btn.style.background = 'rgba(255,255,255,0.4)';
        btn.innerHTML = 'ğŸ” å¾ªç¯ä¸­';
        
        currentAudio.addEventListener('timeupdate', loopCheck);
        console.log(`âœ… ABå¾ªç¯å·²å¼€å¯: ${loopStart.toFixed(1)}s - ${loopEnd.toFixed(1)}s`);
      } else {
        btn.style.background = 'rgba(255,255,255,0.2)';
        btn.innerHTML = 'ğŸ” ABå¾ªç¯';
        currentAudio.removeEventListener('timeupdate', loopCheck);
        console.log('âœ… ABå¾ªç¯å·²å…³é—­');
      }
    }

    function loopCheck() {
      if (loopEnabled && currentAudio.currentTime >= loopEnd) {
        currentAudio.currentTime = loopStart;
      }
    }

    // å¿«é€Ÿè·³è½¬åˆ°æŒ‡å®šsection
    function jumpToSegment(timeInSeconds, questionIndex) {
      if (!currentAudio) {
        console.error('âŒ éŸ³é¢‘æœªåŠ è½½');
        return;
      }
      
      // è·³è½¬éŸ³é¢‘åˆ°æŒ‡å®šæ—¶é—´
      currentAudio.currentTime = timeInSeconds;
      currentAudio.play();
      
      // æ»šåŠ¨åˆ°éŸ³é¢‘æ’­æ”¾å™¨ï¼ˆè€Œä¸æ˜¯é¢˜ç›®ï¼‰
      const audioPlayer = currentAudio.closest('div');
      if (audioPlayer) {
        audioPlayer.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
        
        // ç»™éŸ³é¢‘æ’­æ”¾å™¨ä¸€ä¸ªé—ªçƒæç¤º
        const originalBoxShadow = audioPlayer.style.boxShadow;
        audioPlayer.style.boxShadow = '0 12px 40px rgba(102, 126, 234, 0.6)';
        audioPlayer.style.transform = 'scale(1.01)';
        
        setTimeout(() => {
          audioPlayer.style.boxShadow = originalBoxShadow || '0 8px 24px rgba(102, 126, 234, 0.3)';
          audioPlayer.style.transform = 'scale(1)';
        }, 600);
      }
      
      console.log(`âœ… å·²è·³è½¬åˆ°: ${timeInSeconds}ç§’ï¼Œå®šä½åˆ°éŸ³é¢‘æ’­æ”¾å™¨`);
    }

    // é¡µé¢åŠ è½½æ—¶é¢„åŠ è½½é¢˜ç›®
    window.addEventListener('DOMContentLoaded', loadQuestions);
  </script>
</body>
</html>
