<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sectionæ—¶é—´æˆ³æ ‡è®°åŠ©æ‰‹ - å››å…­çº§å­¦ä¹ ç«™</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    .marker-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
    .audio-panel { background: #f9f9f9; padding: 20px; border-radius: 12px; }
    .sections-panel { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #e0e0e0; }
    .section-item { padding: 16px; margin: 10px 0; background: #fafafa; border-radius: 8px; border-left: 4px solid #ddd; cursor: pointer; }
    .section-item:hover { background: #f0f0f0; }
    .section-item.active { border-left-color: #007AFF; background: #e3f2fd; }
    .section-item.marked { border-left-color: #4CAF50; background: #e8f5e9; }
    .time-display { font-size: 2rem; font-weight: bold; color: #007AFF; margin: 10px 0; }
    .control-buttons { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
    .marker-info { background: #fff3cd; padding: 12px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #ffc107; }
    audio { width: 100%; margin: 10px 0; }
    .timestamp-badge { display: inline-block; padding: 4px 10px; background: #4CAF50; color: white; border-radius: 4px; font-size: 0.9rem; margin-top: 6px; }
    .export-section { margin-top: 20px; padding: 20px; background: #e8f5e9; border-radius: 12px; }
    textarea { width: 100%; min-height: 200px; font-family: monospace; font-size: 0.9rem; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    .instruction { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .shortcut-hint { background: #fff; padding: 10px; border-radius: 6px; margin: 10px 0; font-size: 0.9rem; }
    .section-desc { font-size: 0.9rem; color: #666; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="page-content">
    <div class="exam-header">
      <h1><i class="fas fa-scissors"></i> Section æ—¶é—´æˆ³æ ‡è®°åŠ©æ‰‹</h1>
      <p class="hint">ä¸ºæ¯ä¸ªSectionæ ‡è®°éŸ³é¢‘èµ·æ­¢æ—¶é—´ï¼Œè¯¥Sectionä¸‹çš„æ‰€æœ‰é¢˜ç›®è‡ªåŠ¨å…±äº«æ­¤ç‰‡æ®µ</p>
    </div>

    <div class="instruction">
      <h3><i class="fas fa-info-circle"></i> ä½¿ç”¨è¯´æ˜ - æ›´ç®€å•çš„æ ‡è®°æ–¹å¼</h3>
      <ol style="margin: 10px 0; padding-left: 20px;">
        <li>è¾“å…¥è¯•å·IDå¹¶åŠ è½½ï¼ˆå¦‚ cet6-2020-07-set1ï¼‰</li>
        <li>ä¸Šä¼ æˆ–è¾“å…¥éŸ³é¢‘åœ°å€ï¼Œæ’­æ”¾éŸ³é¢‘</li>
        <li>ç‚¹å‡»ç¬¬ä¸€ä¸ªSectionï¼ˆå¦‚Section A - Long Conversationsï¼‰</li>
        <li>æ’­æ”¾åˆ°<strong>Sectionå¼€å§‹ä½ç½®</strong>æ—¶ç‚¹å‡»"æ ‡è®°èµ·ç‚¹"</li>
        <li>æ’­æ”¾åˆ°<strong>Sectionç»“æŸä½ç½®</strong>æ—¶ç‚¹å‡»"æ ‡è®°ç»ˆç‚¹"</li>
        <li>è‡ªåŠ¨è·³åˆ°ä¸‹ä¸€ä¸ªSectionï¼Œé‡å¤æ­¥éª¤4-5</li>
        <li>å®Œæˆåç‚¹å‡»"å¯¼å‡ºæ—¶é—´æˆ³æ•°æ®"ï¼Œåº”ç”¨åˆ° listening.json</li>
      </ol>
      <div class="shortcut-hint">
        <strong>ğŸ’¡ æ ¸å¿ƒä¼˜åŠ¿ï¼š</strong>ä¸€ä¸ªSectionåªéœ€æ ‡è®°ä¸€æ¬¡ï¼ˆçº¦2åˆ†é’Ÿï¼‰ï¼Œè¯¥Sectionä¸‹çš„æ‰€æœ‰é¢˜ç›®ï¼ˆé€šå¸¸8-10é¢˜ï¼‰è‡ªåŠ¨å…±äº«è¿™ä¸ªéŸ³é¢‘ç‰‡æ®µï¼<br>
        <strong>å¿«æ·é”®ï¼š</strong>ç©ºæ ¼=æš‚åœ/æ’­æ”¾ | S=æ ‡è®°èµ·ç‚¹ | E=æ ‡è®°ç»ˆç‚¹ | â†/â†’=åé€€/å‰è¿›5ç§’
      </div>
    </div>

    <div style="margin: 20px 0;">
      <label><strong>è¯•å·IDï¼š</strong>
        <input type="text" id="exam-id" placeholder="å¦‚: cet6-2020-07-set1" style="width: 300px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" />
      </label>
      <button class="action-btn" id="load-btn" style="margin-left: 10px;"><i class="fas fa-download"></i> åŠ è½½Sections</button>
    </div>

    <div class="marker-container">
      <div class="audio-panel">
        <h3><i class="fas fa-music"></i> éŸ³é¢‘æ’­æ”¾å™¨</h3>
        <label><strong>éŸ³é¢‘åœ°å€ï¼š</strong>
          <input type="text" id="audio-url" placeholder="è¾“å…¥éŸ³é¢‘URLæˆ–é€‰æ‹©æ–‡ä»¶" style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px;" />
        </label>
        <div style="margin: 10px 0;">
          <input type="file" id="audio-file" accept="audio/*" style="display: none;" />
          <button class="btn" onclick="document.getElementById('audio-file').click()"><i class="fas fa-folder-open"></i> é€‰æ‹©æœ¬åœ°æ–‡ä»¶</button>
          <button class="btn btn-secondary" id="load-audio-btn" style="margin-left: 8px;"><i class="fas fa-play-circle"></i> åŠ è½½éŸ³é¢‘</button>
        </div>
        <audio id="audio-player" controls></audio>
        <div class="time-display" id="current-time">0:00 / 0:00</div>
        <div class="marker-info" id="marker-info">
          <strong>å½“å‰Sectionï¼š</strong><span id="current-section">æœªé€‰æ‹©</span><br>
          <strong>èµ·ç‚¹ï¼š</strong><span id="start-time-display">æœªæ ‡è®°</span><br>
          <strong>ç»ˆç‚¹ï¼š</strong><span id="end-time-display">æœªæ ‡è®°</span><br>
          <strong>æ—¶é•¿ï¼š</strong><span id="duration-display">-</span>
        </div>
        <div class="control-buttons">
          <button class="action-btn" id="mark-start-btn"><i class="fas fa-flag"></i> æ ‡è®°èµ·ç‚¹ (S)</button>
          <button class="action-btn" id="mark-end-btn"><i class="fas fa-flag-checkered"></i> æ ‡è®°ç»ˆç‚¹ (E)</button>
          <button class="btn" id="preview-btn"><i class="fas fa-play"></i> é¢„è§ˆç‰‡æ®µ</button>
          <button class="btn btn-secondary" id="clear-btn"><i class="fas fa-eraser"></i> æ¸…é™¤æ ‡è®°</button>
        </div>
        <div class="control-buttons">
          <button class="btn" id="back-5s"><i class="fas fa-backward"></i> -5s (â†)</button>
          <button class="btn" id="back-1s"><i class="fas fa-step-backward"></i> -1s</button>
          <button class="btn" id="forward-1s"><i class="fas fa-step-forward"></i> +1s</button>
          <button class="btn" id="forward-5s"><i class="fas fa-forward"></i> +5s (â†’)</button>
        </div>
        <div style="margin-top: 10px;">
          <label><strong>å€é€Ÿï¼š</strong>
            <select id="playback-rate" style="padding: 6px;">
              <option value="0.5">0.5x</option>
              <option value="0.75">0.75x</option>
              <option value="1" selected>1x</option>
              <option value="1.25">1.25x</option>
              <option value="1.5">1.5x</option>
              <option value="2">2x</option>
            </select>
          </label>
        </div>
      </div>

      <div class="sections-panel">
        <h3><i class="fas fa-list"></i> Sectionsåˆ—è¡¨ <span id="section-count" class="badge">0ä¸ª</span></h3>
        <div id="sections-list" style="max-height: 600px; overflow-y: auto;">
          <p class="hint">è¯·å…ˆåŠ è½½è¯•å·æ•°æ®</p>
        </div>
      </div>
    </div>

    <div class="export-section">
      <h3><i class="fas fa-download"></i> å¯¼å‡ºæ—¶é—´æˆ³æ•°æ®</h3>
      <button class="action-btn download-btn" id="export-btn"><i class="fas fa-file-export"></i> ç”ŸæˆJSONæ•°æ®</button>
      <button class="btn" id="copy-btn" style="margin-left: 10px;"><i class="fas fa-copy"></i> å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
      <button class="btn btn-secondary" id="apply-btn" style="margin-left: 10px;"><i class="fas fa-save"></i> ç›´æ¥åº”ç”¨åˆ°listening.json</button>
      <p class="hint" style="margin-top: 8px;">å·²æ ‡è®° <strong id="marked-count">0</strong> / <strong id="total-count">0</strong> ä¸ªSection</p>
      <textarea id="output-json" placeholder="æ—¶é—´æˆ³æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..." readonly></textarea>
    </div>
  </div>

  <script>
    const audio = document.getElementById('audio-player');
    const timeDisplay = document.getElementById('current-time');
    const sectionsList = document.getElementById('sections-list');
    const outputJson = document.getElementById('output-json');
    
    let sections = [];
    let currentSectionIndex = null;
    let timestamps = new Map(); // sectionName -> {start, end}
    let examId = '';

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    // æ›´æ–°æ—¶é—´æ˜¾ç¤º
    audio.addEventListener('timeupdate', () => {
      timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(audio.duration || 0)}`;
    });

    // å€é€Ÿæ§åˆ¶
    document.getElementById('playback-rate').addEventListener('change', (e) => {
      audio.playbackRate = parseFloat(e.target.value);
    });

    // æ—¶é—´è·³è½¬
    document.getElementById('back-5s').addEventListener('click', () => { audio.currentTime = Math.max(0, audio.currentTime - 5); });
    document.getElementById('back-1s').addEventListener('click', () => { audio.currentTime = Math.max(0, audio.currentTime - 1); });
    document.getElementById('forward-1s').addEventListener('click', () => { audio.currentTime = Math.min(audio.duration, audio.currentTime + 1); });
    document.getElementById('forward-5s').addEventListener('click', () => { audio.currentTime = Math.min(audio.duration, audio.currentTime + 5); });

    // åŠ è½½éŸ³é¢‘
    document.getElementById('load-audio-btn').addEventListener('click', () => {
      const url = document.getElementById('audio-url').value.trim();
      if (!url) return alert('è¯·è¾“å…¥éŸ³é¢‘åœ°å€');
      audio.src = url;
      audio.load();
    });

    document.getElementById('audio-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        document.getElementById('audio-url').value = file.name;
        audio.src = url;
        audio.load();
      }
    });

    // åŠ è½½Sections
    document.getElementById('load-btn').addEventListener('click', async () => {
      examId = document.getElementById('exam-id').value.trim();
      if (!examId) return alert('è¯·è¾“å…¥è¯•å·ID');
      
      try {
        const resp = await fetch('./listening.json', { cache: 'no-store' });
        const data = await resp.json();
        const exam = data[examId];
        if (!exam) return alert('æ‰¾ä¸åˆ°è¯¥è¯•å·: ' + examId);
        
        sections = exam.sections || [];
        renderSections();
        
        // è‡ªåŠ¨å¡«å……éŸ³é¢‘åœ°å€ï¼ˆä»ç¬¬ä¸€ä¸ªsectionè·å–ï¼‰
        if (sections[0]?.audio) {
          document.getElementById('audio-url').value = sections[0].audio;
        }
      } catch (e) {
        alert('åŠ è½½å¤±è´¥: ' + e.message);
      }
    });

    // æ¸²æŸ“Sectionsåˆ—è¡¨
    function renderSections() {
      sectionsList.innerHTML = '';
      document.getElementById('section-count').textContent = `${sections.length}ä¸ª`;
      document.getElementById('total-count').textContent = sections.length;
      
      sections.forEach((sec, idx) => {
        const div = document.createElement('div');
        div.className = 'section-item';
        const ts = timestamps.get(sec.name);
        div.innerHTML = `
          <strong>${sec.name}</strong>
          <div class="section-desc">${sec.description || ''} | ${sec.questions?.length || 0}é¢˜</div>
          ${ts ? `<div class="timestamp-badge">${formatTime(ts.start)} - ${formatTime(ts.end)} (${Math.round((ts.end - ts.start) / 60)}åˆ†é’Ÿ)</div>` : ''}
        `;
        div.addEventListener('click', () => selectSection(idx));
        sectionsList.appendChild(div);
      });
      
      updateMarkCount();
    }

    // é€‰æ‹©Section
    function selectSection(idx) {
      currentSectionIndex = idx;
      document.querySelectorAll('.section-item').forEach((el, i) => {
        el.classList.toggle('active', i === idx);
        el.classList.toggle('marked', timestamps.has(sections[i].name));
      });
      
      const sec = sections[idx];
      document.getElementById('current-section').textContent = sec.name;
      
      const ts = timestamps.get(sec.name);
      document.getElementById('start-time-display').textContent = ts ? formatTime(ts.start) : 'æœªæ ‡è®°';
      document.getElementById('end-time-display').textContent = ts ? formatTime(ts.end) : 'æœªæ ‡è®°';
      document.getElementById('duration-display').textContent = ts ? `${Math.round((ts.end - ts.start) / 60)}åˆ†é’Ÿ` : '-';
    }

    // æ ‡è®°èµ·ç‚¹
    document.getElementById('mark-start-btn').addEventListener('click', markStart);
    function markStart() {
      if (currentSectionIndex === null) return alert('è¯·å…ˆé€‰æ‹©Section');
      const sec = sections[currentSectionIndex];
      const start = Math.round(audio.currentTime * 10) / 10;
      
      let ts = timestamps.get(sec.name) || {};
      ts.start = start;
      timestamps.set(sec.name, ts);
      
      document.getElementById('start-time-display').textContent = formatTime(start);
      if (ts.end) {
        document.getElementById('duration-display').textContent = `${Math.round((ts.end - start) / 60)}åˆ†é’Ÿ`;
      }
      renderSections();
    }

    // æ ‡è®°ç»ˆç‚¹
    document.getElementById('mark-end-btn').addEventListener('click', markEnd);
    function markEnd() {
      if (currentSectionIndex === null) return alert('è¯·å…ˆé€‰æ‹©Section');
      const sec = sections[currentSectionIndex];
      const end = Math.round(audio.currentTime * 10) / 10;
      
      let ts = timestamps.get(sec.name) || {};
      ts.end = end;
      timestamps.set(sec.name, ts);
      
      document.getElementById('end-time-display').textContent = formatTime(end);
      if (ts.start) {
        document.getElementById('duration-display').textContent = `${Math.round((end - ts.start) / 60)}åˆ†é’Ÿ`;
      }
      renderSections();
      
      // è‡ªåŠ¨è·³åˆ°ä¸‹ä¸€ä¸ªSection
      if (currentSectionIndex < sections.length - 1) {
        selectSection(currentSectionIndex + 1);
      }
    }

    // é¢„è§ˆç‰‡æ®µ
    document.getElementById('preview-btn').addEventListener('click', () => {
      if (currentSectionIndex === null) return alert('è¯·å…ˆé€‰æ‹©Section');
      const sec = sections[currentSectionIndex];
      const ts = timestamps.get(sec.name);
      if (!ts || ts.start === undefined) return alert('è¯·å…ˆæ ‡è®°èµ·ç‚¹');
      
      audio.currentTime = ts.start;
      audio.play();
      
      if (ts.end !== undefined) {
        const checkEnd = setInterval(() => {
          if (audio.currentTime >= ts.end) {
            audio.pause();
            clearInterval(checkEnd);
          }
        }, 100);
      }
    });

    // æ¸…é™¤å½“å‰æ ‡è®°
    document.getElementById('clear-btn').addEventListener('click', () => {
      if (currentSectionIndex === null) return;
      const sec = sections[currentSectionIndex];
      timestamps.delete(sec.name);
      document.getElementById('start-time-display').textContent = 'æœªæ ‡è®°';
      document.getElementById('end-time-display').textContent = 'æœªæ ‡è®°';
      document.getElementById('duration-display').textContent = '-';
      renderSections();
    });

    // å¯¼å‡ºJSON
    document.getElementById('export-btn').addEventListener('click', () => {
      const result = sections.map(sec => {
        const ts = timestamps.get(sec.name);
        return {
          name: sec.name,
          audioStart: ts?.start,
          audioEnd: ts?.end
        };
      });
      
      outputJson.value = JSON.stringify({ examId, sections: result }, null, 2);
    });

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    document.getElementById('copy-btn').addEventListener('click', () => {
      if (!outputJson.value) {
        alert('è¯·å…ˆç‚¹å‡»"ç”ŸæˆJSONæ•°æ®"');
        return;
      }
      outputJson.select();
      document.execCommand('copy');
      alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
    });

    // ç›´æ¥åº”ç”¨åˆ°listening.jsonï¼ˆéœ€è¦åç«¯æ”¯æŒï¼‰
    document.getElementById('apply-btn').addEventListener('click', async () => {
      if (!outputJson.value) {
        alert('è¯·å…ˆç‚¹å‡»"ç”ŸæˆJSONæ•°æ®"');
        return;
      }
      
      alert('æ­¤åŠŸèƒ½éœ€è¦æ‰‹åŠ¨æ“ä½œï¼š\n\n1. ç‚¹å‡»"å¤åˆ¶åˆ°å‰ªè´´æ¿"\n2. æ‰“å¼€ listening.json\n3. æ‰¾åˆ°å¯¹åº”è¯•å·å’ŒSection\n4. æ·»åŠ  audioStart å’Œ audioEnd å­—æ®µ');
    });

    // æ›´æ–°æ ‡è®°è®¡æ•°
    function updateMarkCount() {
      const marked = Array.from(timestamps.values()).filter(ts => ts.start !== undefined && ts.end !== undefined).length;
      document.getElementById('marked-count').textContent = marked;
    }

    // å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      
      switch(e.key.toLowerCase()) {
        case ' ':
          e.preventDefault();
          audio.paused ? audio.play() : audio.pause();
          break;
        case 's':
          e.preventDefault();
          markStart();
          break;
        case 'e':
          e.preventDefault();
          markEnd();
          break;
        case 'arrowleft':
          e.preventDefault();
          audio.currentTime = Math.max(0, audio.currentTime - 5);
          break;
        case 'arrowright':
          e.preventDefault();
          audio.currentTime = Math.min(audio.duration, audio.currentTime + 5);
          break;
      }
    });
  </script>
</body>
</html>
